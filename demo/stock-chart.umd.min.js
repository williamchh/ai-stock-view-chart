!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).StockChart=i()}(this,function(){"use strict";const t={name:"light",background:"#FFFFFF",chartAreaBackground:"#F8F8F8",gridColor:"#E0E0E0",textColor:"#333333",candleUp:"#4CAF50",candleDown:"#F44336",candleBorderColor:"#333333",lineColor:"#2196F3",crosshairColor:"#9E9E9E",overlayTextColor:"#333333",positiveColor:"rgba(76, 175, 80, 0.8)",negativeColor:"rgba(244, 67, 54, 0.8)"},i={name:"dark",background:"#1A1A1A",chartAreaBackground:"#2C2C2C",gridColor:"#444444",textColor:"#E0E0E0",candleUp:"#66BB6A",candleDown:"#EF5350",candleBorderColor:"#E0E0E0",lineColor:"#64B5F6",crosshairColor:"#BDBDBD",overlayTextColor:"#E0E0E0",positiveColor:"rgba(102, 187, 106, 0.8)",negativeColor:"rgba(239, 83, 80, 0.8)"};class s{plotTotalHeight;plotTotalWidth;yAxisWidth=80;bottomMargin=40;leftMargin=0;topMargin=0;constructor(t,i,s){this.canvasWidth=t,this.canvasHeight=i,this.plotConfigs=s,this.plots={},this.calculateLayout()}calculateLayout(){let t=0;const i=this.plotConfigs.filter(t=>!t.overlay).reduce((t,i)=>t+i.heightRatio,0);this.plotConfigs.forEach(s=>{if(s.overlay){const t=this.plots.main;t&&(this.plots[s.id]={...t})}else{const h=this.canvasWidth-this.leftMargin-this.yAxisWidth,e=this.canvasHeight-this.topMargin-this.bottomMargin,n=s.heightRatio/i*e;this.plots[s.id]={x:this.leftMargin,y:t+this.topMargin,width:h,height:n},t+=n}}),this.plotTotalHeight=t,this.plotTotalWidth=this.canvasWidth-this.yAxisWidth}getPlotLayout(t){return this.plots[t]||null}updateCanvasDimensions(t,i,s=void 0){this.canvasWidth=t,this.canvasHeight=i,void 0!==s&&(this.yAxisWidth=s),this.calculateLayout()}getPlotTotalWidth(){return this.plotTotalWidth}getPlotTotalHeight(){return this.plotTotalHeight}}class h{constructor(t,i,s=0){this.allData=t,this.visibleCount=Math.min(i,t.length+s),this.rightPadding=s,this.maxStartIndex=Math.max(0,t.length-this.visibleCount+s),this.startIndex=Math.max(0,t.length-(this.visibleCount-s))}MIN_PORT_VISIBLE_COUNT=10;getVisibleData(){const t=Math.min(this.startIndex+this.visibleCount,this.allData.length);return this.allData.slice(this.startIndex,t)}scroll(t){this.maxStartIndex=this.allData.length-this.visibleCount+this.rightPadding;const i=this.startIndex+t,s=Math.min(Math.round(.1*this.visibleCount),Math.round(.1*this.allData.length)),h=this.maxStartIndex+s;this.startIndex=Math.max(0,Math.min(h,i))}zoom(t,i){if(t<1&&this.startIndex<=0&&(window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount),zoomFactor:t,anchorIndex:i}})),0===this.startIndex))return;const s=this.startIndex+i;let h=t;Math.round(this.visibleCount/t)>200&&t<.99&&(h*=.99);const e=Math.max(this.MIN_PORT_VISIBLE_COUNT,Math.min(this.allData.length,Math.round(this.visibleCount/h))),n=i/this.visibleCount,o=s-Math.round(e*n);this.visibleCount=e,this.maxStartIndex=Math.max(0,this.allData.length-this.visibleCount);const r=Math.round(.05*this.visibleCount),a=Math.max(-r,0),c=this.maxStartIndex+r;this.startIndex=Math.max(a,Math.min(c,o)),this.startIndex<=a&&t<1&&window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount)}}))}updateData(t){this.allData=t,this.startIndex=Math.max(0,this.allData.length-this.visibleCount)}}function e(t,i,s,h,e){return(t-i)*e}function n(t,i,s,h,e){const n=s-i;return 0===n?e+h/2:e+h-(t-i)/n*h}class o{constructor(t){this.type=t,this.points=[],this.style={strokeStyle:"#000000",lineWidth:1,fillStyle:"rgba(0, 0, 0, 0.1)"}}addPoint(t,i){this.points.push({time:t,price:i})}getPixelCoordinates(t,i,s,h,e,n){if(!h?.allData||!h.getVisibleData)return null;const o=h.allData,r=h.getVisibleData(),a=o.findIndex(i=>i.time>=t);if(-1===(-1===a?o.length-1:0===a?0:Math.abs(o[a].time-t)<Math.abs(o[a-1].time-t)?a:a-1))return null;const c=s.width/h.visibleCount,l=r.findIndex(i=>i.time>=t),u=-1===l?r.length-1:0===l?0:Math.abs(r[l].time-t)<Math.abs(r[l-1].time-t)?l:l-1;return{x:s.x+u*c,y:s.y+(n-i)/(n-e)*s.height}}draw(t,i,s,h,e){}toJSON(){return{type:this.type,points:this.points,style:this.style}}fromJSON(t){this.points=t.points,this.style=t.style}}class r extends o{constructor(t="line"){super(t),this.constraint="horizontal-line"===t?"horizontal":"vertical-line"===t?"vertical":"line"}draw(t,i,s,h,e){if(this.points.length<2)return;const n=this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,h,e);let o=this.points[1].time,r=this.points[1].price;"horizontal"===this.constraint?r=this.points[0].price:"vertical"===this.constraint&&(o=this.points[0].time);const a=this.getPixelCoordinates(o,r,i,s,h,e);n&&a&&(t.beginPath(),t.strokeStyle=this.style.strokeStyle,t.lineWidth=this.style.lineWidth,t.moveTo(n.x,n.y),t.lineTo(a.x,a.y),t.stroke())}}class a extends o{constructor(){super("rectangle")}draw(t,i,s,h,e){if(this.points.length<2)return;const n=this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,h,e),o=this.getPixelCoordinates(this.points[1].time,this.points[1].price,i,s,h,e);n&&o&&(t.beginPath(),t.fillStyle=this.style.fillStyle,t.strokeStyle=this.style.strokeStyle,t.lineWidth=this.style.lineWidth,t.rect(Math.min(n.x,o.x),Math.min(n.y,o.y),Math.abs(o.x-n.x),Math.abs(o.y-n.y)),t.fill(),t.stroke())}}class c extends o{constructor(t){super("fibonacci"),this.levels=[0,.236,.382,.618,1,1.618,2,2.618,3.618,4.236],this.style.strokeStyle="dark"===t?"#FFFFFF":"#000000"}draw(t,i,s,h,e){if(this.points.length<2)return;const n=this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,h,e),o=this.getPixelCoordinates(this.points[1].time,this.points[1].price,i,s,h,e);if(!n||!o)return;const r=Math.abs(this.points[1].price-this.points[0].price),a=this.points[1].price>this.points[0].price,c=this.points[0].price;t.lineWidth=this.style.lineWidth,t.strokeStyle=this.style.strokeStyle,t.fillStyle=this.style.strokeStyle,t.setLineDash([5,5]),t.textAlign="left",t.font="12px Arial",this.levels.forEach(l=>{const u=a?c+r*l:c-r*l,f=this.getPixelCoordinates(this.points[1].time,u,i,s,h,e);if(!f)return;t.beginPath(),t.moveTo(n.x,f.y),t.lineTo(o.x,f.y),t.stroke();const d=(100*l).toFixed(1)+"%";t.fillText(d,o.x+5,f.y)}),t.setLineDash([])}}class l extends o{constructor(t,i){super("fibonacci-zoon"),this.theme=t,this.halfBarWidth=i/2}fibSequence(t=8){if(t<=0)return[];if(1===t)return[1];const i=[1,2,3];for(;i.length<t;){const t=i.length;i.push(i[t-1]+i[t-2])}return i}draw(t,i,s,h,e){if(this.points.length<2)return;const n=this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,h,e),o=this.getPixelCoordinates(this.points[1].time,this.points[1].price,i,s,h,e);if(!n||!o)return;const r=Math.abs(this.points[1].time-this.points[0].time),a=this.points[1].time>this.points[0].time?1:-1,c=this.points[0].time,l=s.getVisibleData();if(l.length<2)return;const u=l[1].time-l[0].time,f=r<2*u?u:r,d=this.fibSequence(8),M=d.map(t=>c+a*t*f),m="dark"===this.theme?"#FFFFFF":"#000000";if(this.style.strokeStyle=m,this.style.fillStyle=m,t.lineWidth=this.style.lineWidth,t.strokeStyle=m,t.fillStyle=m,t.setLineDash([5,5]),t.textAlign="center",t.font="12px Arial",!(r>=u))return t.beginPath(),t.moveTo(n.x+this.halfBarWidth,i.y),t.lineTo(n.x+this.halfBarWidth,i.y+i.height),t.moveTo(o.x+this.halfBarWidth,i.y),t.lineTo(o.x+this.halfBarWidth,i.y+i.height),t.strokeStyle=this.style.strokeStyle,void t.stroke();t.beginPath(),t.moveTo(n.x+this.halfBarWidth,i.y),t.lineTo(n.x+this.halfBarWidth,i.y+i.height),t.moveTo(o.x+this.halfBarWidth,i.y),t.lineTo(o.x+this.halfBarWidth,i.y+i.height),t.strokeStyle=this.style.strokeStyle,t.stroke(),M.forEach((n,o)=>{const a=s.allData[s.allData.length-1]?.time;if(a&&n>a)return;const c=this.getPixelCoordinates(n,this.points[0].price,i,s,h,e);if(!c)return;t.beginPath(),t.moveTo(c.x+this.halfBarWidth,i.y),t.lineTo(c.x+this.halfBarWidth,i.y+i.height),t.stroke();const l=d[o].toString();t.fillText(l,c.x+this.halfBarWidth,i.height-15);const f=t.measureText(l).width+5,M=Math.round(d[o]*(r/u));if(M>0){const s=`(${M})`;t.fillText(s,c.x+this.halfBarWidth+f,i.height-15)}}),t.setLineDash([])}}class u{constructor(t){this.stockChart=t,this.drawings=[],this.activeTool=null,this.currentDrawing=null,this.isDrawing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.isEditing=!1,this.t=!1,this.handleMouseDownBound=this.handleMouseDown.bind(this),this.handleMouseMoveBound=this.continueDrawing.bind(this),this.handleMouseUpBound=this.completeDrawing.bind(this),this.handleTouchStartBound=this.handleTouchStart.bind(this),this.handleTouchMoveBound=this.handleTouchMove.bind(this),this.handleTouchEndBound=this.handleTouchEnd.bind(this),this.stockChart.canvas.addEventListener("mousedown",this.handleMouseDownBound),this.stockChart.canvas.addEventListener("mousemove",this.handleMouseMoveBound),this.stockChart.canvas.addEventListener("mouseup",this.handleMouseUpBound),this.stockChart.canvas.addEventListener("touchstart",this.handleTouchStartBound),this.stockChart.canvas.addEventListener("touchmove",this.handleTouchMoveBound),this.stockChart.canvas.addEventListener("touchend",this.handleTouchEndBound),this.defaultStyles={line:{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},"horizontal-line":{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},"vertical-line":{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},rectangle:{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},fibonacci:{strokeStyle:"dark"===t.options.theme?"#ffffffc5":"#000000a9",lineWidth:1,fillStyle:"rgba(76, 175, 80, 0.1)"},"fibonacci-zoon":{strokeStyle:"dark"===t.options.theme?"#ffffffc5":"#000000a9",lineWidth:1,fillStyle:"rgba(76, 175, 80, 0.1)"}}}get isChartFrozen(){return this.t}setActiveTool(t){this.activeTool===t?this.activeTool=null:this.activeTool=t,this.currentDrawing=null,this.isDrawing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.isEditing=!1}startDrawing(t,i,s){if(this.activeTool&&this.activeTool!==t)return;this.isDrawing=!0,this.t=!0;const h=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!h)return;const e=i-h.x,n=h.width/this.stockChart.dataViewport.visibleCount,o=Math.floor(e/n),u=this.stockChart.dataViewport.startIndex+o;if(!this.stockChart.dataViewport?.allData)return;const f=this.stockChart.dataViewport.allData;if(!Array.isArray(f)||u<0||u>=f.length)return;const d=f[u];if(!d||"number"!=typeof d.time)return;const M=d.time;if(!this.stockChart.options?.plots)return;const m=this.stockChart.options.plots.find(t=>"main"===t.id);if(!m)return;const p=this.stockChart.calculatePriceRange(m,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!p)return;const{minPrice:w,maxPrice:g}=p,v=g-(s-h.y)/h.height*(g-w);switch(t){case"line":this.currentDrawing=new r;break;case"rectangle":this.currentDrawing=new a;break;case"fibonacci":this.currentDrawing=new c(this.stockChart.options.theme);break;case"fibonacci-zoon":const t=h.width/this.stockChart.dataViewport.visibleCount;this.currentDrawing=new l(this.stockChart.options.theme,t);break;case"horizontal-line":this.currentDrawing=new r("horizontal-line");break;case"vertical-line":this.currentDrawing=new r("vertical-line");break;default:return}this.defaultStyles[t]&&Object.assign(this.currentDrawing.style,this.defaultStyles[t]),this.currentDrawing.addPoint(M,v)}continueDrawing(t){const i=this.stockChart.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top,e=this.stockChart.plotLayoutManager.getPlotLayout("main");if(e&&s>=e.x&&s<=e.x+e.width&&h>=e.y&&h<=e.y+e.height){const t=s-e.x,i=e.width/this.stockChart.dataViewport.visibleCount,n=Math.floor(t/i),o=this.stockChart.dataViewport.startIndex+n;if(!this.stockChart.dataViewport?.allData||o<0||o>=this.stockChart.dataViewport.allData.length)return;const r=this.stockChart.dataViewport.allData[o];if(!r||"number"!=typeof r.time)return;const a=r.time,c=this.stockChart.options.plots.find(t=>"main"===t.id);if(!c)return;const l=this.stockChart.calculatePriceRange(c,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!l)return;const u=h-e.y,{minPrice:f,maxPrice:d}=l,M=d-u/e.height*(d-f);let m=!1;if(this.isEditing&&this.selectedDrawing&&null!==this.selectedPoint){const t={...this.selectedDrawing.points[this.selectedPoint]},i={time:a,price:M};t.time===i.time&&t.price===i.price||(this.selectedDrawing.points[this.selectedPoint]=i,m=!0)}else if(this.isDrawing&&this.currentDrawing)if(1===this.currentDrawing.points.length){const t={time:a,price:M};if(["horizontal-line","vertical-line"].includes(this.activeTool)){const i=this.currentDrawing.points[0];"horizontal-line"===this.activeTool?t.price=i.price:"vertical-line"===this.activeTool&&(t.time=i.time)}this.currentDrawing.addPoint(t.time,t.price),m=!0}else if(2===this.currentDrawing.points.length){const t={...this.currentDrawing.points[1]},i=this.currentDrawing.points[0];let s={time:a,price:M};["horizontal-line","vertical-line"].includes(this.activeTool)&&("horizontal-line"===this.activeTool?s.price=i.price:"vertical-line"===this.activeTool&&(s.time=i.time)),t.time===s.time&&t.price===s.price||(this.currentDrawing.points[1]=s,m=!0)}m&&this.stockChart.render()}}completeDrawing(){this.isEditing?this.selectedPoint=null:this.isDrawing&&this.currentDrawing&&this.currentDrawing.points.length>=2&&(this.drawings.push(this.currentDrawing),this.isDrawing=!1,this.selectedDrawing=null,this.currentDrawing=null,this.isEditing=!1,this.t=!1,this.setActiveTool(null),this.stockChart&&"function"==typeof this.stockChart.setDrawingTool&&this.stockChart.setDrawingTool(null))}handleMouseDown(t){const i=this.stockChart.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;if(this.activeTool)this.startDrawing(this.activeTool,s,h);else{if(this.trySelectPoint(s,h))return this.isEditing=!0,void(this.t=!0);this.selectedDrawing&&this.isNearDrawing(s,h,this.selectedDrawing)||(this.isEditing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.t=!1)}}handleTouchStart(t){if(t.preventDefault(),t.stopPropagation(),1!==t.touches.length)return;const i=t.touches[0],s=this.stockChart.canvas.getBoundingClientRect(),h=i.clientX-s.left,e=i.clientY-s.top;if(this.activeTool)this.startDrawing(this.activeTool,h,e);else{if(this.trySelectPoint(h,e))return this.isEditing=!0,void(this.t=!0);this.selectedDrawing&&this.isNearDrawing(h,e,this.selectedDrawing)||(this.isEditing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.t=!1)}}handleTouchMove(t){if(t.preventDefault(),t.stopPropagation(),1!==t.touches.length)return;const i=t.touches[0];(this.isDrawing&&this.currentDrawing||this.isEditing&&this.selectedDrawing)&&this.continueDrawing({clientX:i.clientX,clientY:i.clientY})}handleTouchEnd(t){t.preventDefault(),t.stopPropagation(),this.completeDrawing()}clearDrawings(){this.drawings=[],this.currentDrawing=null,this.isDrawing=!1,this.selectedDrawing=null}render(t){this.stockChart.plotLayoutManager&&this.stockChart.plotLayoutManager.getPlotLayout("main")&&(t.save(),t.lineJoin="round",t.lineCap="round",this.drawings.forEach(i=>{this.renderDrawing(t,i)}),this.currentDrawing&&this.isDrawing&&this.renderDrawing(t,this.currentDrawing),this.selectedDrawing&&this.renderControlPoints(t,this.selectedDrawing),t.restore())}renderControlPoints(t,i){const s=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!s)return;const h=this.stockChart.options.plots.find(t=>"main"===t.id);if(!h)return;const e=this.stockChart.calculatePriceRange(h,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);e&&i.points.forEach((h,n)=>{const r=(new o).getPixelCoordinates(h.time,h.price,s,this.stockChart.dataViewport,e.minPrice,e.maxPrice);if(r){if("fibonacci-zoon"===i.type){const t=s.width/this.stockChart.dataViewport.visibleCount;r.x+=t/2}t.beginPath(),t.arc(r.x,r.y,4,0,2*Math.PI),t.fillStyle=n===this.selectedPoint?"#ff0000":"#ffffff",t.strokeStyle="#000000",t.lineWidth=1,t.fill(),t.stroke()}})}renderDrawing(t,i){const{type:s,points:h,style:e}=i;switch(t.save(),s){case"line":case"horizontal-line":case"vertical-line":this.renderLine(t,h,e);break;case"rectangle":this.renderRectangle(t,h,e);break;case"fibonacci":case"fibonacci-zoon":i.draw(t,this.stockChart.plotLayoutManager.getPlotLayout("main"),this.stockChart.dataViewport,this.stockChart.calculatePriceRange(this.stockChart.options.plots.find(t=>"main"===t.id),this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport).minPrice,this.stockChart.calculatePriceRange(this.stockChart.options.plots.find(t=>"main"===t.id),this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport).maxPrice)}t.restore()}renderLine(t,i,s){if(i.length<2)return;const h=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!h)return;const e=this.stockChart.options.plots.find(t=>"main"===t.id);if(!e)return;const n=this.stockChart.calculatePriceRange(e,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!n)return;const r=new o,a=r.getPixelCoordinates(i[0].time,i[0].price,h,{...this.stockChart.dataViewport,getVisibleData:()=>this.stockChart.dataViewport.getVisibleData()},n.minPrice,n.maxPrice),c=r.getPixelCoordinates(i[1].time,i[1].price,h,{...this.stockChart.dataViewport,getVisibleData:()=>this.stockChart.dataViewport.getVisibleData()},n.minPrice,n.maxPrice);a&&c&&(t.strokeStyle=s.strokeStyle,t.lineWidth=s.lineWidth,t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(c.x,c.y),t.stroke())}renderRectangle(t,i,s){if(i.length<2)return;const h=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!h)return;const e=this.stockChart.options.plots.find(t=>"main"===t.id);if(!e)return;const n=this.stockChart.calculatePriceRange(e,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!n)return;const r=(new o).getPixelCoordinates(i[0].time,i[0].price,h,this.stockChart.dataViewport,n.minPrice,n.maxPrice),a=(new o).getPixelCoordinates(i[1].time,i[1].price,h,this.stockChart.dataViewport,n.minPrice,n.maxPrice);if(!r||!a)return;const c=Math.min(r.x,a.x),l=Math.min(r.y,a.y),u=Math.abs(a.x-r.x),f=Math.abs(a.y-r.y);s.fillStyle&&(t.fillStyle=s.fillStyle,t.fillRect(c,l,u,f)),t.strokeStyle=s.strokeStyle,t.lineWidth=s.lineWidth,t.strokeRect(c,l,u,f)}isNearDrawing(t,i,s){const h=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!h)return!1;const e=this.stockChart.options.plots.find(t=>"main"===t.id);if(!e)return!1;const n=this.stockChart.calculatePriceRange(e,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!n)return!1;const r=s.points.map(t=>(new o).getPixelCoordinates(t.time,t.price,h,this.stockChart.dataViewport,n.minPrice,n.maxPrice)).filter(Boolean);if(r.length<2)return!1;switch(s.type){case"line":case"fibonacci":return this.isPointNearLine(t,i,r,10);case"rectangle":return this.isPointInRectangle(t,i,r);default:return!1}}isPointNearLine(t,i,s,h){if(s.length<2)return!1;const[e,n]=s;return this.pointToLineDistance(t,i,e.x,e.y,n.x,n.y)<=h}isPointInRectangle(t,i,s){if(s.length<2)return!1;const h=Math.min(s[0].x,s[1].x),e=Math.min(s[0].y,s[1].y),n=Math.abs(s[1].x-s[0].x),o=Math.abs(s[1].y-s[0].y);return t>=h&&t<=h+n&&i>=e&&i<=e+o}pointToLineDistance(t,i,s,h,e,n){const o=e-s,r=n-h,a=o*o+r*r;let c,l,u=-1;0!==a&&(u=((t-s)*o+(i-h)*r)/a),u<0?(c=s,l=h):u>1?(c=e,l=n):(c=s+u*o,l=h+u*r);const f=t-c,d=i-l;return Math.sqrt(f*f+d*d)}isNearDrawingPoint(t,i,s){const h=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!h)return null;const e=this.stockChart.options.plots.find(t=>"main"===t.id);if(!e)return null;const n=this.stockChart.calculatePriceRange(e,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!n)return null;for(let e=0;e<s.points.length;e++){const r=s.points[e],a=(new o).getPixelCoordinates(r.time,r.price,h,this.stockChart.dataViewport,n.minPrice,n.maxPrice);if(a){let h;if(h="fibonacci-zoon"===s.type?Math.abs(t-a.x):Math.sqrt(Math.pow(t-a.x,2)+Math.pow(i-a.y,2)),h<=10)return{pointIndex:e,drawing:s}}}return null}trySelectPoint(t,i){for(const s of this.drawings){const h=this.isNearDrawingPoint(t,i,s);if(h)return this.selectedDrawing=h.drawing,this.selectedPoint=h.pointIndex,this.isEditing=!0,!0}return!1}exportDrawings(){return JSON.stringify(this.drawings)}importDrawings(t){try{const i=JSON.parse(t);this.drawings=i}catch(t){}}}class f{static init(t,i){const s=document.getElementById(t);if(!s)return;const h=new f(s,i);return h.render(),h}constructor(t,i){this.ensureContainerSize(t),this.container=t,this.options=f.ensureValidOptions(i),this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.wrapper.style.display="flex",this.wrapper.style.width="100%",this.wrapper.style.height="100%",this.container.appendChild(this.wrapper),this.createToolbar(),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.style.flex="1",this.wrapper.appendChild(this.canvas),this.initialPinchDistance=0,this.isPinching=!1;const e=this.options.plots?.find(t=>"main"===t.id);if(!e)throw new Error("StockChart options must include a plot with id 'main'.");this.dataViewport=new h(e.data||[],this.options.initialVisibleCandles,5),this.plotLayoutManager=new s(this.canvas.width,this.canvas.height,this.options.plots),this.resize(),this.isDragging=!1,this.isResizingPlot=!1,this.resizingPlotId=null,this.isDraggingYAxis=!1,this.lastMouseX=0,this.lastMouseY=0,this.lastTouchX=0,this.lastTouchY=0,this.crosshairX=-1,this.crosshairY=-1,this.resizeHandleHeight=10,this.minPrice=0,this.maxPrice=0,this.priceScale=1,this.priceOffset=0,this.plotScales=new Map,this.drawingPanel=new u(this),this.activeDrawingTool=null,this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("broadcastCursor",t=>{const{x:i,y:s}=t.detail;this.crosshairX=i,this.crosshairY=s,this.render()}),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseout",this.handleMouseOut.bind(this)),this.canvas.addEventListener("wheel",this.handleMouseWheel.bind(this)),this.canvas.addEventListener("dblclick",this.resetVerticalScale.bind(this)),window.addEventListener("keydown",this.handleKeyDown.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this.handleTouchEnd.bind(this)),this.resizeObserver=new ResizeObserver(t=>{for(let i of t)i.target===this.container&&(this.resize(),this.render())}),this.resizeObserver.observe(this.container),this.applyTheme(this.options.theme)}static defaultOptions={theme:"light",plots:[{id:"main",heightRatio:.7,data:[],type:"line"}],initialVisibleCandles:100};static ensureValidOptions(t={}){return{...this.defaultOptions,...t,plots:t.plots||[...this.defaultOptions.plots],theme:t.theme||this.defaultOptions.theme}}static themes={light:t,dark:i};createToolbar(){const t=document.createElement("div");t.style.width="40px",t.style.backgroundColor=this.currentTheme?.background||"#ffffff",t.style.borderRight="1px solid "+(this.currentTheme?.gridColor||"#e0e0e0"),t.style.display="flex",t.style.flexDirection="column",t.style.padding="5px",t.style.gap="5px",[{name:"cursor",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M13.64,21.97C13.14,22.21 12.54,22 12.31,21.5L10.13,16.76L7.62,18.78C7.45,18.92 7.24,19 7,19A1,1 0 0,1 6,18V3A1,1 0 0,1 7,2C7.24,2 7.47,2.09 7.64,2.23L7.65,2.22L19.14,11.86C19.57,12.22 19.62,12.85 19.27,13.27C19.12,13.45 18.91,13.57 18.7,13.61L15.54,14.23L17.74,18.96C18,19.46 17.76,20.05 17.26,20.28L13.64,21.97Z"/></svg>',tooltip:"Select Tool"},{name:"line",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M7 21L17 3h2L9 21H7"/></svg>',tooltip:"Line Tool"},{name:"vertical-line",icon:'<svg viewBox="0 0 24 24" width="18" height="18"> <path fill="currentColor" d="M12 3h2v18h-2V3"/></svg>',tooltip:"Vertical Line Tool"},{name:"horizontal-line",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M3 12h18v2H3v-2"/></svg>',tooltip:"Horizontal Line Tool"},{name:"rectangle",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M2 4H22V20H2V4M4 6V18H20V6H4Z"/></svg>',tooltip:"Rectangle Tool"},{name:"fibonacci",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M3 5h18v2H3V5m0 4h18v2H3V9m0 4h18v2H3v-2m0 4h18v2H3v-2"/></svg>',tooltip:"Fibonacci Tool"},{name:"fibonacci-zoon",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M3 3v18h18v-2H5V3H3m5 0v14h2V3H8m5 0v14h2V3h-2m5 0v14h2V3h-2"/></svg>',tooltip:"Fibonacci Zoon Tool"},{name:"clear",icon:'<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>',tooltip:"Clear All Drawings"}].forEach(i=>{const s=document.createElement("button");s.innerHTML=i.icon,s.title=i.tooltip,s.style.width="30px",s.style.height="30px",s.style.border="none",s.style.borderRadius="4px",s.style.backgroundColor="transparent",s.style.cursor="pointer",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.padding="6px",s.style.color=this.currentTheme?.textColor||"#000000",s.addEventListener("mouseover",()=>{s.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0"}),s.addEventListener("mouseout",()=>{s.style.backgroundColor=i.name===this.activeDrawingTool?this.currentTheme?.gridColor||"#e0e0e0":"transparent"}),s.addEventListener("click",()=>{t.querySelectorAll("button").forEach(t=>{t.style.backgroundColor="transparent"}),"clear"===i.name?this.clearDrawings():"cursor"===i.name?(this.setDrawingTool(null),s.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0"):(this.setDrawingTool(i.name),s.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0")}),t.appendChild(s)}),this.wrapper.insertBefore(t,this.canvas),this.toolbar=t}calculatePriceRange(t,i,s){let h,e;if("volume"===t.type)h=0,e=Math.max(...i.map(t=>t.volume||1));else if("line"===t.type){const i=t.data.slice(s.startIndex,s.startIndex+s.visibleCount).map(t=>t.value??t.close).filter(t=>null!==t&&isFinite(t));if(0===i.length)return{minPrice:0,maxPrice:1};const n=Math.min(...i),o=Math.max(...i),r=.1*(o-n);h=n-r,e=o+r}else{const t=i.map(t=>t.low),s=i.map(t=>t.high),n=Math.min(...t),o=Math.max(...s),r=.1*(o-n);h=n-r,e=o+r}if(this.plotScales instanceof Map&&t&&t.id){const i=this.plotScales.get(t.id)||1;if(1!==i){const t=(e+h)/2,s=(e-h)/2;h=t-s/i,e=t+s/i}}return{minPrice:h,maxPrice:e}}calculateYAxisWidth(){if(!this.ctx||!this.dataViewport)return 80;const t=this.ctx;let i=0;const s=this.canvas.width<600?10:12;t.font=`${s}px Arial`;const h=this.dataViewport.getVisibleData();return 0===h.length?80:(this.options.plots.forEach(s=>{const{minPrice:e,maxPrice:n}=this.calculatePriceRange(s,h,this.dataViewport);let o=[e,n];const r=n-e;for(let t=1;t<4;t++)o.push(e+r*t/4);o.forEach(h=>{let e;e="volume"===s.type?h>=1e6?(h/1e6).toFixed(1)+"M":h>=1e3?(h/1e3).toFixed(1)+"K":Math.round(h).toLocaleString():h>=1e3?h.toFixed(0):h>=100?h.toFixed(1):h>=10?h.toFixed(2):h.toFixed(3);const n=t.measureText(e).width;i=Math.max(i,n)})}),i+(this.canvas.width<600?4:8))}resize(){let{clientWidth:t,clientHeight:i}=this.container;0===t&&(t=window.innerWidth),0===i&&(i=window.innerHeight);const s=t-40;this.canvas.width=s,this.canvas.height=i;const h=this.calculateYAxisWidth();this.plotLayoutManager.updateCanvasDimensions(s,i,h)}applyTheme(t){const i="string"==typeof t?f.themes[t]||f.themes.light:{...f.themes.light,...t};this.currentTheme=i,this.canvas.style.backgroundColor=i.background,this.toolbar&&(this.toolbar.style.backgroundColor=i.background,this.toolbar.style.borderRight=`1px solid ${i.gridColor}`,this.toolbar.querySelectorAll("button").forEach(t=>{t.style.color=i.textColor,t.title?.toLowerCase().includes(this.activeDrawingTool?.toLowerCase()||"")||null===this.activeDrawingTool&&"Select Tool"===t.title?t.style.backgroundColor=i.background:t.style.backgroundColor="transparent"})),this.render()}handleVerticalMouseWheel(t){if(t.ctrlKey){const i=t.deltaY<0?1.1:.9;this.priceScale*=i,this.render(),t.preventDefault()}}resetVerticalScale(){this.priceScale=1,this.priceOffset=0,this.render()}handleKeyDown(t){if(this.drawingPanel.isEditing&&this.drawingPanel.selectedDrawing&&("Delete"===t.key||"Backspace"===t.key)){const t=this.drawingPanel.drawings.indexOf(this.drawingPanel.selectedDrawing);-1!==t&&(this.drawingPanel.drawings.splice(t,1),this.drawingPanel.selectedDrawing=null,this.drawingPanel.selectedPoint=null,this.drawingPanel.isEditing=!1,this.drawingPanel.t=!1,this.render())}}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.currentTheme.chartAreaBackground||"#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.dataViewport.getVisibleData();if(0===t.length)return this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font="20px Arial",void this.ctx.fillText("No data to display",this.canvas.width/2-80,this.canvas.height/2);const i=new Map,s=this.options.plots.find(t=>"main"===t.id);if(!s)return;const h=s.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);i.set("main",this.calculatePriceRange(s,h,this.dataViewport)),this.options.plots.forEach(s=>{const h=s.overlay||!1,o=h?s.targetId||"main":s.id,r=this.plotLayoutManager.getPlotLayout(o);if(!r)return;const a=r.width/this.dataViewport.visibleCount;if(!h&&!i.has(s.id)){const t=s.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);i.set(s.id,this.calculatePriceRange(s,t,this.dataViewport))}const{minPrice:c,maxPrice:l}=i.get(o);if(r){if(h||(this.ctx.fillStyle=this.currentTheme.chartAreaBackground,this.ctx.fillRect(r.x,r.y,r.width,r.height),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.strokeRect(r.x,r.y,r.width,r.height)),this.options.plots.indexOf(s)!==this.options.plots.length-1&&!h){const t=r.y+r.height-this.resizeHandleHeight/2;this.ctx.fillStyle=this.isResizingPlot&&this.resizingPlotId===s.id?"rgba(150, 150, 150, 0.3)":"rgba(100, 100, 100, 0.1)",this.ctx.fillRect(r.x,t,r.width,this.resizeHandleHeight),this.ctx.fillStyle=this.currentTheme.gridColor;const i=6,h=30,e=r.x+(r.width-h)/2;for(let s=e;s<e+h;s+=i)this.ctx.beginPath(),this.ctx.arc(s,t+this.resizeHandleHeight/2,1,0,2*Math.PI),this.ctx.fill()}h||this.drawYAxisLabels(s,r,c,l),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(r.x,r.y,r.width,r.height),this.ctx.clip();const i=(s.data&&s.data.length>0?s.data:t).slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);switch(s.type){case"candlestick":i.forEach((t,i)=>{const s=.7*a,h=r.x+e(this.dataViewport.startIndex+i,this.dataViewport.startIndex,this.dataViewport.visibleCount,r.width,a)+(a-s)/2,o=n(t.open,c,l,r.height,r.y),u=n(t.high,c,l,r.height,r.y),f=n(t.low,c,l,r.height,r.y),d=n(t.close,c,l,r.height,r.y);!function(t,i,s,h,e,n,o,r,a){const c=i.close>i.open?a.candleUp:a.candleDown,l=a.candleBorderColor||a.textColor;t.strokeStyle=l,t.lineWidth=1,t.beginPath(),t.moveTo(s+r/2,e),t.lineTo(s+r/2,n),t.stroke(),t.fillStyle=c,t.strokeStyle=l,t.lineWidth=1,t.fillRect(s,Math.min(h,o),r,Math.abs(h-o)),t.strokeRect(s,Math.min(h,o),r,Math.abs(h-o))}(this.ctx,t,h,o,u,f,d,s,this.currentTheme)});break;case"line":this.drawLine(i,r,a,c,l,s);break;case"volume":this.drawVolume(i,a,r,l);break;case"histogram":this.drawHistogram(i,a,r,c,l,s);break;case"signal":this.drawSignals(i,r,a,c,l)}}this.ctx.restore()}),this.drawXAxisLabels(),this.drawChartName(),this.ctx.save();const o=this.plotLayoutManager.getPlotLayout("main");if(o&&(this.ctx.beginPath(),this.ctx.rect(o.x,o.y,o.width,o.height),this.ctx.clip()),this.drawingPanel.render(this.ctx),this.ctx.restore(),-1!==this.crosshairX&&-1!==this.crosshairY&&!this.activeDrawingTool){this.ctx.strokeStyle=this.currentTheme.crosshairColor,this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]);const t=this.options.plots[0],i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairX<=i.x+i.width&&(this.ctx.beginPath(),this.ctx.moveTo(this.crosshairX,0),this.ctx.lineTo(this.crosshairX,this.plotLayoutManager.getPlotTotalHeight()),this.ctx.stroke()),this.options.plots.forEach(t=>{if(t.overlay)return;const i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairY>=i.y&&this.crosshairY<=i.y+i.height&&(this.ctx.beginPath(),this.ctx.moveTo(0,this.crosshairY),this.ctx.lineTo(this.plotLayoutManager.getPlotTotalWidth(),this.crosshairY),this.ctx.stroke())}),this.ctx.setLineDash([]),this.displayInfoOverlay()}}drawLine(t,i,s,h,o,r){let a=-1;t.forEach((c,l)=>{const u=c.value??c.close;if(null!=u&&0!==u){if(-1!==a){const c=t[a],f=i.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)+s/2,d=n(c.value??c.close,h,o,i.height,i.y),M=i.x+e(this.dataViewport.startIndex+l,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)+s/2,m=n(u,h,o,i.height,i.y),p=r.style?.lineColor||this.currentTheme.lineColor,w=r.style?.lineWidth||2;!function(t,i,s,h,e,n,o){t.strokeStyle=n,t.lineWidth=o,t.beginPath(),t.moveTo(i,s),t.lineTo(h,e),t.stroke()}(this.ctx,f,d,M,m,p,w)}a=l}else a=-1})}drawVolume(t,i,s,h){t.forEach((t,n)=>{const o=.7*i,r=s.x+e(this.dataViewport.startIndex+n,this.dataViewport.startIndex,this.dataViewport.visibleCount,s.width,i)+(i-o)/2,a=(t.volume||0)/h*s.height,c=s.y+s.height-a;this.ctx.fillStyle=this.currentTheme.volumeColor||"rgba(0, 150, 136, 0.6)",this.ctx.fillRect(r,c,o,a)})}drawHistogram(t,i,s,h,o,r){t.forEach((t,a)=>{const c=.7*i,l=s.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,s.width,i)+(i-c)/2,u=n(0,h,o,s.height,s.y),f=n(t.value,h,o,s.height,s.y)-u;this.ctx.fillStyle=t.value>=0?r.style?.positiveColor||this.currentTheme.positiveColor:r.style?.negativeColor||this.currentTheme.negativeColor,this.ctx.fillRect(l,u,c,f)})}drawSignals(t,i,s,h,o){this.ctx.imageSmoothingEnabled=!1;const r={};t.filter(t=>null!=t.value).forEach((t,a)=>{const c=function(t){switch(t){case"support":return"rgba(0, 255, 0, 0.75)";case"resistance":return"rgba(255, 0, 0, 0.75)";case"uptrend":return"rgba(0, 255, 255, 0.75)";case"downtrend":return"rgba(255, 165, 0, 0.75)";default:return"rgba(0, 0, 0, 0.75)"}}(t.value.type);r[c]||(r[c]=new Path2D);const l=Math.floor(i.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)),u=Math.floor(n(t.value.value,h,o,i.height,i.y));r[c].rect(l,u,Math.ceil(s),10)}),Object.keys(r).forEach(t=>{this.ctx.fillStyle=t,this.ctx.fill(r[t])})}handleMouseDown(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;if(this.activeDrawingTool){const t=this.plotLayoutManager.getPlotLayout("main");return void(t&&s>=t.x&&s<=t.x+t.width&&h>=t.y&&h<=t.y+t.height&&this.drawingPanel.startDrawing(this.activeDrawingTool,s,h))}if(!this.drawingPanel.isChartFrozen){for(const i of this.options.plots){if(i.overlay)continue;const e=this.plotLayoutManager.getPlotLayout(i.id);if(e){const n={x:e.x+e.width,y:e.y,width:50,height:e.height};if(s>=n.x&&s<=n.x+n.width&&h>=n.y&&h<=n.y+n.height)return this.isDraggingYAxis=!0,this.resizingPlotId=i.id,void(this.lastMouseY=t.clientY)}}for(let i=0;i<this.options.plots.length-1;i++){const s=this.options.plots[i];if(!s.overlay){const i=this.plotLayoutManager.getPlotLayout(s.id),e=i.y+i.height;if(Math.abs(h-e)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=s.id,void(this.lastMouseY=t.clientY)}}this.isDragging=!0,this.lastMouseX=t.clientX}}handleMouseMove(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;if(this.drawingPanel.isDrawing){const i=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY});return this.drawingPanel.continueDrawing(i),void this.render()}const n=this.plotLayoutManager.getPlotLayout("main");if(n){const t=n.width/this.dataViewport.visibleCount,i=s-n.x,h=Math.round(i/t-.5),o=Math.max(0,Math.min(this.dataViewport.visibleCount-1,h)),r=n.x+e(this.dataViewport.startIndex+o,this.dataViewport.startIndex,this.dataViewport.visibleCount,n.width,t);this.crosshairX=r+t/2}if(this.crosshairY=h,this.isDraggingYAxis&&this.resizingPlotId){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;let s=this.plotScales.get(this.resizingPlotId)||1;return s*=Math.exp(.01*-i),s=Math.max(.1,Math.min(10,s)),this.plotScales.set(this.resizingPlotId,s),void this.render()}if(this.isResizingPlot){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;const s=this.options.plots.findIndex(t=>t.id===this.resizingPlotId);let h=s+1;for(;h<this.options.plots.length&&this.options.plots[h].overlay;)h++;if(s>=0&&h<this.options.plots.length){const t=this.options.plots[s],e=this.options.plots[h],n=t.heightRatio+e.heightRatio,o=i/(this.plotLayoutManager.getPlotLayout(t.id).height/t.heightRatio),r=.1*n,a=Math.max(r,Math.min(n-r,t.heightRatio+o));t.heightRatio=a,e.heightRatio=n-a,this.resize(),this.render()}}else if(this.isDragging){const i=t.clientX-this.lastMouseX,s=this.plotLayoutManager.getPlotLayout("main"),h=s?s.width/this.dataViewport.visibleCount:this.canvas.width/this.dataViewport.visibleCount,e=Math.round(i/h);0!==e&&(this.dataViewport.scroll(-e),this.lastMouseX=t.clientX,this.render())}else{let t=!1;for(const i of this.options.plots){if(i.overlay)continue;const s=this.plotLayoutManager.getPlotLayout(i.id);if(s){const i=s.y+s.height;if(Math.abs(this.crosshairY-i)<this.resizeHandleHeight){this.canvas.style.cursor="row-resize",t=!0;break}const h={x:s.x+s.width,y:s.y,width:50,height:s.height};if(this.crosshairX>=h.x&&this.crosshairX<=h.x+h.width&&this.crosshairY>=h.y&&this.crosshairY<=h.y+h.height){this.canvas.style.cursor="ns-resize",t=!0;break}}}t||(this.canvas.style.cursor="default"),this.render()}}handleMouseUp(t){if(this.drawingPanel.isDrawing){this.drawingPanel.completeDrawing(),this.setDrawingTool(null);const t=this.toolbar.querySelector('button[title="Select Tool"]');return t&&(t.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0",this.toolbar.querySelectorAll("button").forEach(i=>{i!==t&&(i.style.backgroundColor="transparent")})),void this.render()}if(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.canvas.style.cursor="default",t&&2===t.detail){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const e={x:i.x+i.width,y:i.y,width:50,height:i.height};if(s>=e.x&&s<=e.x+e.width&&h>=e.y&&h<=e.y+e.height){this.plotScales.delete(t.id),this.render();break}}}}}handleMouseOut(){this.isDragging=!1,this.crosshairX=-1,this.crosshairY=-1,this.render()}handleMouseWheel(t){if(t.preventDefault(),this.drawingPanel.isChartFrozen)return;const i=this.canvas.getBoundingClientRect();t.clientX,i.left;const s=t.clientY-i.top;if(t.ctrlKey){const i=t.deltaY<0?1.1:1/1.1,h=this.plotLayoutManager.getPlotLayout("main");if(h){const t=this.maxPrice-this.minPrice,e=t/i,n=this.minPrice+(this.maxPrice-this.minPrice)*((h.y+h.height-s)/h.height);this.minPrice=n-e*((n-this.minPrice)/t),this.maxPrice=n+e*((this.maxPrice-n)/t)}this.render()}else{const i=t.deltaY<0?1.1:.901,s=Math.floor(this.crosshairX/(this.canvas.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i,s),this.render()}}lastTapTime=0;lastTapX=0;lastTapY=0;touchHoldTimer=null;isCrosshairMode=!1;touchStartX=0;touchStartY=0;handleTouchStart(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();if(this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null),!this.drawingPanel.isChartFrozen)if(t.touches.length!==this.lastTouchCount&&(this.isPinching=!1,this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.isCrosshairMode=!1,this.initialPinchDistance=0),this.lastTouchCount=t.touches.length,2===t.touches.length){const s=t.touches[0],h=t.touches[1],e=s.clientX-i.left,n=s.clientY-i.top,o=h.clientX-i.left,r=h.clientY-i.top,a=Math.sqrt(Math.pow(o-e,2)+Math.pow(r-n,2));a>30&&(this.isPinching=!0,this.initialPinchDistance=a,this.pinchCenterX=(e+o)/2,this.pinchCenterY=(n+r)/2,this.lastPinchDistance=a),this.initialPinchDistance=Math.sqrt(Math.pow(o-e,2)+Math.pow(r-n,2)),this.pinchCenterX=(e+o)/2,this.pinchCenterY=(n+r)/2}else if(1===t.touches.length){const s=t.touches[0],h=s.clientX-i.left,n=s.clientY-i.top;this.initialTouchX=h,this.initialTouchY=n,this.lastTouchX=h,this.lastTouchY=n;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const s={x:i.x+i.width,y:i.y,width:50,height:i.height};if(h>=s.x&&h<=s.x+s.width&&n>=s.y&&n<=s.y+s.height){const i=(new Date).getTime(),s=i-this.lastTapTime,e=Math.sqrt(Math.pow(h-this.lastTapX,2)+Math.pow(n-this.lastTapY,2));return s<300&&e<30?(this.plotScales.delete(t.id),this.render(),void(this.lastTapTime=0)):(this.lastTapTime=i,this.lastTapX=h,this.lastTapY=n,this.isDraggingYAxis=!0,this.resizingPlotId=t.id,void(this.lastTouchY=n))}}}for(let t=0;t<this.options.plots.length-1;t++){const i=this.options.plots[t];if(!i.overlay){const t=this.plotLayoutManager.getPlotLayout(i.id),s=t.y+t.height;if(Math.abs(n-s)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=i.id,void(this.lastTouchY=n)}}this.isDragging=!0,this.lastTouchX=h,this.lastTouchY=n,this.crosshairX=-1,this.crosshairY=-1,this.touchHoldTimer=setTimeout(()=>{if(this.isDragging){this.isCrosshairMode=!0;const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=t.width/this.dataViewport.visibleCount,s=h-t.x,o=Math.round(s/i-.5),r=Math.max(0,Math.min(this.dataViewport.visibleCount-1,o)),a=t.x+e(this.dataViewport.startIndex+r,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=a+i/2,this.crosshairY=n}this.render()}},1e3)}}handleTouchMove(t){if(t.preventDefault(),this.drawingPanel.isChartFrozen)return;const i=this.canvas.getBoundingClientRect();if(2===t.touches.length&&this.isPinching){const s=t.touches[0],h=t.touches[1],e=s.clientX-i.left,n=s.clientY-i.top,o=h.clientX-i.left,r=h.clientY-i.top,a=Math.sqrt(Math.pow(o-e,2)+Math.pow(r-n,2));if(this.initialPinchDistance>10&&a>10){const t=a/this.initialPinchDistance,i=(e+o)/2,s=(n+r)/2,h=.3,c=this.pinchCenterX?this.pinchCenterX*(1-h)+i*h:i,l=this.pinchCenterY?this.pinchCenterY*(1-h)+s*h:s;let u=null;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i&&l>=i.y&&l<=i.y+i.height){u=t.id;break}}if(u){const i=Math.abs(l-this.pinchCenterY),s=Math.abs(c-this.pinchCenterX),h=.002,e=Math.abs(t-1);if(e>h){const h=1+(t-1)*Math.min(.3,.5*e);if(i>1.2*s){let t=this.plotScales.get(u)||1;t*=Math.exp(.3*(h-1)),t=Math.max(.1,Math.min(10,t)),this.plotScales.set(u,t)}else{const t=.02,i=Math.exp((h-1)*t),s=this.plotLayoutManager.getPlotLayout(u),e=Math.floor((c-s.x)/(s.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i>1?1.03:.97,e)}}}this.pinchCenterX=c,this.pinchCenterY=l,this.initialPinchDistance=a,this.render()}}else if(1===t.touches.length){const s=t.touches[0],h=s.clientX-i.left,n=s.clientY-i.top,o=this.plotLayoutManager.getPlotLayout("main");if(o){const t=o.width/this.dataViewport.visibleCount;if(this.isCrosshairMode){const i=h-o.x,s=Math.round(i/t-.5),r=Math.max(0,Math.min(this.dataViewport.visibleCount-1,s)),a=o.x+e(this.dataViewport.startIndex+r,this.dataViewport.startIndex,this.dataViewport.visibleCount,o.width,t);this.crosshairX=a+t/2,this.crosshairY=n}else if(this.isDragging){const t=Math.abs(h-this.initialTouchX),i=Math.abs(n-this.initialTouchY);Math.sqrt(t*t+i*i)>10&&this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null,this.isCrosshairMode=!1,this.crosshairX=-1,this.crosshairY=-1)}}if(this.isDraggingYAxis&&this.resizingPlotId){const t=n-this.lastTouchY;this.lastTouchY=n;let i=this.plotScales.get(this.resizingPlotId)||1;i*=Math.exp(.01*-t),i=Math.max(.1,Math.min(10,i)),this.plotScales.set(this.resizingPlotId,i),this.render()}else if(this.isResizingPlot&&this.resizingPlotId){const t=n-this.lastTouchY;this.lastTouchY=n;const i=this.options.plots.findIndex(t=>t.id===this.resizingPlotId);let s=i+1;for(;s<this.options.plots.length&&this.options.plots[s].overlay;)s++;if(i>=0&&s<this.options.plots.length){const h=this.options.plots[i],e=this.options.plots[s],n=h.heightRatio+e.heightRatio,o=t/(this.plotLayoutManager.getPlotLayout(h.id).height/h.heightRatio),r=.1*n,a=Math.max(r,Math.min(n-r,h.heightRatio+o));h.heightRatio=a,e.heightRatio=n-a,this.resize(),this.render()}}else if(this.isDragging){const t=h-this.lastTouchX,i=this.plotLayoutManager.getPlotLayout("main"),s=i?i.width/this.dataViewport.visibleCount:this.canvas.width/this.dataViewport.visibleCount,o=Math.round(t/s);if(this.isCrosshairMode){const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=t.width/this.dataViewport.visibleCount,s=h-t.x,o=Math.round(s/i-.5),r=Math.max(0,Math.min(this.dataViewport.visibleCount-1,o)),a=t.x+e(this.dataViewport.startIndex+r,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=a+i/2,this.crosshairY=n,this.render()}}else 0!==o&&(this.dataViewport.scroll(-o),this.lastTouchX=h,this.render())}}}handleTouchEnd(t){t.preventDefault(),this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null);const i=this.lastTouchCount;if(this.lastTouchCount=t.touches.length,2===i&&1===t.touches.length){this.isPinching=!1,this.initialPinchDistance=0,this.lastPinchDistance=0;const i=t.touches[0],s=this.canvas.getBoundingClientRect();this.lastTouchX=i.clientX-s.left,this.lastTouchY=i.clientY-s.top,this.isDragging=!0}else 0===t.touches.length&&(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.isPinching=!1,this.initialPinchDistance=0,this.lastPinchDistance=0,this.isCrosshairMode||(this.crosshairX=-1,this.crosshairY=-1),this.isCrosshairMode=!1);this.render()}drawChartName(){const{chartName:t}=this.options;if(!t)return;const{name:i,code:s,metaString:h}=t,{textColor:e}=this.currentTheme,n=this.canvas.width<600?10:14;let o=20;this.ctx.fillStyle=e,this.ctx.textAlign="left",i&&(this.ctx.font=`bold ${n+2}px Arial`,this.ctx.fillText(i,10,o),o+=n+4),s&&(this.ctx.font=`${n}px Arial`,this.ctx.fillText(s,10,o),o+=n+2),h&&(this.ctx.font=`italic ${n-1}px Arial`,this.ctx.fillText(h,10,o))}drawXAxisLabels(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width,h=Math.max(10,Math.min(12,Math.floor(s/50))),n=8*h,o=Math.floor(s/n),r=o>10?10:o,a=Math.max(1,Math.floor(t.length/r));this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font=`${h}px Arial`,this.ctx.textAlign="center";const c=this.canvas.height-h,l=new Date(1e3*t[0].time);new Date(1e3*t[t.length-1].time).getTime(),l.getTime();const u=i.width/this.dataViewport.visibleCount;for(let s=0;s<t.length;s+=a){const h=t[s];if(!h||!h.time)continue;const n=e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,u),o=new Date(1e3*h.time).toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"}),r=i.x+n+u/2;r>=i.x&&r<=i.x+i.width&&this.ctx.fillText(o,r,c)}}drawYAxisLabels(t,i,s,h){this.ctx.fillStyle=this.currentTheme.textColor;const e=this.canvas.width<600?10:12;this.ctx.font=`${e}px Arial`,this.ctx.textAlign="left",this.ctx.textBaseline="middle";const o=e+4,r=Math.max(3,Math.min(8,Math.floor(i.height/o))),a=Math.min(5,r),c=(h-s)/a,l=[];for(let t=0;t<=a;t++){const e=s+t*c,o=n(e,s,h,i.height,i.y);l.push({price:e,y:o})}const u=l.filter(({y:t})=>{const s=1.5*e;return t>=i.y+s&&t<=i.y+i.height-s});let f=u;if(u.length<2&&l.length>=2){const t=l[0],s=l[l.length-1];f=[{...t,y:Math.max(i.y+e,t.y)},{...s,y:Math.min(i.y+i.height-e,s.y)}]}f.forEach(({price:s,y:h})=>{let e;this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.setLineDash([2,2]),this.ctx.moveTo(i.x,h),this.ctx.lineTo(i.x+i.width,h),this.ctx.stroke(),this.ctx.setLineDash([]),e="volume"===t.type?s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(1)+"K":Math.round(s).toLocaleString():s>=1e3?s.toFixed(0):s>=100?s.toFixed(1):s>=10?s.toFixed(2):s.toFixed(3);const n=i.x+i.width+4;this.ctx.fillText(e,n,Math.round(h))}),this.ctx.textBaseline="alphabetic",this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.moveTo(i.x+i.width,i.y),this.ctx.lineTo(i.x+i.width,i.y+i.height),this.ctx.stroke()}displayInfoOverlay(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width/this.dataViewport.visibleCount,h=this.crosshairX-i.x,e=Math.max(0,Math.floor(h/s)),n=this.dataViewport.startIndex+e;this.options.plots.forEach(i=>{const s=this.plotLayoutManager.getPlotLayout(i.id);if(!s||i.overlay)return;const h=i.data&&i.data.length>0?i.data:t;if(n>=0&&n<h.length){const l=h[n];if(this.ctx.fillStyle=this.currentTheme.overlayTextColor,this.ctx.font="12px Arial",this.crosshairY>=s.y&&this.crosshairY<=s.y+s.height){const{minPrice:h,maxPrice:n}=this.calculatePriceRange(i,t,this.dataViewport),l=(e=this.crosshairY,o=s.y,a=h,c=n,0===(r=s.height)?(c+a)/2:a+(1-(e-o)/r)*(c-a));let u;u="volume"===i.type?l>=1e6?(l/1e6).toFixed(2)+"M":l>=1e3?(l/1e3).toFixed(2)+"K":Math.round(l).toString():l>=1e3?l.toFixed(0):l>=100?l.toFixed(1):l>=10?l.toFixed(2):l.toFixed(3),this.ctx.textAlign="left",this.ctx.textBaseline="middle";const f=this.plotLayoutManager.getPlotTotalWidth()+5;this.ctx.fillText(u,f,Math.round(this.crosshairY))}if("main"===i.id&&void 0!==l.time){const t=new Date(1e3*l.time).toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"});this.ctx.textAlign="center",this.ctx.textBaseline="middle";const i=this.plotLayoutManager.getPlotTotalHeight()+15;this.ctx.fillText(t,this.crosshairX,i)}const u=this.options.plots.filter(t=>t.targetId===i.id||t.id===i.id),f=[];u.forEach(i=>{const s=i.data&&i.data.length>0?i.data:t;if(n>=0&&n<s.length){const t=s[n],h=Object.entries(t).map(([t,s])=>{if("time"===t||"date"===t||"keyLabel"===t)return null;const h="number"==typeof s?s.toFixed(2):s;return`${i.keyLabel?.trim().length>0?i.keyLabel:t.charAt(0).toUpperCase()+t.slice(1)}: ${h}`}).filter(Boolean).join(" | ");h&&f.push(h)}});const d=15,M=10,m=s.x+s.width-M;if(this.ctx.textAlign="right",!u.some(t=>"main"===t.id||"main"===t.targetId)){const t=f.join(" | ");f.length=0,f.push(t)}f.forEach((t,i)=>{const h=s.y+(i+1)*d;this.ctx.fillText(t,m,h)}),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}var e,o,r,a,c})}renderOverlayPanels(){this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.font="10px Arial",this.ctx.fillText("Overlay panels reserved for indicators",10,this.canvas.height-10),this.ctx.restore()}ensureContainerSize(t){t.clientHeight<1&&(t.style.height=.9*window.innerHeight+"px"),t.clientWidth<1&&(t.style.width=.9*window.innerWidth+"px")}setDrawingTool(t){this.activeDrawingTool=t,this.drawingPanel.setActiveTool(t),this.canvas.style.cursor=t?"crosshair":"default",this.toolbar&&this.toolbar.querySelectorAll("button").forEach(i=>{const s="Select Tool"===i.title;i.style.backgroundColor=null===t?s?this.currentTheme?.gridColor||"#e0e0e0":"transparent":i.title?.toLowerCase().includes(t.toLowerCase())?this.currentTheme?.gridColor||"#e0e0e0":"transparent"})}clearDrawings(){this.drawingPanel.clearDrawings(),this.render()}importDrawings(t){this.drawingPanel.importDrawings(t),this.render()}exportDrawings(){return this.drawingPanel.exportDrawings()}}return f});//# sourceMappingURL=stock-chart.umd.min.js.map

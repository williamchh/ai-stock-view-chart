!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).StockChart=i()}(this,function(){"use strict";const t={name:"light",background:"#FFFFFF",chartAreaBackground:"#F8F8F8",gridColor:"#E0E0E0",textColor:"#333333",candleUp:"#4CAF50",candleDown:"#F44336",candleBorderColor:"#333333",lineColor:"#2196F3",crosshairColor:"#9E9E9E",overlayTextColor:"#333333",positiveColor:"rgba(76, 175, 80, 0.8)",negativeColor:"rgba(244, 67, 54, 0.8)"},i={name:"dark",background:"#1A1A1A",chartAreaBackground:"#2C2C2C",gridColor:"#444444",textColor:"#E0E0E0",candleUp:"#66BB6A",candleDown:"#EF5350",candleBorderColor:"#E0E0E0",lineColor:"#64B5F6",crosshairColor:"#BDBDBD",overlayTextColor:"#E0E0E0",positiveColor:"rgba(102, 187, 106, 0.8)",negativeColor:"rgba(239, 83, 80, 0.8)",borderColorUseBodyColor:!0};class s{plotTotalHeight;plotTotalWidth;yAxisWidth=80;bottomMargin=40;leftMargin=0;topMargin=0;constructor(t,i,s){this.canvasWidth=t,this.canvasHeight=i,this.plotConfigs=s,this.plots={},this.calculateLayout()}calculateLayout(){let t=0;const i=this.plotConfigs.filter(t=>!t.overlay).reduce((t,i)=>t+i.heightRatio,0);[...this.plotConfigs].sort((t,i)=>"main"===t.id?-1:"main"===i.id?1:"volume"===t.id?-1:"volume"===i.id?1:0).forEach(s=>{if(s.overlay){const t=this.plots.main;t&&(this.plots[s.id]={...t})}else{const e=this.canvasWidth-this.leftMargin-this.yAxisWidth,n=this.canvasHeight-this.topMargin-this.bottomMargin,o=s.heightRatio/i*n;this.plots[s.id]={x:this.leftMargin,y:t+this.topMargin,width:e,height:o},t+=o}}),this.plotTotalHeight=t,this.plotTotalWidth=this.canvasWidth-this.yAxisWidth}getPlotLayout(t){return this.plots[t]||null}updatePlotIndicator(t,i){"delete"===i&&(this.plotConfigs=this.plotConfigs.filter(i=>!i.indicator||i.indicator.id!==t.id&&i.targetId!==t.targetId)),this.calculateLayout()}updateCanvasDimensions(t,i,s=void 0){this.canvasWidth=t,this.canvasHeight=i,void 0!==s&&(this.yAxisWidth=s),this.calculateLayout()}getPlotTotalWidth(){return this.plotTotalWidth}getPlotTotalHeight(){return this.plotTotalHeight}updatePlotConfigurations(t){this.plotConfigs=t,this.calculateLayout()}}class e{constructor(t,i,s=0){this.allData=t,this.visibleCount=Math.min(i,t.length+s),this.rightPadding=s,this.maxStartIndex=Math.max(0,t.length-this.visibleCount+s),this.startIndex=Math.max(0,t.length-(this.visibleCount-s))}MIN_PORT_VISIBLE_COUNT=10;getVisibleData(){const t=Math.min(this.startIndex+this.visibleCount,this.allData.length);return this.allData.slice(this.startIndex,t)}getVisibleStartEndTime(){const t=this.getVisibleData();return t&&0!==t.length?{startTime:t[0].time,endTime:t[t.length-1].time}:null}scroll(t){this.maxStartIndex=this.allData.length-this.visibleCount+this.rightPadding;const i=this.startIndex+t,s=Math.min(Math.round(.1*this.visibleCount),Math.round(.1*this.allData.length)),e=this.maxStartIndex+s;this.startIndex=Math.max(0,Math.min(e,i))}zoom(t,i){if(t<1&&this.startIndex<=0&&(window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount),zoomFactor:t,anchorIndex:i}})),0===this.startIndex))return;const s=this.startIndex+i;let e=t;Math.round(this.visibleCount/t)>200&&t<.99&&(e*=.99);const n=Math.max(this.MIN_PORT_VISIBLE_COUNT,Math.min(this.allData.length,Math.round(this.visibleCount/e))),o=i/this.visibleCount,h=s-Math.round(n*o);this.visibleCount=n,this.maxStartIndex=Math.max(0,this.allData.length-this.visibleCount);const a=Math.round(.05*this.visibleCount),r=Math.max(-a,0),l=this.maxStartIndex+a;this.startIndex=Math.max(r,Math.min(l,h)),this.startIndex<=r&&t<1&&window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount)}}))}updateData(t){this.allData=t,this.startIndex=Math.max(0,this.allData.length-this.visibleCount)}}function n(t,i,s,e,n){return(t-i)*n}function o(t,i,s,e,n){const o=s-i;return 0===o?n+e/2:n+e-(t-i)/o*e}function h(t){return{period:t,count:0,initialSum:0,ema:null,lastValue:null}}function a(t,i,s=!1){const e={...i};if(s&&null!==e.ema&&null!==e.lastValue){const i=2/(e.period+1),s=(e.ema-e.lastValue*i)/(1-i);e.ema=t*i+s*(1-i),e.lastValue=t}else if(!s){if(e.count<e.period)e.initialSum+=t,e.count++,e.count===e.period&&(e.ema=e.initialSum/e.period);else{const i=2/(e.period+1);e.ema=t*i+e.ema*(1-i)}e.lastValue=t}return{value:e.ema,state:e}}function r(t,i,s=!1){const e=a(t,i.fast,s),n=a(t,i.slow,s),o=null!==e.value&&null!==n.value?e.value-n.value:null;let h={value:null,state:i.signal};null!==o&&(h=a(o,i.signal,s));const r=null!==o&&null!==h.value?o-h.value:null;return{macdLine:o,signalLine:h.value,histogram:r,state:{fast:e.state,slow:n.state,signal:h.state}}}function l(t){return{period:t,window:[],sum:0}}function c(t,i,s=!1){let e=[...i.window],n=i.sum;if(s&&e.length>0){const i=e[e.length-1];e[e.length-1]=t,n=n-i+t}else e.push(t),n+=t,e.length>i.period&&(n-=e.shift());return{value:e.length===i.period?n/i.period:null,state:{period:i.period,window:e,sum:n}}}function d(t,i,s=!1){const e={...i};if(null===e.lastPrice)return e.lastPrice=t,{value:null,state:e};const n=t-e.lastPrice,o=Math.max(0,n),h=Math.max(0,-n);return s?e.gains.length>0&&(e.gains[e.gains.length-1]=o,e.losses[e.losses.length-1]=h):(e.gains.push(o),e.losses.push(h),e.gains.length>e.period&&(e.gains.shift(),e.losses.shift())),e.lastPrice=t,e.gains.length===e.period?(0===e.avgGain?(e.avgGain=e.gains.reduce((t,i)=>t+i,0)/e.period,e.avgLoss=e.losses.reduce((t,i)=>t+i,0)/e.period):(e.avgGain=(e.avgGain*(e.period-1)+o)/e.period,e.avgLoss=(e.avgLoss*(e.period-1)+h)/e.period),0===e.avgLoss?{value:100,state:e}:{value:100-100/(1+e.avgGain/e.avgLoss),state:e}):{value:null,state:e}}function u(t,i,s=!1,e=!1){let n=[...i.window],o=i.sum,h=i.sumSquares;if(s&&n.length>0){const i=n[n.length-1];n[n.length-1]=t,o=o-i+t,h=h-i*i+t*t}else if(n.push(t),o+=t,h+=t*t,n.length>i.period){const t=n.shift();o-=t,h-=t*t}let a=null,r=null,l=null;if(n.length===i.period){a=o/i.period;const t=e?i.period-1:i.period,s=h/t-a*a*i.period/t,n=Math.sqrt(Math.max(0,s));r=a+i.multiplier*n,l=a-i.multiplier*n}return{middle:a,upper:r,lower:l,state:{period:i.period,multiplier:i.multiplier,window:n,sum:o,sumSquares:h}}}function p(t,i,s,e=!1){let n=0,o=0;null===s.prevHigh||null===s.prevLow||e?null!==s.prevHigh&&null!==s.prevLow&&e&&(n=Math.max(0,t-s.prevHigh),o=Math.max(0,s.prevLow-i)):(n=Math.max(0,t-s.prevHigh),o=Math.max(0,s.prevLow-i));let h={value:null,state:s.demaxSMA},a={value:null,state:s.deminSMA};null!==s.prevHigh&&null!==s.prevLow&&(h=c(n,s.demaxSMA,e),a=c(o,s.deminSMA,e));let r=null;if(null!==h.value&&null!==a.value){const t=h.value+a.value;r=0!==t?h.value/t:.5}return{demarker:r,state:{period:s.period,prevHigh:e?s.prevHigh:t,prevLow:e?s.prevLow:i,demaxSMA:h.state,deminSMA:a.state}}}class f{constructor(t){this.type=t,this.points=[],this.style={strokeStyle:"#000000",lineWidth:1,fillStyle:"rgba(0, 0, 0, 0.1)"}}addPoint(t,i){this.points.push({time:t,price:i})}getPixelCoordinates(t,i,s,e,n,o,h=!1){if(!e?.allData||0===e.allData.length)return null;const a=e.allData,r=a.findIndex(i=>i.time>=t),l=-1===r?a.length-1:0===r?0:Math.abs(a[r].time-t)<Math.abs(a[r-1].time-t)?r:r-1;if(-1===l)return null;const c=s.width/e.visibleCount,d=s.x+(l-e.startIndex)*c+c/2,u=o-n,p=u>0?s.y+(o-i)/u*s.height:s.y+s.height/2;return!h&&(p<s.y||(s.y,s.height)),{x:d,y:p}}draw(t,i,s,e,n){}toJSON(){return{type:this.type,points:this.points,style:this.style}}fromJSON(t){this.points=t.points,this.style=t.style}}class m extends f{constructor(t,i="trend-line"){super(i),this.barWidth=t,this.constraint="horizontal-line"===i?"horizontal":"vertical-line"===i?"vertical":"trend-line"}draw(t,i,s,e,n,o,h){if(this.points.length<2)return;let a=this.points[0],r=this.points[1];"horizontal"===this.constraint?r={...r,price:a.price}:"vertical"===this.constraint&&(r={...r,time:a.time});const l=this.getPixelCoordinates(a.time,a.price,i,s,e,n,!0),c=this.getPixelCoordinates(r.time,r.price,i,s,e,n,!0);if(!l||!c)return;const d=i.x,u=i.y,p=i.x+i.width,f=i.y+i.height;let m=l.x,b=l.y;const g=c.x-m,x=c.y-b;let y=0,w=1;const v=[-g,g,-x,x],M=[m-d,p-m,b-u,f-b];for(let t=0;t<4;t++)if(0===v[t]){if(M[t]<0)return}else{const i=M[t]/v[t];v[t]<0?y=Math.max(y,i):w=Math.min(w,i)}if(y<w){const i=m+y*g,s=b+y*x,e=m+w*g,n=b+w*x;t.beginPath(),t.strokeStyle=this.style.strokeStyle,t.lineWidth=this.style.lineWidth,t.moveTo(i,s),t.lineTo(e,n),t.stroke()}}}class b extends f{constructor(){super("rectangle")}draw(t,i,s,e,n,o){if(this.points.length<2)return;const h=this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,e,n),a=this.getPixelCoordinates(this.points[1].time,this.points[1].price,i,s,e,n);h&&a&&(t.beginPath(),t.fillStyle=this.style.fillStyle,t.strokeStyle=this.style.strokeStyle,t.lineWidth=this.style.lineWidth,t.rect(Math.min(h.x,a.x),Math.min(h.y,a.y),Math.abs(a.x-h.x),Math.abs(a.y-h.y)),t.fill(),t.stroke())}}class g extends f{constructor(t){super("fibonacci-retrace"),this.levels=[0,.236,.382,.618,1,1.618,2,2.618,3.618,4.236],this.style.strokeStyle="dark"===t?"#FFFFFF":"#000000"}draw(t,i,s,e,n,o,h){if(this.points.length<2)return;const a=!0,r=this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,e,n,a),l=this.getPixelCoordinates(this.points[1].time,this.points[1].price,i,s,e,n,a);if(!r||!l)return;const c=Math.abs(this.points[1].price-this.points[0].price),d=this.points[1].price>this.points[0].price,u=this.points[0].price;let p=null,f=null;if(h){p=h.startTime,f=h.endTime;const t=Math.min(this.points[0].time,this.points[1].time),i=Math.max(this.points[0].time,this.points[1].time);if(t>f||i<p)return}t.lineWidth=this.style.lineWidth,t.strokeStyle=o.textColor,t.fillStyle=o.textColor,t.setLineDash([5,5]),t.textAlign="left",t.font="12px Arial",this.levels.forEach(o=>{const h=d?u+c*o:u-c*o,a=this.getPixelCoordinates(this.points[1].time,h,i,s,e,n);if(!a)return;t.beginPath(),t.moveTo(r.x,a.y),t.lineTo(l.x,a.y),t.stroke();const p=(100*o).toFixed(1)+"%";t.fillText(p,l.x+5,a.y)}),t.setLineDash([])}}class x extends f{constructor(t,i){super("fibonacci-zoon"),this.theme=t,this.halfBarWidth=i/2}fibSequence(t=8){if(t<0)return[];if(0===t)return[0];if(1===t)return[1];const i=[0,1,1];for(;i.length<t;){const t=i.length;i.push(i[t-1]+i[t-2])}return i}draw(t,i,s,e,n,o,h){if(this.points.length<2)return;this.getPixelCoordinates(this.points[0].time,this.points[0].price,i,s,e,n),this.getPixelCoordinates(this.points[1].time,this.points[1].price,i,s,e,n);let a=null,r=null;h&&(a=h.startTime,r=h.endTime);const l=s.allData;if(!l||l.length<2)return;const c=l.findIndex(t=>t.time>=this.points[0].time),d=l.findIndex(t=>t.time>=this.points[1].time);if(-1===c||-1===d)return;const u=Math.abs(d-c),p=d>c?1:-1,f=Math.max(1,u),m=this.fibSequence(10),b=m.map(t=>{const i=c+p*t*f,s=l.length-1;return i>0&&i<=s?l[i].time:i<0?l[0].time-1:l[s].time+1}),g=o.textColor;this.style.strokeStyle=g,this.style.fillStyle=g,t.lineWidth=this.style.lineWidth,t.strokeStyle=g,t.fillStyle=g,t.setLineDash([5,5]),t.textAlign="center",t.font="12px Arial",b.forEach((o,h)=>{const l=s.allData[s.allData.length-1]?.time;if(l&&o>l)return;if(a&&o<a)return;if(r&&o>r)return;const c=this.getPixelCoordinates(o,this.points[0].price,i,s,e,n);if(!c)return;t.beginPath(),t.moveTo(c.x,i.y),t.lineTo(c.x,i.y+i.height-20),t.stroke();const d=m[h].toString();t.fillText(d,c.x,i.height-15),t.measureText(d).width;const u=m[h]*f;if(u>0){const s=`(${u})`,e=t.measureText(s).width;t.fillText(s,c.x+e,i.height-15)}}),t.setLineDash([])}}const y=new class{constructor(){this.dbName="StockChartDrawings",this.dbVersion=2,this.storeName="drawings",this.db=null}async init(){return new Promise((t,i)=>{if(this.db)return void t(this.db);const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>{i(new Error("Failed to open IndexedDB"))},s.onsuccess=i=>{this.db=i.target.result,t(this.db)},s.onupgradeneeded=t=>{const i=t.target.result;i.objectStoreNames.contains(this.storeName)&&i.deleteObjectStore(this.storeName);const s=i.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});s.createIndex("chartName","chartName",{unique:!1}),s.createIndex("chartCode","chartCode",{unique:!1}),s.createIndex("chartNameAndCode",["chartName","chartCode"],{unique:!1})}})}async saveDrawings(t,i){if(t&&(t.name||t.code))return await this.init(),new Promise((s,e)=>{const n=this.db.transaction([this.storeName],"readwrite"),o=n.objectStore(this.storeName),h=o.index("chartNameAndCode").getAll([t.name||"",t.code||""]);h.onsuccess=()=>{h.result.forEach(t=>{o.delete(t.id)}),i.forEach(i=>{const s={...i,chartName:t.name||"",chartCode:t.code||"",chartMetaString:t.metaString||"",timestamp:Date.now()};o.add(s)})},n.oncomplete=()=>{s()},n.onerror=()=>{e(new Error("Failed to save drawings"))}})}async loadDrawings(t){return t&&(t.name||t.code)?(await this.init(),new Promise((i,s)=>{const e=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("chartNameAndCode").getAll([t.name||"",t.code||""]);e.onsuccess=()=>{const t=e.result.map(t=>{const{id:i,chartName:s,chartCode:e,chartMetaString:n,timestamp:o,...h}=t;return h});i(t)},e.onerror=()=>{s(new Error("Failed to load drawings"))}})):[]}async loadDrawingsAcrossTimeframes(t){return t&&(t.name||t.code)?(await this.init(),new Promise((i,s)=>{const e=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("chartNameAndCode").getAll(IDBKeyRange.bound([t.name||"",t.code||""],[t.name||"",t.code||"ï¿¿"]));e.onsuccess=()=>{const t=e.result.map(t=>{const{id:i,chartName:s,chartCode:e,chartMetaString:n,timestamp:o,...h}=t;return h});i(t)},e.onerror=()=>{s(new Error("Failed to load drawings across timeframes"))}})):[]}async clearAllDrawings(){return await this.init(),new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();s.onsuccess=()=>{t()},s.onerror=()=>{i(new Error("Failed to clear drawings"))}})}async getAllChartNames(){return await this.init(),new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();s.onsuccess=()=>{const i=s.result,e=new Map;i.forEach(t=>{const i=`${t.chartName}|${t.chartCode}`;e.has(i)||e.set(i,{name:t.chartName,code:t.chartCode,metaString:t.chartMetaString})}),t(Array.from(e.values()))},s.onerror=()=>{i(new Error("Failed to get chart names"))}})}};function w(t){const i=t.replace("#","");return(.299*parseInt(i.substring(0,2),16)+.587*parseInt(i.substring(2,4),16)+.114*parseInt(i.substring(4,6),16))/255<.5}class v{constructor(t){this.stockChart=t,this.drawings=[],this.activeTool=null,this.currentDrawing=null,this.isDrawing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.isEditing=!1,this.t=!1,this.editPlotId=null,this.handleMouseDownBound=this.handleMouseDown.bind(this),this.handleMouseMoveBound=this.continueDrawing.bind(this),this.handleMouseUpBound=this.completeDrawing.bind(this),this.handleTouchStartBound=this.handleTouchStart.bind(this),this.handleTouchMoveBound=this.handleTouchMove.bind(this),this.handleTouchEndBound=this.handleTouchEnd.bind(this),this.stockChart.canvas.addEventListener("mousedown",this.handleMouseDownBound),this.stockChart.canvas.addEventListener("mousemove",this.handleMouseMoveBound),this.stockChart.canvas.addEventListener("mouseup",this.handleMouseUpBound),this.stockChart.canvas.addEventListener("touchstart",this.handleTouchStartBound,{passive:!1}),this.stockChart.canvas.addEventListener("touchmove",this.handleTouchMoveBound,{passive:!1}),this.stockChart.canvas.addEventListener("touchend",this.handleTouchEndBound),this.touchStartTime=0,this.touchTimeout=null,this.touchDistance=0,this.touchMoved=!1,this.defaultStyles={"trend-line":{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},"horizontal-line":{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},"vertical-line":{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},rectangle:{strokeStyle:"#ff6b35",lineWidth:2,fillStyle:"rgba(255, 107, 53, 0.1)"},"fibonacci-retrace":{strokeStyle:"dark"===t.options.theme?"#ffffffc5":"#000000a9",lineWidth:1,fillStyle:"rgba(76, 175, 80, 0.1)"},"fibonacci-zoon":{strokeStyle:"dark"===t.options.theme?"#ffffffc5":"#000000a9",lineWidth:1,fillStyle:"rgba(76, 175, 80, 0.1)"}}}get isChartFrozen(){return this.t}i(){return window.innerWidth<=768}o(t){const i=this.stockChart.canvas.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}setActiveTool(t){"settings"!==t?(this.activeTool===t?this.activeTool=null:this.activeTool=t,this.currentDrawing=null,this.isDrawing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.isEditing=!1):this.showIndicatorSettings()}startDrawing(t,i,s){if(this.activeTool&&this.activeTool!==t)return;this.isDrawing=!0,this.t=!0;const e=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!e)return;const n=i-e.x,o=e.width/this.stockChart.dataViewport.visibleCount,h=Math.floor(n/o),a=this.stockChart.dataViewport.startIndex+h;if(!this.stockChart.dataViewport?.allData)return;const r=this.stockChart.dataViewport.allData;if(!Array.isArray(r)||a<0||a>=r.length)return;const l=r[a];if(!l||"number"!=typeof l.time)return;const c=l.time;if(!this.stockChart.options?.plots)return;const d=this.stockChart.options.plots.find(t=>"main"===t.id);if(!d)return;const u=this.stockChart.calculatePriceRange(d,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!u)return;const{minPrice:p,maxPrice:f}=u,y=f-(s-e.y)/e.height*(f-p);switch(t){case"trend-line":this.currentDrawing=new m(o);break;case"rectangle":this.currentDrawing=new b;break;case"fibonacci-retrace":this.currentDrawing=new g(this.stockChart.options.theme);break;case"fibonacci-zoon":this.currentDrawing=new x(this.stockChart.options.theme,o);break;case"horizontal-line":this.currentDrawing=new m(o,"horizontal-line");break;case"vertical-line":this.currentDrawing=new m(o,"vertical-line");break;default:return}this.defaultStyles[t]&&Object.assign(this.currentDrawing.style,this.defaultStyles[t]),this.currentDrawing.addPoint(c,y)}continueDrawing(t){const i=this.stockChart.canvas.getBoundingClientRect(),s=t.clientX-i.left,e=t.clientY-i.top,o=this.stockChart.plotLayoutManager.getPlotLayout("main");if(o){if(s>=o.x&&s<=o.x+o.width){const t=o.width/this.stockChart.dataViewport.visibleCount,i=s-o.x,e=Math.round(i/t-.5),h=Math.max(0,Math.min(this.stockChart.dataViewport.visibleCount-1,e)),a=o.x+n(this.stockChart.dataViewport.startIndex+h,this.stockChart.dataViewport.startIndex,this.stockChart.dataViewport.visibleCount,o.width,t);this.stockChart.crosshairX=a+t/2}if(this.stockChart.crosshairY=e,s>=o.x&&s<=o.x+o.width&&e>=o.y&&e<=o.y+o.height){const t=s-o.x,i=o.width/this.stockChart.dataViewport.visibleCount,n=Math.floor(t/i),h=this.stockChart.dataViewport.startIndex+n;if(!this.stockChart.dataViewport?.allData||h<0||h>=this.stockChart.dataViewport.allData.length)return;const a=this.stockChart.dataViewport.allData[h];if(!a||"number"!=typeof a.time)return;const r=a.time,l=this.stockChart.options.plots.find(t=>"main"===t.id);if(!l)return;const c=this.stockChart.calculatePriceRange(l,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!c)return;const d=e-o.y,{minPrice:u,maxPrice:p}=c,f=p-d/o.height*(p-u);let m=!1;if(this.isEditing&&this.selectedDrawing&&null!==this.selectedPoint){const t={...this.selectedDrawing.points[this.selectedPoint]},i={time:r,price:f};t.time===i.time&&t.price===i.price||(this.selectedDrawing.points[this.selectedPoint]=i,m=!0)}else if(this.isDrawing&&this.currentDrawing)if(1===this.currentDrawing.points.length){const t={time:r,price:f};if(["horizontal-line","vertical-line"].includes(this.activeTool)){const i=this.currentDrawing.points[0];"horizontal-line"===this.activeTool?t.price=i.price:"vertical-line"===this.activeTool&&(t.time=i.time)}this.currentDrawing.addPoint(t.time,t.price),m=!0}else if(2===this.currentDrawing.points.length){const t={...this.currentDrawing.points[1]},i=this.currentDrawing.points[0];let s={time:r,price:f};["horizontal-line","vertical-line"].includes(this.activeTool)&&("horizontal-line"===this.activeTool?s.price=i.price:"vertical-line"===this.activeTool&&(s.time=i.time)),t.time===s.time&&t.price===s.price||(this.currentDrawing.points[1]=s,m=!0)}m&&this.stockChart.render()}}}completeDrawing(){this.isEditing?(this.selectedPoint=null,this.saveDrawingsToIndexedDB()):this.isDrawing&&this.currentDrawing&&this.currentDrawing.points.length>=2&&(this.drawings.push(this.currentDrawing),this.isDrawing=!1,this.selectedDrawing=null,this.currentDrawing=null,this.isEditing=!1,this.t=!1,this.setActiveTool(null),this.stockChart&&"function"==typeof this.stockChart.setDrawingTool&&this.stockChart.setDrawingTool(null),this.saveDrawingsToIndexedDB())}async saveDrawingsToIndexedDB(){try{const t=this.stockChart.options?.chartName;if(!t)return;const i=this.drawings.map(t=>t.toJSON());await y.saveDrawings(t,i)}catch(t){}}async loadDrawingsFromIndexedDB(){try{const t=this.stockChart.options?.chartName;if(!t)return;const i=await y.loadDrawings(t);let s=i;0===i.length&&(s=await y.loadDrawingsAcrossTimeframes(t)),this.drawings=[],s.forEach(t=>{let i;switch(t.type){case"trend-line":case"horizontal-line":case"vertical-line":i=new m(10,t.type);break;case"rectangle":i=new b;break;case"fibonacci-retrace":i=new g(this.stockChart.options.theme);break;case"fibonacci-zoon":i=new x(this.stockChart.options.theme,10);break;default:return}i.fromJSON(t),this.drawings.push(i)}),this.stockChart&&this.stockChart.render()}catch(t){}}handleMouseDown(t){const i=this.stockChart.canvas.getBoundingClientRect(),s=t.clientX-i.left,e=t.clientY-i.top;if(this.activeTool)this.startDrawing(this.activeTool,s,e);else{if(this.trySelectPoint(s,e))return this.isEditing=!0,void(this.t=!0);this.selectedDrawing&&this.isNearDrawing(s,e,this.selectedDrawing)||(this.isEditing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.t=!1)}}handleTouchStart(t){if(t.preventDefault(),t.stopPropagation(),this.touchStartTime=Date.now(),this.touchMoved=!1,this.touchDistance=0,1===t.touches.length){const i=t.touches[0],{x:s,y:e}=this.o(i);if(this.activeTool)this.startDrawing(this.activeTool,s,e);else{this.touchTimeout&&(clearTimeout(this.touchTimeout),this.touchTimeout=null);const t=this.i()?20:10;if(this.trySelectPoint(s,e,t))return this.isEditing=!0,this.t=!0,void(window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(50));this.selectedDrawing&&this.isNearDrawing(s,e,this.selectedDrawing)||(this.touchTimeout=setTimeout(()=>{this.touchMoved||(this.isEditing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.t=!1,this.stockChart.render())},300))}this.lastTouchX=s,this.lastTouchY=e}else 2===t.touches.length&&this.isEditing&&this.completeDrawing()}handleTouchMove(t){if(t.preventDefault(),t.stopPropagation(),1===t.touches.length){const i=t.touches[0],{x:s,y:e}=this.o(i),n=s-this.lastTouchX,o=e-this.lastTouchY;this.touchDistance+=Math.sqrt(n*n+o*o),this.touchDistance>10&&(this.touchMoved=!0,this.touchTimeout&&(clearTimeout(this.touchTimeout),this.touchTimeout=null)),(this.isDrawing&&this.currentDrawing||this.isEditing&&this.selectedDrawing)&&requestAnimationFrame(()=>{this.continueDrawing({clientX:i.clientX,clientY:i.clientY})}),this.lastTouchX=s,this.lastTouchY=e}else 2===t.touches.length&&(this.isDrawing||this.isEditing)&&(this.touchMoved=!0)}handleTouchEnd(t){t.preventDefault(),t.stopPropagation();const i=Date.now()-this.touchStartTime;this.touchTimeout&&(clearTimeout(this.touchTimeout),this.touchTimeout=null),!this.touchMoved&&i<300?this.isEditing&&(this.completeDrawing(),window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(50)):(this.isDrawing||this.isEditing)&&this.completeDrawing(),this.touchStartTime=0,this.touchMoved=!1,this.touchDistance=0}async clearDrawings(t=!1){if(this.drawings=[],this.currentDrawing=null,this.isDrawing=!1,this.selectedDrawing=null,t)try{const t=this.stockChart.options?.chartName;t&&await y.saveDrawings(t,[])}catch(t){}}render(t){this.stockChart.plotLayoutManager&&this.stockChart.plotLayoutManager.getPlotLayout("main")&&(t.save(),t.lineJoin="round",t.lineCap="round",this.drawings.forEach(i=>{this.renderDrawing(t,i)}),this.currentDrawing&&this.isDrawing&&this.renderDrawing(t,this.currentDrawing),this.selectedDrawing&&this.renderControlPoints(t,this.selectedDrawing),t.restore())}renderControlPoints(t,i){const s=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!s)return;const e=this.stockChart.options.plots.find(t=>"main"===t.id);if(!e)return;const n=this.stockChart.calculatePriceRange(e,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);n&&i.points.forEach((e,o)=>{const h=(new f).getPixelCoordinates(e.time,e.price,s,this.stockChart.dataViewport,n.minPrice,n.maxPrice);if(h){if("fibonacci-zoon"===i.type){const t=s.width/this.stockChart.dataViewport.visibleCount;h.x+=t/2}const e=this.i(),n=e?8:4,a=e?2:1;e&&(t.beginPath(),t.arc(h.x,h.y,n+6,0,2*Math.PI),t.fillStyle="rgba(255, 255, 255, 0.2)",t.fill()),t.beginPath(),t.arc(h.x,h.y,n,0,2*Math.PI),t.fillStyle=o===this.selectedPoint?"#ff0000":"#ffffff",t.strokeStyle="#000000",t.lineWidth=a,t.fill(),t.stroke(),e&&(t.beginPath(),t.arc(h.x,h.y,2,0,2*Math.PI),t.fillStyle="#000000",t.fill())}})}renderDrawing(t,i){const{type:s,points:e,style:n}=i;switch(t.save(),s){case"trend-line":case"horizontal-line":case"vertical-line":this.renderLine(t,e,n,s);break;case"rectangle":this.renderRectangle(t,e,n);break;case"fibonacci-retrace":case"fibonacci-zoon":const o=this.stockChart.dataViewport.getVisibleStartEndTime();i.draw(t,this.stockChart.plotLayoutManager.getPlotLayout("main"),this.stockChart.dataViewport,this.stockChart.calculatePriceRange(this.stockChart.options.plots.find(t=>"main"===t.id),this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport).minPrice,this.stockChart.calculatePriceRange(this.stockChart.options.plots.find(t=>"main"===t.id),this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport).maxPrice,this.stockChart.currentTheme,o)}t.restore()}renderLine(t,i,s,e){if(i.length<2)return;const n=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!n)return;const o=this.stockChart.options.plots.find(t=>"main"===t.id);if(!o)return;const h=this.stockChart.calculatePriceRange(o,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!h)return;const a=new f,r=a.getPixelCoordinates(i[0].time,i[0].price,n,{...this.stockChart.dataViewport,getVisibleData:()=>this.stockChart.dataViewport.getVisibleData()},h.minPrice,h.maxPrice),l=a.getPixelCoordinates(i[1].time,i[1].price,n,{...this.stockChart.dataViewport,getVisibleData:()=>this.stockChart.dataViewport.getVisibleData()},h.minPrice,h.maxPrice),c=this.stockChart.dataViewport.getVisibleStartEndTime();if(c){const{startTime:t,endTime:s}=c;if(i[0].time<t&&i[1].time<t)return;if(i[0].time>s&&i[1].time>s)return}r&&l&&(t.strokeStyle=s.strokeStyle,t.lineWidth=s.lineWidth,t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(l.x,l.y),t.stroke())}renderRectangle(t,i,s){if(i.length<2)return;const e=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!e)return;const n=this.stockChart.options.plots.find(t=>"main"===t.id);if(!n)return;const o=this.stockChart.calculatePriceRange(n,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!o)return;const h=(new f).getPixelCoordinates(i[0].time,i[0].price,e,this.stockChart.dataViewport,o.minPrice,o.maxPrice),a=(new f).getPixelCoordinates(i[1].time,i[1].price,e,this.stockChart.dataViewport,o.minPrice,o.maxPrice),r=this.stockChart.dataViewport.getVisibleStartEndTime();if(r){const{startTime:t,endTime:s}=r;if(i[0].time<t&&i[1].time<t)return;if(i[0].time>s&&i[1].time>s)return}if(!h&&!a)return;const l=Math.min(h.x,a.x),c=Math.min(h.y,a.y),d=Math.abs(a.x-h.x),u=Math.abs(a.y-h.y);s.fillStyle&&(t.fillStyle=s.fillStyle,t.fillRect(l,c,d,u)),t.strokeStyle=s.strokeStyle,t.lineWidth=s.lineWidth,t.strokeRect(l,c,d,u)}isNearDrawing(t,i,s){const e=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!e)return!1;const n=this.stockChart.options.plots.find(t=>"main"===t.id);if(!n)return!1;const o=this.stockChart.calculatePriceRange(n,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!o)return!1;const h=s.points.map(t=>(new f).getPixelCoordinates(t.time,t.price,e,this.stockChart.dataViewport,o.minPrice,o.maxPrice)).filter(Boolean);if(h.length<2)return!1;switch(s.type){case"trend-line":case"fibonacci-retrace":return this.isPointNearLine(t,i,h,10);case"rectangle":return this.isPointInRectangle(t,i,h);default:return!1}}isPointNearLine(t,i,s,e){if(s.length<2)return!1;const[n,o]=s;return this.pointToLineDistance(t,i,n.x,n.y,o.x,o.y)<=e}isPointInRectangle(t,i,s){if(s.length<2)return!1;const e=Math.min(s[0].x,s[1].x),n=Math.min(s[0].y,s[1].y),o=Math.abs(s[1].x-s[0].x),h=Math.abs(s[1].y-s[0].y);return t>=e&&t<=e+o&&i>=n&&i<=n+h}pointToLineDistance(t,i,s,e,n,o){const h=n-s,a=o-e,r=h*h+a*a;let l,c,d=-1;0!==r&&(d=((t-s)*h+(i-e)*a)/r),d<0?(l=s,c=e):d>1?(l=n,c=o):(l=s+d*h,c=e+d*a);const u=t-l,p=i-c;return Math.sqrt(u*u+p*p)}isNearDrawingPoint(t,i,s,e=10){const n=this.stockChart.plotLayoutManager.getPlotLayout("main");if(!n)return null;const o=this.stockChart.options.plots.find(t=>"main"===t.id);if(!o)return null;const h=this.stockChart.calculatePriceRange(o,this.stockChart.dataViewport.getVisibleData(),this.stockChart.dataViewport);if(!h)return null;for(let o=0;o<s.points.length;o++){const a=s.points[o],r=(new f).getPixelCoordinates(a.time,a.price,n,this.stockChart.dataViewport,h.minPrice,h.maxPrice);if(r){let n;if(n="fibonacci-zoon"===s.type?Math.abs(t-r.x):Math.sqrt(Math.pow(t-r.x,2)+Math.pow(i-r.y,2)),n<=e)return{pointIndex:o,drawing:s}}}return null}trySelectPoint(t,i,s=10){for(const e of this.drawings){const n=this.isNearDrawingPoint(t,i,e,s);if(n)return this.selectedDrawing=n.drawing,this.selectedPoint=n.pointIndex,this.isEditing=!0,!0}return!1}exportDrawings(){return JSON.stringify(this.drawings)}importDrawings(t){try{const i=JSON.parse(t);this.drawings=i}catch(t){}}showIndicatorSettings(t={}){const{indicatorId:i,settings:s,plotId:e}=t;this.indicators=[{name:"SMA",id:"sma",settings:[{key:"period",label:"Period",type:"number",default:20,min:1,max:200},{key:"priceType",label:"Price Type",type:"select",default:"close",options:[{value:"close",label:"Close"},{value:"hlc/3",label:"HLC/3"},{value:"ohlc/4",label:"OHLC/4"},{value:"hlcc/4",label:"HLCC/4"}]},{key:"lineColor",label:"Line Color",type:"color",default:"#2196F3"}]},{name:"EMA",id:"ema",settings:[{key:"period",label:"Period",type:"number",default:20,min:1,max:200},{key:"priceType",label:"Price Type",type:"select",default:"close",options:[{value:"close",label:"Close"},{value:"hlc/3",label:"HLC/3"},{value:"ohlc/4",label:"OHLC/4"},{value:"hlcc/4",label:"HLCC/4"}]},{key:"lineColor",label:"Line Color",type:"color",default:"#FF9800"}]},{name:"RSI",id:"rsi",settings:[{key:"period",label:"Period",type:"number",default:14,min:2,max:100},{key:"priceType",label:"Price Type",type:"select",default:"close",options:[{value:"close",label:"Close"},{value:"hlc/3",label:"HLC/3"},{value:"ohlc/4",label:"OHLC/4"},{value:"hlcc/4",label:"HLCC/4"}]},{key:"lineColor",label:"RSI Line Color",type:"color",default:"#9C27B0"}]},{id:"macd",name:"MACD",plots:[{name:"MACD Line",type:"line"},{name:"Signal Line",type:"line"},{name:"Histogram",type:"histogram"}],settings:[{key:"fastPeriod",label:"Fast Period",type:"number",default:12,min:1,max:50},{key:"slowPeriod",label:"Slow Period",type:"number",default:26,min:1,max:100},{key:"signalPeriod",label:"Signal Period",type:"number",default:9,min:1,max:50},{key:"priceType",label:"Price Type",type:"select",default:"close",options:[{value:"close",label:"Close"},{value:"hlc/3",label:"HLC/3"},{value:"ohlc/4",label:"OHLC/4"},{value:"hlcc/4",label:"HLCC/4"}]},{key:"macdColor",label:"MACD Line Color",type:"color",default:"#2196F3"},{key:"signalColor",label:"Signal Line Color",type:"color",default:"#FF9800"},{key:"histogramColor",label:"Histogram Color",type:"color",default:"#4CAF50"}]},{name:"Bollinger Bands",id:"bollinger",settings:[{key:"period",label:"Period",type:"number",default:20,min:2,max:100},{key:"stdDev",label:"Standard Deviation",type:"number",default:2,min:.1,max:5,step:.001},{key:"priceType",label:"Price Type",type:"select",default:"close",options:[{value:"close",label:"Close"},{value:"hlc/3",label:"HLC/3"},{value:"ohlc/4",label:"OHLC/4"},{value:"hlcc/4",label:"HLCC/4"}]},{key:"upperBandColor",label:"Upper Band Color",type:"color",default:"#3F51B5"},{key:"middleBandColor",label:"Middle Band Color",type:"color",default:"#2196F3"},{key:"lowerBandColor",label:"Lower Band Color",type:"color",default:"#3F51B5"}]},{name:"DeMarker",id:"demarker",settings:[{key:"period",label:"Period",type:"number",default:14,min:1,max:100},{key:"lineColor",label:"DeMarker Line Color",type:"color",default:"#607D8B"}]}];const n=document.createElement("div");n.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background-color: rgba(0, 0, 0, 0.5);\n            z-index: 1000;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ";const o=this.stockChart.currentTheme,h="dark"===o.name||o.background&&w(o.background),a=document.createElement("div");a.style.cssText=`\n            background-color: ${o.background||"#ffffff"};\n            border-radius: 8px;\n            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);\n            width: 650px;\n            max-width: 90vw;\n            max-height: 80vh;\n            overflow: hidden;\n            font-family: Arial, sans-serif;\n            color: ${o.textColor||"#333333"};\n        `,a.innerHTML=`\n            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid ${o.gridColor||"#e0e0e0"}; background-color: ${h?o.chartAreaBackground||"#2c2c2c":"#f8f9fa"};">\n                <h3 style="margin: 0; color: ${o.textColor||"#333"}; font-size: 18px;">Chart Settings</h3>\n            </div>\n            \n            <div class="main-tab-container" style="display: flex; border-bottom: 1px solid ${o.gridColor||"#e0e0e0"}; background-color: ${h?o.chartAreaBackground||"#2c2c2c":"#f8f9fa"};">\n                <button class="main-tab-btn active" data-group="settings" style="\n                    flex: 1;\n                    padding: 12px 16px;\n                    border: none;\n                    background: ${h?o.chartAreaBackground||"#2c2c2c":"white"};\n                    color: ${o.textColor||"#333"};\n                    cursor: pointer;\n                    border-bottom: 2px solid #007bff;\n                    font-weight: 500;\n                    font-size: 15px;\n                ">Settings</button>\n                <button class="main-tab-btn" data-group="indicators" style="\n                    flex: 1;\n                    padding: 12px 16px;\n                    border: none;\n                    background: transparent;\n                    color: ${h?"#aaa":"#666"};\n                    cursor: pointer;\n                    border-bottom: 2px solid transparent;\n                    font-weight: 500;\n                    font-size: 15px;\n                ">Indicators</button>\n            </div>\n\n            <div id="settings-group" class="tab-group active" style="display: block;">\n                <div class="sub-tab-container" style="display: flex; border-bottom: 1px solid ${o.gridColor||"#e0e0e0"}; background-color: ${h?o.chartAreaBackground||"#2c2c2c":"#f8f9fa"}; overflow-x: auto;">\n                    <button class="tab-btn active" data-tab="theme" style="\n                        flex: 0 0 auto;\n                        padding: 12px 16px;\n                        border: none;\n                        background: ${h?o.chartAreaBackground||"#2c2c2c":"white"};\n                        color: ${o.textColor||"#333"};\n                        cursor: pointer;\n                        border-bottom: 2px solid #007bff;\n                        font-weight: 500;\n                        white-space: nowrap;\n                        min-width: 80px;\n                    ">Theme</button>\n                </div>\n            </div>\n\n            <div id="indicators-group" class="tab-group" style="display: none;">\n                <div class="sub-tab-container" style="display: flex; border-bottom: 1px solid ${o.gridColor||"#e0e0e0"}; background-color: ${h?o.chartAreaBackground||"#2c2c2c":"#f8f9fa"}; overflow-x: auto;">\n                    ${this.indicators.map((t,i)=>`\n                        <button class="tab-btn ${0===i?"active":""}" data-tab="${t.id}" style="\n                            flex: 0 0 auto;\n                            padding: 12px 16px;\n                            border: none;\n                            background: ${0===i?h?o.chartAreaBackground||"#2c2c2c":"white":"transparent"};\n                            color: ${0===i?o.textColor||"#333":h?"#aaa":"#666"};\n                            cursor: pointer;\n                            border-bottom: 2px solid ${0===i?"#007bff":"transparent"};\n                            font-weight: 500;\n                            white-space: nowrap;\n                            min-width: 80px;\n                        ">${t.name}</button>\n                    `).join("")}\n                </div>\n            </div>\n            \n            <div class="tab-content" style="padding: 20px; max-height: min(450px, calc(80vh - 200px)); overflow-y: auto; background-color: ${o.background||"#ffffff"};">\n                <div id="theme-tab" class="tab-pane active" style="display: block;">\n                    <div class="theme-settings">\n                        <h4 style="margin: 0 0 20px 0; color: ${o.textColor||"#333"}; font-size: 16px;">Theme Settings</h4>\n                        <form class="settings-form" id="theme-form">\n                            <div class="form-group" style="margin-bottom: 16px;">\n                                <label style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Theme Type</label>\n                                <select name="themeType" style="width: 100%; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                    <option value="dark">Dark Theme</option>\n                                    <option value="light">Light Theme</option>\n                                    <option value="custom">Custom Theme</option>\n                                </select>\n                            </div>\n                            <div id="custom-theme-controls" style="display: none;">\n                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">\n                                    <div class="form-group">\n                                        <label for="background" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Background:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="background" value="#1A1A1D" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="background_hex" value="#1A1A1D" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="chartAreaBackground" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Chart Area:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="chartAreaBackground" value="#292930" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="chartAreaBackground_hex" value="#292930" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="textColor" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Text:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="textColor" value="#C5C6C7" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="textColor_hex" value="#C5C6C7" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="gridColor" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Grid:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="gridColor" value="#4E4E50" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="gridColor_hex" value="#4E4E50" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="lineColor" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Line:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="lineColor" value="#66FCF1" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="lineColor_hex" value="#66FCF1" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="positiveColor" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Positive:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="positiveColor" value="#45A29E" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="positiveColor_hex" value="#45A29E" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="negativeColor" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Negative:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="negativeColor" value="#C5433D" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="negativeColor_hex" value="#C5433D" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="candleUp" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Candle Up:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="candleUp" value="#45A29E" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="candleUp_hex" value="#45A29E" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                    <div class="form-group">\n                                        <label for="candleDown" style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">Candle Down:</label>\n                                        <div style="display: flex; align-items: center; gap: 10px;">\n                                            <input type="color" name="candleDown" value="#C5433D" style="width: 50px; height: 35px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; cursor: pointer; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; padding: 2px;">\n                                            <input type="text" name="candleDown_hex" value="#C5433D" maxlength="7" style="flex: 1; padding: 8px 12px; border: 1px solid ${o.gridColor||"#ddd"}; border-radius: 4px; font-size: 14px; font-family: monospace; background: ${h?o.chartAreaBackground||"#2c2c2c":"white"}; color: ${o.textColor||"#333"};">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="form-actions" style="margin-top: 24px; display: flex; gap: 12px;">\n                                <button type="submit" class="apply-theme-btn" style="background: #00c2ff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">Apply Theme</button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n                ${this.indicators.map((t,i)=>`\n                    <div id="${t.id}-tab" class="tab-pane" style="display: none;">\n                        <div class="indicator-settings">\n                            <h4 style="margin: 0 0 20px 0; color: ${o.textColor||"#333"}; font-size: 16px;">${t.name} Settings</h4>\n                            \n                            <form class="settings-form" data-indicator="${t.id}">\n                                ${t.settings.map(i=>"select"===i.type?`\n                                            <div class="form-group" style="margin-bottom: 16px;">\n                                                <label style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">${i.label}</label>\n                                                <select name="${i.key}" style="\n                                                    width: 100%;\n                                                    padding: 8px 12px;\n                                                    border: 1px solid ${o.gridColor||"#ddd"};\n                                                    border-radius: 4px;\n                                                    font-size: 14px;\n                                                    background: ${h?o.chartAreaBackground||"#2c2c2c":"white"};\n                                                    color: ${o.textColor||"#333"};\n                                                ">\n                                                    ${i.options.map(t=>`\n                                                        <option value="${t.value}" ${t.value===i.default?"selected":""}>${t.label}</option>\n                                                    `).join("")}\n                                                </select>\n                                            </div>\n                                        `:"color"===i.type?`\n                                            <div class="form-group" style="margin-bottom: 16px;">\n                                                <label style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">${i.label}</label>\n                                                <div style="display: flex; align-items: center; gap: 10px;">\n                                                    <input \n                                                        type="color" \n                                                        name="${i.key}" \n                                                        value="${i.default}" \n                                                        id="${t.id}-${i.key}"\n                                                        style="\n                                                            width: 50px;\n                                                            height: 35px;\n                                                            border: 1px solid ${o.gridColor||"#ddd"};\n                                                            border-radius: 4px;\n                                                            cursor: pointer;\n                                                            background: ${h?o.chartAreaBackground||"#2c2c2c":"white"};\n                                                            padding: 2px;\n                                                        "\n                                                    />\n                                                    <input \n                                                        type="text" \n                                                        name="${i.key}_hex"\n                                                        value="${i.default}" \n                                                        placeholder="#RRGGBB"\n                                                        maxlength="7"\n                                                        style="\n                                                            flex: 1;\n                                                            padding: 8px 12px;\n                                                            border: 1px solid ${o.gridColor||"#ddd"};\n                                                            border-radius: 4px;\n                                                            font-size: 14px;\n                                                            font-family: monospace;\n                                                            box-sizing: border-box;\n                                                            background: ${h?o.chartAreaBackground||"#2c2c2c":"white"};\n                                                            color: ${o.textColor||"#333"};\n                                                        "\n                                                    />\n                                                    ${i.opacity?`\n                                                        <div style="display: flex; align-items: center; gap: 5px; min-width: 80px;">\n                                                            <label style="font-size: 12px; color: ${h?"#aaa":"#666"};">Opacity:</label>\n                                                            <input \n                                                                type="range" \n                                                                name="${i.key}_opacity"\n                                                                min="0" \n                                                                max="1" \n                                                                step="0.1" \n                                                                value="0.3"\n                                                                style="width: 60px;"\n                                                            />\n                                                            <span class="opacity-value" style="font-size: 11px; color: ${h?"#aaa":"#666"}; min-width: 25px;">0.3</span>\n                                                        </div>\n                                                    `:""}\n                                                </div>\n                                            </div>\n                                        `:`\n                                            <div class="form-group" style="margin-bottom: 16px;">\n                                                <label style="display: block; margin-bottom: 6px; color: ${o.textColor||"#333"}; font-weight: 500; font-size: 14px;">${i.label}</label>\n                                                <input \n                                                    type="${i.type}" \n                                                    name="${i.key}" \n                                                    value="${i.default}" \n                                                    id="${t.id}-${i.key}"\n                                                    ${i.min?`min="${i.min}"`:""}\n                                                    ${i.max?`max="${i.max}"`:""}\n                                                    ${i.step?`step="${i.step}"`:""}\n                                                    style="\n                                                        width: 100%;\n                                                        padding: 8px 12px;\n                                                        border: 1px solid ${o.gridColor||"#ddd"};\n                                                        border-radius: 4px;\n                                                        font-size: 14px;\n                                                        box-sizing: border-box;\n                                                        background: ${h?o.chartAreaBackground||"#2c2c2c":"white"};\n                                                        color: ${o.textColor||"#333"};\n                                                    "\n                                                />\n                                            </div>\n                                        `).join("")}\n                                \n                                <div class="form-actions" style="margin-top: 24px; display: flex; gap: 12px;">\n                                    <button type="submit" class="add-indicator-btn" id="add-indicator-btn" style="\n                                        background: #00c2ff;\n                                        color: white;\n                                        border: none;\n                                        padding: 10px 20px;\n                                        border-radius: 4px;\n                                        cursor: pointer;\n                                        font-size: 14px;\n                                        font-weight: 500;\n                                    ">${this.editPlotId?"Update Indicator":"â Add Indicator"}</button>\n                                </div>\n                            </form>\n                            \n                            <div class="active-instances" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid ${o.gridColor||"#e0e0e0"};">\n                                <h5 style="margin: 0 0 12px 0; color: ${o.textColor||"#333"}; font-size: 14px;">Active ${t.name} Instances</h5>\n                                <div id="${t.id}-instances" class="instances-list">\n                                    \x3c!-- Active instances will be populated here --\x3e\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n            \n            <div class="modal-footer" style="\n                padding: 16px 20px;\n                border-top: 1px solid ${o.gridColor||"#e0e0e0"};\n                background-color: ${h?o.chartAreaBackground||"#2c2c2c":"#f8f9fa"};\n                display: flex;\n                justify-content: center;\n                align-items: center;\n            ">\n\n                <button id="close-indicator-settings" style="\n                    background: #6c757d;\n                    color: white;\n                    border: none;\n                    padding: 8px 20px;\n                    border-radius: 4px;\n                    cursor: pointer;\n                    font-size: 14px;\n                ">Close</button>\n            </div>\n        `,n.appendChild(a),document.body.appendChild(n),this.initializeIndicatorDialog(n,this.indicators,{editIndicatorId:i,editSettings:s,editPlotId:e})}getMainPlotStockData(){return this.stockChart.options.plots.find(t=>"main"===t.id).data}initializeIndicatorDialog(t,i,s={}){const{editIndicatorId:e,editSettings:n}=s,o=t.querySelector("div");this.setupColorPickerSync(o);const h=o.querySelector('select[name="themeType"]'),a=o.querySelector("#custom-theme-controls");h.value=this.stockChart.options.theme||"dark","custom"===h.value&&(a.style.display="block",Object.entries(this.stockChart.currentTheme).forEach(([t,i])=>{const s=o.querySelector(`input[name="${t}"]`),e=o.querySelector(`input[name="${t}_hex"]`);s&&e&&(s.value=i,e.value=i)})),h.addEventListener("change",t=>{const i=t.target.value;a.style.display="custom"===i?"block":"none"});const r=o.querySelector("#theme-form");r.addEventListener("submit",t=>{t.preventDefault();const i=new FormData(r),s=i.get("themeType");if("custom"===s){const t={};i.forEach((i,s)=>{s.endsWith("_hex")||(t[s]=i)}),this.stockChart.applyTheme(t)}else this.stockChart.applyTheme(s);const e=r.querySelector(".apply-theme-btn");e.textContent="â Theme Applied",e.style.background="#28a745",setTimeout(()=>{e.textContent="Apply Theme",e.style.background="#00c2ff"},2e3)});const l=o.querySelectorAll(".main-tab-btn"),c=o.querySelectorAll(".tab-group");l.forEach(t=>{t.addEventListener("click",()=>{const i=this.stockChart.currentTheme,s="dark"===i.name||i.background&&w(i.background);l.forEach(t=>{t.classList.remove("active"),t.style.background="transparent",t.style.color=s?"#aaa":"#666",t.style.borderBottomColor="transparent"}),c.forEach(t=>{t.classList.remove("active"),t.style.display="none"}),o.querySelectorAll(".tab-pane").forEach(t=>{t.classList.remove("active"),t.style.display="none"}),o.querySelectorAll(".tab-btn").forEach(t=>{t.classList.remove("active"),t.style.background="transparent",t.style.color=s?"#aaa":"#666",t.style.borderBottomColor="transparent"}),t.classList.add("active"),t.style.background=s?i.chartAreaBackground||"#2c2c2c":"white",t.style.color=i.textColor||"#333",t.style.borderBottomColor="#007bff";const e=t.dataset.group+"-group",n=o.querySelector(`#${e}`);if(n){n.classList.add("active"),n.style.display="block";const e=n.querySelector(".tab-btn"),h=e?.dataset.tab;if(e&&h){e.classList.add("active"),e.style.background=s?i.chartAreaBackground||"#2c2c2c":"white",e.style.color=i.textColor||"#333",e.style.borderBottomColor="#007bff";const n=o.querySelector(`#${h}-tab`);n&&(n.classList.add("active"),n.style.display="block"),"indicators"===t.dataset.group&&h&&this.updateInstancesList(h)}}})});const d=o.querySelectorAll(".tab-btn");if(o.querySelectorAll(".tab-pane"),d.forEach(t=>{t.addEventListener("click",()=>{const i=this.stockChart.currentTheme,s="dark"===i.name||i.background&&w(i.background),e=t.closest(".tab-group");if(!e)return;const n=e.querySelectorAll(".tab-btn");o.querySelectorAll(".tab-pane").forEach(t=>{t.classList.remove("active"),t.style.display="none"}),n.forEach(t=>{t.classList.remove("active"),t.style.background="transparent",t.style.color=s?"#aaa":"#666",t.style.borderBottomColor="transparent"}),t.classList.add("active"),t.style.background=s?i.chartAreaBackground||"#2c2c2c":"white",t.style.color=i.textColor||"#333",t.style.borderBottomColor="#007bff";const h=o.querySelector(`#${t.dataset.tab}-tab`);if(h&&(h.classList.add("active"),h.style.display="block"),"theme"!==t.dataset.tab&&this.updateInstancesList(t.dataset.tab),"theme"!==t.dataset.tab){const t=h.querySelector("form");if(t){t.reset();const i=t.querySelector(".add-indicator-btn");i&&(i.textContent="â Add Indicator",i.style.background="#00c2ff")}}})}),o.addEventListener("submit",t=>{t.preventDefault();const s=t.target;if(!s.dataset.indicator)return;const e=s.dataset.indicator,n=new FormData(s),o={};for(let[t,s]of n.entries()){if(t.endsWith("_hex"))continue;const n=i.find(t=>t.id===e).settings.find(i=>i.key===t);n&&"number"===n.type?o[t]=parseFloat(s):o[t]=s}this.addIndicatorWithSettings(e,o),this.updateInstancesList(e);const h=s.querySelector(".add-indicator-btn");h.textContent="â Successfully",h.style.background="#28a745",setTimeout(()=>{h.textContent="â Add Indicator",h.style.background="#00c2ff"},2e3)}),o.addEventListener("click",t=>{if(t.target.classList.contains("remove-instance-btn")){const i=t.target.dataset.plotId,s=t.target.dataset.indicatorId;this.removeIndicator(i),this.updateInstancesList(s)}if(t.target.classList.contains("edit-instance-btn")){const i=t.target.dataset.plotId;this.editIndicatorInstance(i);const s=document.getElementById("add-indicator-btn");s&&(s.textContent="âï¸ Update Indicator")}}),o.querySelector("#close-indicator-settings").addEventListener("click",()=>{document.body.removeChild(t),this.resetDrawingStates()}),t.addEventListener("click",i=>{i.target===t&&(document.body.removeChild(t),this.resetDrawingStates())}),i.forEach(t=>{this.updateInstancesList(t.id)}),e&&n){const t=o.querySelector(`.tab-btn[data-tab="${e}"]`);t&&t.click();const i=o.querySelector(`#${e}-tab .settings-form`);if(i)for(const t in n){const s=i.querySelector(`[name="${t}"]`);if(s){s.value=n[t];const e=i.querySelector(`[name="${t}_hex"]`);e&&(e.value=n[t])}}}}setupColorPickerSync(t){t.addEventListener("input",i=>{const s=i.target;if("color"===s.type){const i=t.querySelector(`[name="${s.name}_hex"]`);i&&(i.value=s.value.toUpperCase())}if(s.name&&s.name.endsWith("_hex")){const i=s.name.replace("_hex",""),e=t.querySelector(`[name="${i}"]`);e&&this.isValidHex(s.value)&&(e.value=s.value)}if("range"===s.type&&s.name.includes("opacity")){const t=s.parentElement.querySelector(".opacity-value");t&&(t.textContent=s.value)}}),t.addEventListener("blur",t=>{const i=t.target;i.name&&i.name.endsWith("_hex")&&(this.isValidHex(i.value)?(i.style.borderColor="#ddd",i.title=""):(i.style.borderColor="#dc3545",i.title="Invalid hex color format. Use #RRGGBB"))},!0)}isValidHex(t){return/^#[0-9A-Fa-f]{6}$/.test(t)}updateInstancesList(t){const i=document.querySelector(`#${t}-instances`);if(!i)return;const s=this.getIndicatorInstances(t);if(this.indicators.find(i=>i.id===t),0===s.length)i.innerHTML=`\n                <div style="color: #666; font-style: italic; padding: 12px; text-align: center; border: 1px dashed #ddd; border-radius: 4px;">\n                    No ${t.toUpperCase()} instances added yet\n                </div>\n            `;else{const e=[];new Set(s.map(t=>t.name)).forEach(t=>{const i=s.find(i=>i.name===t);i&&e.push(i)});const n=w?"#333":"#f9f9f9",o=w?"#555":"#e0e0e0",h=w?"#f9f9f9":"#333",a=w?"#bbb":"#666";i.innerHTML=e.map(i=>`\n                <div class="instance-item" style="\n                    display: flex;\n                    align-items: center;\n                    justify-content: space-between;\n                    padding: 10px 12px;\n                    border: 1px solid ${o};\n                    border-radius: 4px;\n                    margin-bottom: 8px;\n                    background: ${n};\n                ">\n                    <div style="flex: 1;">\n                        <div style="font-weight: 500; color: ${h}; font-size: 13px; display: flex; align-items: center; gap: 8px;">\n                            ${i.name}\n                            ${this.getColorIndicatorsForInstance(i)}\n                        </div>\n                        <div style="color: ${a}; font-size: 11px;">${this.formatInstances(i)}</div>\n                    </div>\n                    <div style="display: flex; gap: 6px;">\n                        <button class="edit-instance-btn" data-plot-id="${i.plotId}" style="\n                            background: #ffc107;\n                            color: #212529;\n                            border: none;\n                            padding: 4px 8px;\n                            border-radius: 3px;\n                            cursor: pointer;\n                            font-size: 11px;\n                        ">Edit</button>\n                        <button class="remove-instance-btn" data-plot-id="${i.plotId}" data-indicator-id="${t}" style="\n                            background: #dc3545;\n                            color: white;\n                            border: none;\n                            padding: 4px 8px;\n                            border-radius: 3px;\n                            cursor: pointer;\n                            font-size: 11px;\n                        ">Remove</button>\n                    </div>\n                </div>\n            `).join("")}}getColorIndicatorsForInstance(t){return Object.entries(t.settings).filter(([t,i])=>t.toLowerCase().includes("color")&&"string"==typeof i&&i.startsWith("#")).map(([t,i])=>`\n            <div style="\n                width: 12px; \n                height: 12px; \n                background-color: ${i}; \n                border: 1px solid #ccc; \n                border-radius: 2px;\n                display: inline-block;\n                margin-right: 2px;\n                title: '${t}: ${i}'\n            "></div>\n        `).join("")}formatInstances({settings:t}){return Object.entries(t).filter(([t,i])=>!t.toLowerCase().includes("color")&&!t.includes("opacity")).map(([t,i])=>`${t}: ${i}`).join(", ")}getIndicatorInstances(t){return this.stockChart&&this.stockChart.options&&this.stockChart.options.plots?this.stockChart.options.plots.filter(i=>i.indicator&&i.indicator.id===t).map(t=>({name:t.indicator.name,plotId:t.id,settings:t.indicator.settings||{}})):[]}addIndicatorWithSettings(t,i){this.editPlotId&&this.removeIndicator(this.editPlotId);let s=this.getIndicatorDisplayName(t);i.period&&(s+=` (${i.period})`),this.stockChart.options.plots||(this.stockChart.options.plots=[]);const e=this.getValueSelector(i.priceType||"close");let n=[];const o=this.getMainPlotStockData();switch(t){case"sma":n=function(t,i,s=t=>t.close){let e=l(i);const n=[];for(const i of t){const t=c(s(i),e);n.push({time:i.time,value:t.value}),e=t.state}return n}(o,i.period,e);break;case"bollinger":n=function(t,i,s=2,e=t=>t.close){let n=function(t=20,i=2){return{period:t,multiplier:i,window:[],sum:0,sumSquares:0}}(i,s),o=l(i);const h=[];for(const i of t){const t=u(e(i),n),s=c(e(i),o);h.push({time:i.time,upper:t.upper,lower:t.lower,middle:s.value}),n=t.state,o=s.state}return h}(o,i.period,i.standardDeviationMultiplier,e);break;case"demarker":n=function(t,i=14){let s=function(t=14){return{period:t,prevHigh:null,prevLow:null,demaxSMA:l(t),deminSMA:l(t)}}(i);const e=[];for(const i of t){const t=p(i.high,i.low,s);e.push({time:i.time,value:t.demarker}),s=t.state}return e}(o,i.period);break;case"macd":n=function(t,i=12,s=26,e=9,n=t=>t.close){let o=function(t=12,i=26,s=9){return{fast:h(t),slow:h(i),signal:h(s)}}(i,s,e);const a=[];for(const i of t){const t=r(n(i),o);a.push({time:i.time,macd:t.macdLine,signal:t.signalLine,histogram:t.histogram}),o=t.state}return a}(o,i.fastPeriod,i.slowPeriod,i.signalPeriod,e);break;case"ema":n=function(t,i,s=t=>t.close){let e=h(i);const n=[];for(const i of t){const t=a(s(i),e);n.push({time:i.time,value:t.value}),e=t.state}return n}(o,i.period,e);break;case"rsi":n=function(t,i=14,s=t=>t.close){let e=function(t=14){return{period:t,gains:[],losses:[],avgGain:0,avgLoss:0,lastPrice:null}}(i);const n=[];for(const i of t){const t=d(s(i),e);n.push({time:i.time,value:t.value}),e=t.state}return n}(o,i.period,e)}const f=this.stockChart.options.plots?.length||1;this.getPlotsByIndicatorId(t,n,f,i).forEach((e,n)=>{e.indicator={id:t,settings:i,name:s};const o=this.stockChart.options.plots.findIndex(t=>t.id===e.id&&t.targetId===e.targetId);o>-1?this.stockChart.options.plots[o]=e:this.stockChart.options.plots.push(e),"main"===e.id||this.stockChart.plotLayoutManager.updatePlotIndicator(e,"add")}),this.stockChart.render();const m=JSON.parse(localStorage.getItem("asv-chart-indicator-settings"))||[];let b;b=["sma","ema"].includes(t)?m.findIndex(s=>s.id===t&&s.settings.period===i.period):m.findIndex(i=>i.id===t),b>-1?m[b].settings=i:m.push({id:t,settings:i}),localStorage.setItem("asv-chart-indicator-settings",JSON.stringify(m)),this.editPlotId=null}getValueSelector(t){switch(t){case"hlc/3":return t=>(t.high+t.low+t.close)/3;case"ohlc/4":return t=>(t.open+t.high+t.low+t.close)/4;case"hlcc/4":return t=>(t.high+t.low+2*t.close)/4;default:return t=>t.close}}getPlotsByIndicatorId(t,i,s,e){const n=[];switch(t){case"macd":n.push({id:"macd",type:"line",heightRatio:.15,data:i.map(t=>({time:t.time,value:t.macd})),keyLabel:"MACD",style:{lineColor:e.macdColor,lineWidth:3}}),n.push({id:"signal",type:"line",data:i.map(t=>({time:t.time,value:t.signal})),overlay:!0,targetId:"macd",keyLabel:"Signal",style:{lineColor:e.signalColor,lineWidth:1.5}}),n.push({id:"histogram",type:"histogram",data:i.map(t=>({time:t.time,value:t.histogram})),overlay:!0,targetId:"macd",keyLabel:"Histogram",style:{positiveColor:"rgba(0, 150, 136, 0.5)",negativeColor:"rgba(233, 30, 99, 0.5)"}});break;case"rsi":n.push({id:"rsi",type:"line",heightRatio:.15,data:i,keyLabel:"RSI",style:{lineColor:e.lineColor,lineWidth:1.5}});break;case"sma":n.push({id:"sma"+s,type:"line",data:i,targetId:"main",keyLabel:"SMA",overlay:!0,style:{lineColor:e.lineColor,lineWidth:1.5}});break;case"ema":n.push({id:"ema"+s,type:"line",heightRatio:.15,targetId:"main",data:i,keyLabel:"EMA",overlay:!0,style:{lineColor:e.lineColor,lineWidth:1.5}});break;case"bollinger":n.push({id:"bollinger",type:"line",heightRatio:.15,targetId:"main",data:i.map(t=>({time:t.time,value:t.upper})),overlay:!0,keyLabel:"Bollinger Bands",style:{lineColor:e.upperBandColor,lineWidth:1.5}}),n.push({id:"bollinger_lower",type:"line",heightRatio:.15,data:i.map(t=>({time:t.time,value:t.lower})),overlay:!0,targetId:"main",keyLabel:"Bollinger Bands",style:{lineColor:e.lowerBandColor,lineWidth:1.5}}),n.push({id:"bollinger_middle",type:"line",heightRatio:.15,data:i.map(t=>({time:t.time,value:t.middle})),overlay:!0,targetId:"main",keyLabel:"Bollinger Bands",style:{lineColor:e.middleBandColor,lineWidth:1.5}});break;case"demarker":n.push({id:"demarker",type:"line",heightRatio:.15,data:i,keyLabel:"DeMarker",style:{lineColor:e.lineColor,lineWidth:1.5}})}return n}previewIndicator(t,i){const s=Object.entries(i).map(([t,i])=>`${t}: ${i}`).join("\n");alert(`Preview ${this.getIndicatorDisplayName(t)}:\n\n${s}`)}editIndicatorInstance(t){const i=this.stockChart.options.plots.find(i=>i.id===t);if(!i||!i.indicator)return;const{id:s,settings:e}=i.indicator;Object.entries(e).forEach(([t,i])=>{const e=document.getElementById(`${s}-${t}`);e&&(e instanceof HTMLInputElement||e instanceof HTMLSelectElement)&&(e.value=i)}),this.editPlotId=t}removeIndicator(t){if(this.stockChart.options.plots){const i=this.stockChart.options.plots.find(i=>i.id===t),s=this.stockChart.options.plots.filter(i=>i.indicator?.id===t),e=[i.id,...s.map(t=>t.id)];if(this.stockChart.options.plots=this.stockChart.options.plots.filter(t=>!e.includes(t.id)),this.stockChart.plotLayoutManager.updatePlotConfigurations(this.stockChart.options.plots),this.stockChart.plotLayoutManager.calculateLayout(),this.stockChart.render(),i&&i.indicator){const t=(JSON.parse(localStorage.getItem("asv-chart-indicator-settings"))||[]).filter(t=>t.id!==i.indicator.id);localStorage.setItem("asv-chart-indicator-settings",JSON.stringify(t))}}}resetDrawingStates(){this.isDrawing=!1,this.selectedDrawing=null,this.selectedPoint=null,this.isEditing=!1,this.t=!1,this.currentDrawing=null,this.stockChart&&this.stockChart.setDrawingTool&&this.stockChart.setDrawingTool(null),this.stockChart&&this.stockChart.render&&this.stockChart.render()}getIndicatorDisplayName(t){return{bollinger:"Bollinger Bands",demarker:"DeMarker",ema:"EMA",macd:"MACD",rsi:"RSI",sma:"SMA"}[t]||t.toUpperCase()}}const M="weekly",$=t=>{const i=new Date(t),s=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())),e=s.getUTCFullYear(),n=new Date(Date.UTC(e,0,1)).getUTCDay(),o=0===n?0:7-n,h=new Date(Date.UTC(e,0,1+o));if(s.getTime()<h.getTime())return $(new Date(Date.UTC(e-1,11,31)));const a=Math.floor((s.getTime()-h.getTime())/864e5),r=Math.floor(a/7)+1,l=new Date(Date.UTC(e,11,31)).getUTCDay(),c=6===l?7:l+1;return 11===s.getMonth()&&s.getUTCDate()>31-c&&c<4?{year:e+1,numberOfWeek:1}:{year:e,numberOfWeek:r}},k=(t,i)=>{const s=new Date(t),e=new Date(i);return s.getFullYear()===e.getFullYear()&&s.getMonth()===e.getMonth()};class C{static init(t,i){const s=document.getElementById(t);if(!s)return;const e=new C(s,i);return e.render(),e.loadIndicatorSettings(),e}constructor(t,i){this.ensureContainerSize(t),this.container=t,this.options=C.ensureValidOptions(i),this.updateStockData=this.updateStockData.bind(this),this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.wrapper.style.display="flex",this.wrapper.style.width="100%",this.wrapper.style.height="100%",this.container.appendChild(this.wrapper),this.createToolbar(),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.style.flex="1",this.wrapper.appendChild(this.canvas),this.initialPinchDistance=0,this.isPinching=!1;const n=this.options.plots?.find(t=>"main"===t.id);if(!n)throw new Error("StockChart options must include a plot with id 'main'.");this.originalData=n.data||[],this.dataViewport=new e(this.originalData,this.options.initialVisibleCandles,5),this.plotLayoutManager=new s(this.canvas.width,this.canvas.height,this.options.plots),this.resize(),this.isDragging=!1,this.isResizingPlot=!1,this.resizingPlotId=null,this.isDraggingYAxis=!1,this.lastMouseX=0,this.lastMouseY=0,this.lastTouchX=0,this.lastTouchY=0,this.crosshairX=-1,this.crosshairY=-1,this.resizeHandleHeight=10,this.minPrice=0,this.maxPrice=0,this.priceScale=1,this.priceOffset=0,this.plotScales=new Map,this.mobileSize=768,this.drawingPanel=new v(this),this.activeDrawingTool=null,this.eligibleMainPlotKeys=["time","open","high","low","close"],this.loadDrawingsFromIndexedDB(),this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("broadcastCursor",t=>{const{x:i,y:s}=t.detail;this.crosshairX=i,this.crosshairY=s,this.render()}),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseout",this.handleMouseOut.bind(this)),this.canvas.addEventListener("wheel",this.handleMouseWheel.bind(this)),this.canvas.addEventListener("dblclick",this.resetVerticalScale.bind(this)),window.addEventListener("keydown",this.handleKeyDown.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this.handleTouchEnd.bind(this)),this.resizeObserver=new ResizeObserver(t=>{for(let i of t)i.target===this.container&&(this.resize(),this.render())}),this.resizeObserver.observe(this.container),this.applyTheme(this.options.theme),this.updateMetaStringWithTimeframe("daily")}async loadDrawingsFromIndexedDB(){try{this.drawingPanel&&"function"==typeof this.drawingPanel.loadDrawingsFromIndexedDB&&await this.drawingPanel.loadDrawingsFromIndexedDB()}catch(t){}}loadIndicatorSettings(){const t=localStorage.getItem("asv-chart-indicator-settings");t&&JSON.parse(t).forEach(t=>{this.drawingPanel.addIndicatorWithSettings(t.id,t.settings)})}static defaultOptions={theme:"light",plots:[{id:"main",heightRatio:.7,data:[],type:"line"}],initialVisibleCandles:100,showDrawingToolbar:!0};static ensureValidOptions(t={}){return{...this.defaultOptions,...t,plots:t.plots||[...this.defaultOptions.plots],theme:t.theme||this.defaultOptions.theme,showDrawingToolbar:void 0!==t.showDrawingToolbar?t.showDrawingToolbar:this.defaultOptions.showDrawingToolbar}}static themes={light:t,dark:i};createToolbar(){if(!this.options.showDrawingToolbar)return;const t=window.innerWidth<=768,i=document.createElement("div");i.style.width=t?"100%":"40px",i.style.height=t?"45px":"auto",i.style.position=t?"absolute":"relative",i.style.bottom=t?"-45px":"auto",i.style.bottom=t?"-45px":"auto",i.style.overflowX=t?"scroll":"hidden",i.style.overflowY=t?"hidden":"auto",i.style.backgroundColor=this.currentTheme?.background||"#ffffff",i.style.borderRight=t?"none":"1px solid "+(this.currentTheme?.gridColor||"#e0e0e0"),i.style.borderTop=t?"1px solid "+(this.currentTheme?.gridColor||"#e0e0e0"):"none",i.style.display="flex",i.style.flexDirection=t?"row":"column",i.style.padding="5px",i.style.gap="5px",i.style.justifyContent=t?"space-around":"flex-start",i.style.zIndex="1000";const s=t?24:18,e=["daily","weekly","monthly"];[{name:"cursor",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M13.64,21.97C13.14,22.21 12.54,22 12.31,21.5L10.13,16.76L7.62,18.78C7.45,18.92 7.24,19 7,19A1,1 0 0,1 6,18V3A1,1 0 0,1 7,2C7.24,2 7.47,2.09 7.64,2.23L7.65,2.22L19.14,11.86C19.57,12.22 19.62,12.85 19.27,13.27C19.12,13.45 18.91,13.57 18.7,13.61L15.54,14.23L17.74,18.96C18,19.46 17.76,20.05 17.26,20.28L13.64,21.97Z"/></svg>`,tooltip:"Select Tool"},{name:"daily",icon:"D",tooltip:"Daily"},{name:"weekly",icon:"W",tooltip:"Weekly"},{name:"monthly",icon:"M",tooltip:"Monthly"},{name:"trend-line",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M7 21L17 3h2L9 21H7"/></svg>`,tooltip:"Line Tool"},{name:"vertical-line",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"> <path fill="currentColor" d="M12 3h2v18h-2V3"/></svg>`,tooltip:"Vertical Line Tool"},{name:"horizontal-line",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M3 12h18v2H3v-2"/></svg>`,tooltip:"Horizontal Line Tool"},{name:"rectangle",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M2 4H22V20H2V4M4 6V18H20V6H4Z"/></svg>`,tooltip:"Rectangle Tool"},{name:"fibonacci-retrace",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M 3 4 L 3 4 v 17 h 18 v -2 H 5 V 4 H 3 M 7 4 L 21 4 L 21 6 L 7 6 L 7 4 L 7 4 M 7 9 L 21 9 L 21 11 L 7 11 L 7 9 M 7 14 L 21 14 L 21 16 L 7 16 L 7 14"/></svg>`,tooltip:"Fibonacci Tool"},{name:"fibonacci-zoon",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M3 3v18h18v-2H5V3H3m5 0v14h2V3H8m5 0v14h2V3h-2m5 0v14h2V3h-2"/></svg>`,tooltip:"Fibonacci Zoon Tool"},{name:"clear",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>`,tooltip:"Clear All Drawings"},{name:"settings",icon:`<svg viewBox="0 0 24 24" width="${s}" height="${s}"><path fill="currentColor" d="M12 8.666c-1.838 0-3.333 1.496-3.333 3.334s1.495 3.333 3.333 3.333 3.333-1.495 3.333-3.333-1.495-3.334-3.333-3.334m0 7.667c-2.39 0-4.333-1.943-4.333-4.333s1.943-4.334 4.333-4.334 4.333 1.944 4.333 4.334c0 2.39-1.943 4.333-4.333 4.333m-1.193 6.667h2.386c.379-1.104.668-2.451 2.107-3.05 1.496-.617 2.666.196 3.635.672l1.686-1.688c-.508-1.047-1.266-2.199-.669-3.641.567-1.369 1.739-1.663 3.048-2.099v-2.388c-1.235-.421-2.471-.708-3.047-2.098-.572-1.38.057-2.395.669-3.643l-1.687-1.686c-1.117.547-2.221 1.257-3.642.668-1.374-.571-1.656-1.734-2.1-3.047h-2.386c-.424 1.231-.704 2.468-2.099 3.046-.365.153-.718.226-1.077.226-.843 0-1.539-.392-2.566-.893l-1.687 1.686c.574 1.175 1.251 2.237.669 3.643-.571 1.375-1.734 1.654-3.047 2.098v2.388c1.226.418 2.468.705 3.047 2.098.581 1.403-.075 2.432-.669 3.643l1.687 1.687c1.45-.725 2.355-1.204 3.642-.669 1.378.572 1.655 1.738 2.1 3.047m3.094 1h-3.803c-.681-1.918-.785-2.713-1.773-3.123-1.005-.419-1.731.132-3.466.952l-2.689-2.689c.873-1.837 1.367-2.465.953-3.465-.412-.991-1.192-1.087-3.123-1.773v-3.804c1.906-.678 2.712-.782 3.123-1.773.411-.991-.071-1.613-.953-3.466l2.689-2.688c1.741.828 2.466 1.365 3.465.953.992-.412 1.082-1.185 1.775-3.124h3.802c.682 1.918.788 2.714 1.774 3.123 1.001.416 1.709-.119 3.467-.952l2.687 2.688c-.878 1.847-1.361 2.477-.952 3.465.411.992 1.192 1.087 3.123 1.774v3.805c-1.906.677-2.713.782-3.124 1.773-.403.975.044 1.561.954 3.464l-2.688 2.689c-1.728-.82-2.467-1.37-3.456-.955-.988.41-1.08 1.146-1.785 3.126"/></svg>`,tooltip:"Settings"}].forEach(t=>{if(!this.options.showTimeframeButtons&&e.includes(t.name))return;const s=document.createElement("button");s.innerHTML=t.icon,s.title=t.tooltip;const n=window.innerWidth<=768,o=n?"36px":"30px";s.style.width=o,s.style.height=o,s.style.border="none",s.style.borderRadius="4px",s.style.backgroundColor="transparent",s.style.cursor="pointer",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.padding=n?"8px":"6px",s.style.color=this.currentTheme?.textColor||"#000000",s.style.touchAction="manipulation",s.style.setProperty("-webkit-tap-highlight-color","transparent"),s.style.userSelect="none",s.addEventListener("mouseover",()=>{s.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0"}),s.addEventListener("mouseout",()=>{s.style.backgroundColor=t.name===this.activeDrawingTool?this.currentTheme?.gridColor||"#e0e0e0":"transparent"}),s.addEventListener("click",()=>{i.querySelectorAll("button").forEach(t=>{t.style.backgroundColor="transparent"}),"clear"===t.name?this.clearDrawings():"cursor"===t.name?(this.setDrawingTool(null),s.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0"):["daily","weekly","monthly"].includes(t.name)?this.handleTimeframeChange(t.name):(this.setDrawingTool(t.name),s.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0")}),["daily","weekly","monthly"].includes(t.name)&&(s.style.fontSize=n?"14px":"12px",s.style.fontWeight="bold"),i.appendChild(s)}),this.wrapper.insertBefore(i,this.canvas),this.toolbar=i}calculatePriceRange(t,i,s){let e,n;if("volume"===t.type)e=0,n=Math.max(...i.map(t=>t.volume||1));else if("line"===t.type){const i=t.data.slice(s.startIndex,s.startIndex+s.visibleCount).map(t=>t.value??t.close).filter(t=>null!==t&&isFinite(t));if(0===i.length)return{minPrice:0,maxPrice:1};const o=Math.min(...i),h=Math.max(...i),a=.1*(h-o);e=o-a,n=h+a}else{const t=i.map(t=>t.low),s=i.map(t=>t.high),o=Math.min(...t),h=Math.max(...s),a=.1*(h-o);e=o-a,n=h+a}if(this.plotScales instanceof Map&&t&&t.id){const i=this.plotScales.get(t.id)||1;if(1!==i){const t=(n+e)/2,s=(n-e)/2;e=t-s/i,n=t+s/i}}return{minPrice:e,maxPrice:n}}calculateYAxisWidth(){if(!this.ctx||!this.dataViewport)return 80;const t=this.ctx;let i=0;const s=this.canvas.width<600?10:12;t.font=`${s}px Arial`;const e=this.dataViewport.getVisibleData();return 0===e.length?80:(this.options.plots.forEach(s=>{const{minPrice:n,maxPrice:o}=this.calculatePriceRange(s,e,this.dataViewport);let h=[n,o];const a=o-n;for(let t=1;t<4;t++)h.push(n+a*t/4);h.forEach(e=>{let n;n="volume"===s.type?e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":Math.round(e).toLocaleString():e>=1e3?e.toFixed(0):e>=100?e.toFixed(1):e>=10?e.toFixed(2):e.toFixed(3);const o=t.measureText(n).width;i=Math.max(i,o)})}),i+(this.canvas.width<600?4:8))}resize(){let{clientWidth:t,clientHeight:i}=this.container;const s=this.container.parentElement;if(0===t&&(t=window.innerWidth),0===i&&(i=window.innerHeight),s)if("BODY"===s.tagName)t=.9*window.innerWidth,i=.8*window.innerHeight,this.container.style.width=`${t}px`,this.container.style.height=`${i}px`;else{const{clientWidth:e,clientHeight:n}=s;e===t&&n===i||(t=e,i=n,this.container.style.width=`${e}px`,this.container.style.height=`${n}px`)}const e=t-(this.options.showDrawingToolbar?40:0);this.canvas.width=e,this.canvas.height=i;const n=this.calculateYAxisWidth();this.plotLayoutManager.updateCanvasDimensions(e,i,n)}applyTheme(t){const i="string"==typeof t?C.themes[t]||C.themes.light:{...C.themes.light,...t};this.currentTheme=i,this.canvas.style.backgroundColor=i.background,this.toolbar&&(this.toolbar.style.backgroundColor=i.background,this.toolbar.style.borderRight=`1px solid ${i.gridColor}`,this.toolbar.querySelectorAll("button").forEach(t=>{t.style.color=i.textColor,t.title?.toLowerCase().includes(this.activeDrawingTool?.toLowerCase()||"")||null===this.activeDrawingTool&&"Select Tool"===t.title?t.style.backgroundColor=i.background:t.style.backgroundColor="transparent"})),this.render()}handleVerticalMouseWheel(t){if(t.ctrlKey){const i=t.deltaY<0?1.1:.9;this.priceScale*=i,this.render(),t.preventDefault()}}resetVerticalScale(){this.priceScale=1,this.priceOffset=0,this.render()}handleKeyDown(t){if(this.drawingPanel.isEditing&&this.drawingPanel.selectedDrawing&&("Delete"===t.key||"Backspace"===t.key)){const t=this.drawingPanel.drawings.indexOf(this.drawingPanel.selectedDrawing);-1!==t&&(this.drawingPanel.drawings.splice(t,1),this.drawingPanel.selectedDrawing=null,this.drawingPanel.selectedPoint=null,this.drawingPanel.isEditing=!1,this.drawingPanel.t=!1,this.render(),this.drawingPanel.saveDrawingsToIndexedDB())}}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.currentTheme.chartAreaBackground||"#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.dataViewport.getVisibleData();if(0===t.length)return this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font="20px Arial",void this.ctx.fillText("No data to display",this.canvas.width/2-80,this.canvas.height/2);const i=new Map,s=this.options.plots.find(t=>"main"===t.id);if(!s)return;const e=s.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);i.set("main",this.calculatePriceRange(s,e,this.dataViewport)),this.options.plots.sort((t,i)=>t.overlay&&!i.overlay?1:!t.overlay&&i.overlay?-1:0),this.options.plots.forEach(s=>{const e=s.overlay||!1,h=e?s.targetId||"main":s.id,a=this.plotLayoutManager.getPlotLayout(h);if(!a)return;const r=a.width/this.dataViewport.visibleCount;if(!e&&!i.has(s.id)){const t=s.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);i.set(s.id,this.calculatePriceRange(s,t,this.dataViewport))}const{minPrice:l,maxPrice:c}=i.get(h);if(a){if(e||(this.ctx.fillStyle=this.currentTheme.chartAreaBackground,this.ctx.fillRect(a.x,a.y,a.width,a.height),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.strokeRect(a.x,a.y,a.width,a.height)),this.options.plots.indexOf(s)!==this.options.plots.length-1&&!e){const t=a.y+a.height-this.resizeHandleHeight/2;this.ctx.fillStyle=this.isResizingPlot&&this.resizingPlotId===s.id?"rgba(150, 150, 150, 0.3)":"rgba(100, 100, 100, 0.1)",this.ctx.fillRect(a.x,t,a.width,this.resizeHandleHeight),this.ctx.fillStyle=this.currentTheme.gridColor;const i=6,e=30,n=a.x+(a.width-e)/2;for(let s=n;s<n+e;s+=i)this.ctx.beginPath(),this.ctx.arc(s,t+this.resizeHandleHeight/2,1,0,2*Math.PI),this.ctx.fill()}e||this.drawYAxisLabels(s,a,l,c),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(a.x,a.y,a.width,a.height),this.ctx.clip();const i=(s.data&&s.data.length>0?s.data:t).slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);switch(s.type){case"candlestick":i.forEach((t,i)=>{const s=.7*r,e=a.x+n(this.dataViewport.startIndex+i,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,r)+(r-s)/2,h=o(t.open,l,c,a.height,a.y),d=o(t.high,l,c,a.height,a.y),u=o(t.low,l,c,a.height,a.y),p=o(t.close,l,c,a.height,a.y);!function(t,i,s,e,n,o,h,a,r){const l=i.close>i.open?r.candleUp:r.candleDown;let c=r.candleBorderColor||r.textColor;r.borderColorUseBodyColor&&(c=l),t.strokeStyle=c,t.lineWidth=1,t.beginPath(),t.moveTo(s+a/2,n),t.lineTo(s+a/2,o),t.stroke(),t.fillStyle=l,t.strokeStyle=c,t.lineWidth=1,t.fillRect(s,Math.min(e,h),a,Math.abs(e-h)),t.strokeRect(s,Math.min(e,h),a,Math.abs(e-h))}(this.ctx,t,e,h,d,u,p,s,this.currentTheme)});break;case"line":this.drawLine(i,a,r,l,c,s);break;case"volume":this.drawVolume(i,r,a,c);break;case"histogram":this.drawHistogram(i,r,a,l,c,s);break;case"signal":if(!i||0===i.length)return;this.drawSignals(i,a,r,l,c)}}this.ctx.restore()}),this.drawXAxisLabels(),this.drawChartName(),this.ctx.save();const h=this.plotLayoutManager.getPlotLayout("main");if(h&&(this.ctx.beginPath(),this.ctx.rect(h.x,h.y,h.width,h.height),this.ctx.clip()),this.drawingPanel.render(this.ctx),this.ctx.restore(),-1!==this.crosshairX&&-1!==this.crosshairY){this.ctx.strokeStyle=this.currentTheme.crosshairColor,this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]);const t=this.options.plots[0],i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairX<=i.x+i.width&&(this.ctx.beginPath(),this.ctx.moveTo(this.crosshairX,0),this.ctx.lineTo(this.crosshairX,this.plotLayoutManager.getPlotTotalHeight()),this.ctx.stroke()),this.options.plots.forEach(t=>{if(t.overlay)return;const i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairY>=i.y&&this.crosshairY<=i.y+i.height&&(this.ctx.beginPath(),this.ctx.moveTo(0,this.crosshairY),this.ctx.lineTo(this.plotLayoutManager.getPlotTotalWidth(),this.crosshairY),this.ctx.stroke())}),this.ctx.setLineDash([])}this.displayInfoOverlay()}drawLine(t,i,s,e,h,a){let r=-1;t.forEach((l,c)=>{const d=l.value??l.close;if(null!=d&&0!==d){if(-1!==r){const l=t[r],u=i.x+n(this.dataViewport.startIndex+r,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)+s/2,p=o(l.value??l.close,e,h,i.height,i.y),f=i.x+n(this.dataViewport.startIndex+c,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)+s/2,m=o(d,e,h,i.height,i.y),b=a.style?.lineColor||this.currentTheme.lineColor,g=a.style?.lineWidth||2;!function(t,i,s,e,n,o,h){t.strokeStyle=o,t.lineWidth=h,t.beginPath(),t.moveTo(i,s),t.lineTo(e,n),t.stroke()}(this.ctx,u,p,f,m,b,g)}r=c}else r=-1})}drawVolume(t,i,s,e){t.forEach((t,o)=>{const h=.7*i,a=s.x+n(this.dataViewport.startIndex+o,this.dataViewport.startIndex,this.dataViewport.visibleCount,s.width,i)+(i-h)/2,r=(t.volume||0)/e*s.height,l=s.y+s.height-r;this.ctx.fillStyle=this.currentTheme.volumeColor||"rgba(0, 150, 136, 0.6)",this.ctx.fillRect(a,l,h,r)})}drawHistogram(t,i,s,e,h,a){t.forEach((t,r)=>{const l=.7*i,c=s.x+n(this.dataViewport.startIndex+r,this.dataViewport.startIndex,this.dataViewport.visibleCount,s.width,i)+(i-l)/2,d=o(0,e,h,s.height,s.y),u=o(t.value,e,h,s.height,s.y)-d;this.ctx.fillStyle=t.value>=0?a.style?.positiveColor||this.currentTheme.positiveColor:a.style?.negativeColor||this.currentTheme.negativeColor,this.ctx.fillRect(c,d,l,u)})}drawSignals(t,i,s,e,h){this.ctx.imageSmoothingEnabled=!1;const a={};t.filter(t=>null!=t.value).forEach((t,r)=>{const l=function(t){switch(t){case"support":return"rgba(0, 255, 0, 0.75)";case"resistance":return"rgba(255, 0, 0, 0.75)";case"uptrend":return"rgba(0, 255, 255, 0.75)";case"downtrend":return"rgba(255, 165, 0, 0.75)";default:return"rgba(0, 0, 0, 0.75)"}}(t.value.type);if(a[l]||(a[l]=new Path2D),null!=t.value.value){const c=Math.floor(i.x+n(this.dataViewport.startIndex+r,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)),d=Math.floor(o(t.value.value,e,h,i.height,i.y));a[l].rect(c,d,Math.ceil(s),10)}}),Object.keys(a).forEach(t=>{this.ctx.fillStyle=t,this.ctx.fill(a[t])})}handleMouseDown(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,e=t.clientY-i.top;if(this.activeDrawingTool){const t=this.plotLayoutManager.getPlotLayout("main");return void(t&&s>=t.x&&s<=t.x+t.width&&e>=t.y&&e<=t.y+t.height&&this.drawingPanel.startDrawing(this.activeDrawingTool,s,e))}if(this.drawingPanel.isChartFrozen)return;for(const i of this.options.plots){if(i.overlay)continue;const n=this.plotLayoutManager.getPlotLayout(i.id);if(n){const o={x:n.x+n.width,y:n.y,width:50,height:n.height};if(s>=o.x&&s<=o.x+o.width&&e>=o.y&&e<=o.y+o.height)return this.isDraggingYAxis=!0,this.resizingPlotId=i.id,void(this.lastMouseY=t.clientY)}}const n=this.options.plots.filter(t=>!t.overlay);for(let i=0;i<n.length-1;i++){const s=n[i],o=this.plotLayoutManager.getPlotLayout(s.id);if(o){const i=o.y+o.height;if(Math.abs(e-i)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=s.id,void(this.lastMouseY=t.clientY)}}this.isDragging=!0,this.lastMouseX=t.clientX}handleMouseMove(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,e=t.clientY-i.top;if(this.drawingPanel.isDrawing){const i=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY});return this.drawingPanel.continueDrawing(i),void this.render()}const o=this.plotLayoutManager.getPlotLayout("main");if(o){const t=o.width/this.dataViewport.visibleCount,i=s-o.x,e=Math.round(i/t-.5),h=Math.max(0,Math.min(this.dataViewport.visibleCount-1,e)),a=o.x+n(this.dataViewport.startIndex+h,this.dataViewport.startIndex,this.dataViewport.visibleCount,o.width,t);this.crosshairX=a+t/2}if(this.crosshairY=e,this.isDraggingYAxis&&this.resizingPlotId){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;let s=this.plotScales.get(this.resizingPlotId)||1;return s*=Math.exp(.01*-i),s=Math.max(.1,Math.min(10,s)),this.plotScales.set(this.resizingPlotId,s),void this.render()}if(this.isResizingPlot){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;const s=this.options.plots.filter(t=>!t.overlay),e=s.findIndex(t=>t.id===this.resizingPlotId);let n=e+1;if(e>=0&&n<s.length){const t=s[e],o=s[n],h=t.heightRatio+o.heightRatio,a=i/(this.plotLayoutManager.getPlotLayout(t.id).height/t.heightRatio),r=.1*h,l=Math.max(r,Math.min(h-r,t.heightRatio+a));t.heightRatio=l,o.heightRatio=h-l,this.resize(),this.render()}}else if(this.isDragging){const i=t.clientX-this.lastMouseX,s=this.plotLayoutManager.getPlotLayout("main"),e=s?s.width/this.dataViewport.visibleCount:this.canvas.width/this.dataViewport.visibleCount,n=Math.round(i/e);0!==n&&(this.dataViewport.scroll(-n),this.lastMouseX=t.clientX,this.render())}else{let t=!1;const i=this.plotLayoutManager.yAxisWidth||this.calculateYAxisWidth(),n=this.options.plots.filter(t=>!t.overlay);for(const o of n){const n=this.plotLayoutManager.getPlotLayout(o.id);if(n){const h=n.y+n.height;if(Math.abs(this.crosshairY-h)<this.resizeHandleHeight){this.canvas.style.cursor="row-resize",t=!0;break}const a={x:n.x+n.width,y:n.y,width:i,height:n.height};if(s>=a.x&&s<=a.x+a.width&&e>=a.y&&e<=a.y+a.height&&"main"===o.id){this.canvas.style.cursor="ns-resize",t=!0;break}}}t||(this.canvas.style.cursor="default"),this.render()}}handleMouseUp(t){if(this.drawingPanel.isDrawing){this.drawingPanel.completeDrawing(),this.setDrawingTool(null);const t=this.toolbar.querySelector('button[title="Select Tool"]');return t&&(t.style.backgroundColor=this.currentTheme?.gridColor||"#e0e0e0",this.toolbar.querySelectorAll("button").forEach(i=>{i!==t&&(i.style.backgroundColor="transparent")})),void this.render()}if(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.canvas.style.cursor="default",t&&2===t.detail){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,e=t.clientY-i.top;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const n={x:i.x+i.width,y:i.y,width:50,height:i.height};if(s>=n.x&&s<=n.x+n.width&&e>=n.y&&e<=n.y+n.height){this.plotScales.delete(t.id),this.render();break}}}}}handleMouseOut(){this.isDragging=!1,this.crosshairX=-1,this.crosshairY=-1,this.render()}handleMouseWheel(t){if(t.preventDefault(),this.drawingPanel.isChartFrozen)return;const i=this.canvas.getBoundingClientRect();t.clientX,i.left;const s=t.clientY-i.top;if(t.ctrlKey){const i=t.deltaY<0?1.1:1/1.1,e=this.plotLayoutManager.getPlotLayout("main");if(e){const t=this.maxPrice-this.minPrice,n=t/i,o=this.minPrice+(this.maxPrice-this.minPrice)*((e.y+e.height-s)/e.height);this.minPrice=o-n*((o-this.minPrice)/t),this.maxPrice=o+n*((this.maxPrice-o)/t)}this.render()}else{const i=t.deltaY<0?1.1:.901,s=Math.floor(this.crosshairX/(this.canvas.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i,s),this.render()}}lastTapTime=0;lastTapX=0;lastTapY=0;touchHoldTimer=null;isCrosshairMode=!1;touchStartX=0;touchStartY=0;handleTouchStart(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();if(this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null),!this.drawingPanel.isChartFrozen)if(t.touches.length!==this.lastTouchCount&&(this.isPinching=!1,this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.isCrosshairMode=!1,this.initialPinchDistance=0),this.lastTouchCount=t.touches.length,2===t.touches.length){const s=t.touches[0],e=t.touches[1],n=s.clientX-i.left,o=s.clientY-i.top,h=e.clientX-i.left,a=e.clientY-i.top,r=Math.sqrt(Math.pow(h-n,2)+Math.pow(a-o,2));r>30&&(this.isPinching=!0,this.initialPinchDistance=r,this.pinchCenterX=(n+h)/2,this.pinchCenterY=(o+a)/2,this.lastPinchDistance=r),this.initialPinchDistance=Math.sqrt(Math.pow(h-n,2)+Math.pow(a-o,2)),this.pinchCenterX=(n+h)/2,this.pinchCenterY=(o+a)/2}else if(1===t.touches.length){const s=t.touches[0],e=s.clientX-i.left,o=s.clientY-i.top;this.initialTouchX=e,this.initialTouchY=o,this.lastTouchX=e,this.lastTouchY=o;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const s={x:i.x+i.width,y:i.y,width:50,height:i.height};if(e>=s.x&&e<=s.x+s.width&&o>=s.y&&o<=s.y+s.height){const i=(new Date).getTime(),s=i-this.lastTapTime,n=Math.sqrt(Math.pow(e-this.lastTapX,2)+Math.pow(o-this.lastTapY,2));return s<300&&n<30?(this.plotScales.delete(t.id),this.render(),void(this.lastTapTime=0)):(this.lastTapTime=i,this.lastTapX=e,this.lastTapY=o,this.isDraggingYAxis=!0,this.resizingPlotId=t.id,void(this.lastTouchY=o))}}}for(let t=0;t<this.options.plots.length-1;t++){const i=this.options.plots[t];if(!i.overlay){const t=this.plotLayoutManager.getPlotLayout(i.id),s=t.y+t.height;if(Math.abs(o-s)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=i.id,void(this.lastTouchY=o)}}this.isDragging=!0,this.lastTouchX=e,this.lastTouchY=o,this.crosshairX=-1,this.crosshairY=-1,this.touchHoldTimer=setTimeout(()=>{if(this.isDragging){this.isCrosshairMode=!0;const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=t.width/this.dataViewport.visibleCount,s=e-t.x,h=Math.round(s/i-.5),a=Math.max(0,Math.min(this.dataViewport.visibleCount-1,h)),r=t.x+n(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=r+i/2,this.crosshairY=o}this.render()}},1e3)}}handleTouchMove(t){if(t.preventDefault(),this.drawingPanel.isChartFrozen)return;const i=this.canvas.getBoundingClientRect();if(2===t.touches.length&&this.isPinching){const s=t.touches[0],e=t.touches[1],n=s.clientX-i.left,o=s.clientY-i.top,h=e.clientX-i.left,a=e.clientY-i.top,r=Math.sqrt(Math.pow(h-n,2)+Math.pow(a-o,2));if(this.initialPinchDistance>10&&r>10){const t=r/this.initialPinchDistance,i=(n+h)/2,s=(o+a)/2,e=.3,l=this.pinchCenterX?this.pinchCenterX*(1-e)+i*e:i,c=this.pinchCenterY?this.pinchCenterY*(1-e)+s*e:s;let d=null;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i&&c>=i.y&&c<=i.y+i.height){d=t.id;break}}if(d){const i=Math.abs(c-this.pinchCenterY),s=Math.abs(l-this.pinchCenterX),e=.002,n=Math.abs(t-1);if(n>e){const e=1+(t-1)*Math.min(.3,.5*n);if(i>1.2*s){let t=this.plotScales.get(d)||1;t*=Math.exp(.3*(e-1)),t=Math.max(.1,Math.min(10,t)),this.plotScales.set(d,t)}else{const t=.02,i=Math.exp((e-1)*t),s=this.plotLayoutManager.getPlotLayout(d),n=Math.floor((l-s.x)/(s.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i>1?1.03:.97,n)}}}this.pinchCenterX=l,this.pinchCenterY=c,this.initialPinchDistance=r,this.render()}}else if(1===t.touches.length){const s=t.touches[0],e=s.clientX-i.left,o=s.clientY-i.top,h=this.plotLayoutManager.getPlotLayout("main");if(h){const t=h.width/this.dataViewport.visibleCount;if(this.isCrosshairMode){const i=e-h.x,s=Math.round(i/t-.5),a=Math.max(0,Math.min(this.dataViewport.visibleCount-1,s)),r=h.x+n(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,h.width,t);this.crosshairX=r+t/2,this.crosshairY=o}else if(this.isDragging){const t=Math.abs(e-this.initialTouchX),i=Math.abs(o-this.initialTouchY);Math.sqrt(t*t+i*i)>10&&this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null,this.isCrosshairMode=!1,this.crosshairX=-1,this.crosshairY=-1)}}if(this.isDraggingYAxis&&this.resizingPlotId){const t=o-this.lastTouchY;this.lastTouchY=o;let i=this.plotScales.get(this.resizingPlotId)||1;i*=Math.exp(.01*-t),i=Math.max(.1,Math.min(10,i)),this.plotScales.set(this.resizingPlotId,i),this.render()}else if(this.isResizingPlot){const t=o-this.lastTouchY;this.lastTouchY=o;const i=this.options.plots.filter(t=>!t.overlay),s=i.findIndex(t=>t.id===this.resizingPlotId);let e=s+1;if(s>=0&&e<i.length){const n=i[s],o=i[e],h=n.heightRatio+o.heightRatio,a=t/(this.plotLayoutManager.getPlotLayout(n.id).height/n.heightRatio),r=.1*h,l=Math.max(r,Math.min(h-r,n.heightRatio+a));n.heightRatio=l,o.heightRatio=h-l,this.plotLayoutManager.calculateLayout(),this.resize(),this.render()}}else if(this.isDragging){const t=e-this.lastTouchX,i=this.plotLayoutManager.getPlotLayout("main"),s=i?i.width/this.dataViewport.visibleCount:this.canvas.width/this.dataViewport.visibleCount,h=Math.round(t/s);if(this.isCrosshairMode){const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=t.width/this.dataViewport.visibleCount,s=e-t.x,h=Math.round(s/i-.5),a=Math.max(0,Math.min(this.dataViewport.visibleCount-1,h)),r=t.x+n(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=r+i/2,this.crosshairY=o,this.render()}}else 0!==h&&(this.dataViewport.scroll(-h),this.lastTouchX=e,this.render())}}}handleTouchEnd(t){t.preventDefault(),this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null);const i=this.lastTouchCount;if(this.lastTouchCount=t.touches.length,2===i&&1===t.touches.length){this.isPinching=!1,this.initialPinchDistance=0,this.lastPinchDistance=0;const i=t.touches[0],s=this.canvas.getBoundingClientRect();this.lastTouchX=i.clientX-s.left,this.lastTouchY=i.clientY-s.top,this.isDragging=!0}else 0===t.touches.length&&(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.isPinching=!1,this.initialPinchDistance=0,this.lastPinchDistance=0,this.isCrosshairMode||(this.crosshairX=-1,this.crosshairY=-1),this.isCrosshairMode=!1);this.render()}drawChartName(){const{chartName:t}=this.options;if(!t)return;const{name:i,code:s,metaString:e}=t,{textColor:n}=this.currentTheme,o=this.canvas.width<600?10:14;let h=20;this.ctx.fillStyle=n,this.ctx.textAlign="left",i&&(this.ctx.font=`bold ${o+2}px Arial`,this.ctx.fillText(i,10,h),h+=o+4),s&&(this.ctx.font=`${o}px Arial`,this.ctx.fillText(s,10,h),h+=o+2),e&&(this.ctx.font=`italic ${o-1}px Arial`,this.ctx.fillText(e,10,h))}drawXAxisLabels(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width,e=Math.max(10,Math.min(12,Math.floor(s/50))),o=8*e,h=Math.floor(s/o),a=h>10?10:h,r=Math.max(1,Math.floor(t.length/a));this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font=`${e}px Arial`,this.ctx.textAlign="center";const l=this.canvas.height-e,c=new Date(1e3*t[0].time),d=new Date(1e3*t[t.length-1].time);c.getTime(),d.getTime();const u=i.width/this.dataViewport.visibleCount;for(let s=t.length-1;s>=0;s-=r){const e=t[s];if(!e||!e.time)continue;const o=n(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,u),h=new Date(1e3*e.time),a=`${h.getFullYear()}/${String(h.getMonth()+1).padStart(2,"0")}/${String(h.getDate()).padStart(2,"0")}`,r=i.x+o+u/2;r>=i.x&&r<=i.x+i.width&&this.ctx.fillText(a,r,l)}}drawYAxisLabels(t,i,s,e){this.ctx.fillStyle=this.currentTheme.textColor;const n=this.canvas.width<600?10:12;this.ctx.font=`${n}px Arial`,this.ctx.textAlign="left",this.ctx.textBaseline="middle";const h=n+4,a=Math.max(3,Math.min(8,Math.floor(i.height/h))),r=Math.min(5,a),l=(e-s)/r,c=[];for(let t=0;t<=r;t++){const n=s+t*l,h=o(n,s,e,i.height,i.y);c.push({price:n,y:h})}const d=c.filter(({y:t})=>{const s=1.5*n;return t>=i.y+s&&t<=i.y+i.height-s});let u=d;if(d.length<2&&c.length>=2){const t=c[0],s=c[c.length-1];u=[{...t,y:Math.max(i.y+n,t.y)},{...s,y:Math.min(i.y+i.height-n,s.y)}]}u.forEach(({price:s,y:e})=>{let n;this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.setLineDash([2,2]),this.ctx.moveTo(i.x,e),this.ctx.lineTo(i.x+i.width,e),this.ctx.stroke(),this.ctx.setLineDash([]),n="volume"===t.type?s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(1)+"K":Math.round(s).toLocaleString():s>=1e3?s.toFixed(0):s>=100?s.toFixed(1):s>=10?s.toFixed(2):s.toFixed(3);const o=i.x+i.width+4;this.ctx.fillText(n,o,Math.round(e))}),this.ctx.textBaseline="alphabetic",this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.moveTo(i.x+i.width,i.y),this.ctx.lineTo(i.x+i.width,i.y+i.height),this.ctx.stroke()}drawArrowLines(t,i,s,e,h){const a=new Map,r=t.flat();r.filter(t=>t).forEach(t=>{t&&t.id&&(a.has(t.id)||a.set(t.id,[]),a.get(t.id).push(t))});const l=r.find(t=>t),c=[...r].reverse().find(t=>t),d=l?l.time:0,u=c?c.time:0,p=new Set,f=new Set;let m=0;const b=5*s;a.forEach(t=>{if(t.length<2)return;let a=t[0],r=t[t.length-1];if(a.time<d){const i=t.find(t=>t.time>=d);i&&(a=i)}if(r.time>u){const i=[...t].reverse().find(t=>t.time<=u);i&&(r=i)}const l=this.findTimeIndex(a.time,this.dataViewport.allData),c=i.x+n(l,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)+s/2,g=o(a.value,e,h,i.height,i.y),x=this.findTimeIndex(r.time,this.dataViewport.allData),y=i.x+n(x,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,s)+s/2,w=o(r.value,e,h,i.height,i.y);if(a.isPrediction){if(this.ctx.setLineDash([5,5]),p.add(c),p.add(y),f.add(g),f.add(w),m++,2===m){const t=[...p].sort((t,i)=>t-i),i=[...f].sort((t,i)=>t-i),s=Math.max(...i),e=Math.min(...i),n=Math.max(...t)+b,o=function(t,i,s,e,n,o,h=50,a=.6){var r=s-n,l=e-o,c=Math.sqrt(r*r+l*l);return"M "+s+" "+e+" Q "+(s+a*h*(l/=c))+" "+(e-a*h*(r/=c))+" "+(s-.25*c*r+(1-a)*h*l)+" "+(e-.25*c*l-(1-a)*h*r)+" T "+t+" "+i+" M "+n+" "+o+" Q "+(n+a*h*l)+" "+(o-a*h*r)+" "+(s-.75*c*r+(1-a)*h*l)+" "+(e-.75*c*l-(1-a)*h*r)+" T "+t+" "+i}(t[0],i[1],n,e,n,s,n-t[0],.55),h=new Path2D(o);this.ctx.lineWidth=2,this.ctx.stroke(h)}}else this.drawArrowLine(y,c,w,g)})}drawArrowLine(t,i,s,e){const n=t-i,o=s-e,h=Math.atan2(o,n);this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.textColor,this.ctx.lineWidth=1.5,this.ctx.moveTo(i,e),this.ctx.lineTo(t,s),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(t,s),this.ctx.lineTo(t-10*Math.cos(h-Math.PI/6),s-10*Math.sin(h-Math.PI/6)),this.ctx.lineTo(t,s),this.ctx.lineTo(t-10*Math.cos(h+Math.PI/6),s-10*Math.sin(h+Math.PI/6)),this.ctx.stroke()}findTimeIndex(t,i){let s=0,e=i.length-1;for(;s<=e;){const n=Math.floor((s+e)/2);if(i[n].time===t)return n;i[n].time<t?s=n+1:e=n-1}return e>=0&&s<i.length?Math.abs(i[s]?.time-t)<Math.abs(i[e]?.time-t)?s:e:e>=0?e:0}displayInfoOverlay(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width/this.dataViewport.visibleCount,e=this.crosshairX-i.x,n=Math.max(0,Math.floor(e/s));let o=this.dataViewport.startIndex+n;this.options.plots.forEach(i=>{const s=this.plotLayoutManager.getPlotLayout(i.id);if(!s||i.overlay)return;const e=i.data&&i.data.length>0?i.data:t;if(o>=0&&o<e.length){this.crosshairY<0&&(o=e.length-1);const c=e[o];if(this.ctx.fillStyle=this.currentTheme.overlayTextColor,this.ctx.font="12px Arial",this.crosshairY>=s.y&&this.crosshairY<=s.y+s.height){const{minPrice:e,maxPrice:o}=this.calculatePriceRange(i,t,this.dataViewport),c=(n=this.crosshairY,h=s.y,r=e,l=o,0===(a=s.height)?(l+r)/2:r+(1-(n-h)/a)*(l-r));let d;d="volume"===i.type?c>=1e6?(c/1e6).toFixed(2)+"M":c>=1e3?(c/1e3).toFixed(2)+"K":Math.round(c).toString():c>=1e3?c.toFixed(0):c>=100?c.toFixed(1):c>=10?c.toFixed(2):c.toFixed(3),this.ctx.textAlign="left",this.ctx.textBaseline="middle";const u=this.plotLayoutManager.getPlotTotalWidth()+5;this.ctx.fillText(d,u,Math.round(this.crosshairY))}if("main"===i.id&&void 0!==c.time){const t=new Date(1e3*c.time),i=`${t.getFullYear()}/${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}`;this.ctx.textAlign="center",this.ctx.textBaseline="middle";const s=this.plotLayoutManager.getPlotTotalHeight()+15;this.ctx.fillText(i,this.crosshairX,s)}const d=this.options.plots.filter(t=>t.targetId===i.id||t.id===i.id).reduce((t,i)=>{if("main"===i.id){const s=i.keyLabel||"";t[s]||(t[s]=[]),t[s].push(i)}else if(i.targetId&&"main"===i.targetId){const s=i.keyLabel||"";t[s]||(t[s]=[]),t[s].push(i)}else{const s=i.targetId||i.id;t[s]||(t[s]=[]),t[s].push(i)}return t},{}),u=[];Object.entries(d).forEach(([i,s])=>{const e=[];if(s.forEach(i=>{const s="main"===i.id,n=i.data&&i.data.length>0?i.data:t;if(o>=0&&o<n.length){const t=n[o],h=Object.entries(t).map(([t,e])=>{if(!s&&("time"===t||"date"===t||"keyLabel"===t))return null;if(s&&!this.eligibleMainPlotKeys.includes(t))return null;let n="";if("time"===t&&s){const t=new Date(1e3*e);return n=`${t.getFullYear()}/${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")}`,`${n}`}if("number"==typeof e)n=e.toFixed(2);else if("object"==typeof e){if(!e||!e.value)return null;n=e.value?.toFixed(2)}else n=e;return i.keyLabel?.trim().length>0?i.keyLabel:(t.charAt(0).toUpperCase(),t.slice(1)),`${n}`}).filter(Boolean);h.length>0&&e.push(...h)}}),e.length>0){let t="main"!==i?`${i.toUpperCase()}: `:"";t=":"===t.trim()?"":t,u.push(`${t}${e.join(" | ")}`)}});const p=15,f=10,m=s.x+s.width-f;this.ctx.textAlign="right";const b=window.innerWidth<=this.mobileSize;this.ctx.font=b?"10px Arial":"12px Arial",u.forEach((t,i)=>{const e=s.y+(i+1)*p;this.ctx.fillText(t,m,e)}),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}var n,h,a,r,l})}renderOverlayPanels(){this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.font="10px Arial",this.ctx.fillText("Overlay panels reserved for indicators",10,this.canvas.height-10),this.ctx.restore()}updateStockData(t,i=!0){if(this.timeframeOnScreen="daily",!Array.isArray(t))return;const s=t.find(t=>"main"===t.id);s&&(this.dataViewport=new e(s.data,this.options.initialVisibleCandles,5),this.drawingPanel.clearDrawings(),this.loadDrawingsFromIndexedDB());const n=[...t];this.options.plots.length=0,this.options.plots=n;const o=this.calculateYAxisWidth();this.plotLayoutManager.updateCanvasDimensions(this.canvas.width,this.canvas.height,o),this.plotLayoutManager.updatePlotConfigurations(this.options.plots),this.loadIndicatorSettings()}async updateChartName(t){this.options.chartName=t,await this.loadDrawingsFromIndexedDB(),this.updateMetaStringWithTimeframe("daily"),this.render()}updateMainPlotOriginalData(t){this.originalData=t}ensureContainerSize(t){const i=window.innerWidth<=768,s=t.parentElement,e=t.clientHeight<1,n=t.clientWidth<1;(e||n)&&(s&&s.clientHeight>1&&s.clientWidth>1&&(e||n)?(t.style.height=`${s.clientHeight}px`,t.style.width=`${s.clientWidth}px`):(e&&(t.style.height=i?`${window.innerHeight}px`:.9*window.innerHeight+"px"),n&&(t.style.width=i?`${window.innerWidth}px`:.9*window.innerWidth+"px")))}setDrawingTool(t){this.activeDrawingTool=t,this.drawingPanel.setActiveTool(t),this.canvas.style.cursor=t?"crosshair":"default",this.toolbar&&this.toolbar.querySelectorAll("button").forEach(i=>{const s="Select Tool"===i.title;i.style.backgroundColor=null===t?s?this.currentTheme?.gridColor||"#e0e0e0":"transparent":i.title?.toLowerCase().includes(t.toLowerCase())?this.currentTheme?.gridColor||"#e0e0e0":"transparent"})}clearDrawings(){this.drawingPanel.clearDrawings(!0),this.render()}importDrawings(t){this.drawingPanel.importDrawings(t),this.render()}exportDrawings(){return this.drawingPanel.exportDrawings()}centerOnDate(t,i={}){if(!t||"number"!=typeof t)return;const s=Math.floor(t/1e3);let e=this.dataViewport.allData.findIndex(t=>t.time===s);if(-1===e){const t=1;e=this.dataViewport.allData.findIndex(i=>Math.abs(i.time-s)<=t)}if(-1===e){const t=this.dataViewport.allData.reduce((t,i)=>Math.abs(i.time-s)<Math.abs(t.time-s)?i:t);e=this.dataViewport.allData.indexOf(t)}let o=e-Math.floor(this.dataViewport.visibleCount/2);if(o<0?o=0:o+this.dataViewport.visibleCount>=this.dataViewport.allData.length&&(o=this.dataViewport.allData.length-this.dataViewport.visibleCount),this.dataViewport.startIndex=o,!1!==i.drawLine){const t=this.plotLayoutManager.getPlotLayout("main");if(t){const s=t.width/this.dataViewport.visibleCount;this.dataViewport.startIndex;const o=t.x+n(e,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,s)+s/2;this.render(),this.drawVerticalLine({x:o,color:i.lineColor||this.currentTheme.textColor,width:i.lineWidth||1})}}}drawVerticalLine({x:t,color:i,width:s}){this.ctx.beginPath(),this.ctx.strokeStyle=i,this.ctx.lineWidth=s,this.ctx.moveTo(t,0),this.ctx.lineTo(t,this.plotLayoutManager.getPlotTotalHeight()),this.ctx.stroke()}handleTimeframeChange(t){const i=this.options.plots.find(t=>"main"===t.id);if(!i)return;let s;switch(t){case"daily":default:s=[...this.originalData];break;case"weekly":s=((t,i)=>{if(!t||0===t.length)return[];const s={},e=t[0];if(!e)return[];const n=new Date(1e3*e.time);let o=n.getDay(),h=n.getFullYear(),a=$(n),r=1;const l=((t,i)=>{const s=new Date(t),{numberOfWeek:e,year:n}=$(s);let o=null;const h=i.length;for(let t=0;t<h;t++){const s=i[t],h=new Date(1e3*s.time),{numberOfWeek:a,year:r}=$(h);if(r===n&&a===e){o=s;break}}return o})(new Date(1e3*e.time).toISOString().split("T")[0],i);if(l){const t=new Date(1e3*l.time).toISOString().split("T")[0];r=$(t).numberOfWeek,s[`${h}-W${r.toString().padStart(2,"0")}`]={...l,Timeframe:M}}for(const e of t){const t=new Date(1e3*e.time).toISOString().split("T")[0],n=new Date(t).getFullYear(),l=$(t),c=new Date(t).getDay();c<o?(o=c,r++):l.numberOfWeek>a.numberOfWeek?(a=l,o=c,r++):o++,n!==h&&(h=n,r=1);const d=`${n}-W${r.toString().padStart(2,"0")}`;if(s[d]){const t=s[d];t.open&&0!==t.open||(t.open=e.open),t.low&&0!==t.low||(t.low=e.low),t.high=Math.max(t.high,e.high),t.low=Math.min(t.low,e.low),t.close=e.close,s[d]=t}else{const t=i.find(t=>t.timestamp>=e.timestamp),n=t||e,o=new Date(1e3*n.time).toISOString().split("T")[0];s[d]={...n,id:t?t.ID:0,date:o,open:e.open,high:e.high,low:e.low,close:e.close,timeframe:M},a=l}}return Object.values(s).sort((t,i)=>new Date(t.date).getTime()-new Date(i.date).getTime())})([...this.originalData],[]);break;case"monthly":s=((t,i)=>{if(!t||0===t.length)return[];const s={};for(const t of i)t.date=new Date(1e3*t.time).toISOString().split("T")[0],s[t.date.substring(0,7)]={...t};const e={};for(const n of t){n.date=new Date(1e3*n.time).toISOString().split("T")[0];const t=n.date.substring(0,7);if(s[t]){const i=s[t];i.open&&0!==i.open||(i.open=n.open),i.low&&0!==i.low||(i.low=n.low),i.high=Math.max(i.high||0,n.high),i.low=Math.min(i.low,n.low),i.close=n.close,e[t]=i}else{const o=i.find(t=>k(t.date,n.date)),h=o||n;s[t]={...h,ID:o?o.ID:0,date:o?o.date:`${t}-01`,open:n.open,high:n.high,low:n.low,close:n.close,timeframe:"monthly"},e[t]=s[t]}}return Object.values(e).sort((t,i)=>new Date(t.date).getTime()-new Date(i.date).getTime())})([...this.originalData],[])}this.updateMetaStringWithTimeframe(t),this.options.plots=this.options.plots.filter(t=>!["sma","ema"].includes(t.indicator?.id)),i.data=s,this.updateStockData(this.options.plots,!1),this.timeframeOnScreen=t,this.render()}updateMetaStringWithTimeframe(t){const i={intraday:"Intraday",daily:"Daily",weekly:"Weekly",monthly:"Monthly"}[t]||"";this.options.chartName||(this.options.chartName={}),this.options.chartName.metaString||(this.options.chartName.metaString="");let s=this.options.chartName.metaString;s=s.replace(/(Intraday|Daily|Weekly|Monthly)/i,"").trim(),i&&(s.length>0&&(s=s.trim()),s=i+" "+s,s=s.trim()),this.options.chartName.metaString=s}}return C});//# sourceMappingURL=stock-chart.umd.min.js.map

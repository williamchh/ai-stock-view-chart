!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).StockChart=i()}(this,function(){"use strict";const t={name:"light",background:"#FFFFFF",chartAreaBackground:"#F8F8F8",gridColor:"#E0E0E0",textColor:"#333333",candleUp:"#4CAF50",candleDown:"#F44336",candleBorderColor:"#333333",lineColor:"#2196F3",crosshairColor:"#9E9E9E",overlayTextColor:"#333333",positiveColor:"rgba(76, 175, 80, 0.8)",negativeColor:"rgba(244, 67, 54, 0.8)"},i={name:"dark",background:"#1A1A1A",chartAreaBackground:"#2C2C2C",gridColor:"#444444",textColor:"#E0E0E0",candleUp:"#66BB6A",candleDown:"#EF5350",candleBorderColor:"#E0E0E0",lineColor:"#64B5F6",crosshairColor:"#BDBDBD",overlayTextColor:"#E0E0E0",positiveColor:"rgba(102, 187, 106, 0.8)",negativeColor:"rgba(239, 83, 80, 0.8)"};class s{plotTotalHeight;plotTotalWidth;yAxisWidth=80;bottomMargin=40;leftMargin=0;topMargin=0;constructor(t,i,s){this.canvasWidth=t,this.canvasHeight=i,this.plotConfigs=s,this.plots={},this.calculateLayout()}calculateLayout(){let t=0;const i=this.plotConfigs.filter(t=>!t.overlay).reduce((t,i)=>t+i.heightRatio,0);this.plotConfigs.forEach(s=>{if(s.overlay){const t=this.plots.main;t&&(this.plots[s.id]={...t})}else{const h=this.canvasWidth-this.leftMargin-this.yAxisWidth,e=this.canvasHeight-this.topMargin-this.bottomMargin,o=s.heightRatio/i*e;this.plots[s.id]={x:this.leftMargin,y:t+this.topMargin,width:h,height:o},t+=o}}),this.plotTotalHeight=t,this.plotTotalWidth=this.canvasWidth-this.yAxisWidth}getPlotLayout(t){return this.plots[t]||null}updateCanvasDimensions(t,i,s=void 0){this.canvasWidth=t,this.canvasHeight=i,void 0!==s&&(this.yAxisWidth=s),this.calculateLayout()}getPlotTotalWidth(){return this.plotTotalWidth}getPlotTotalHeight(){return this.plotTotalHeight}}class h{constructor(t,i,s=0){this.allData=t,this.visibleCount=Math.min(i,t.length+s),this.rightPadding=s,this.maxStartIndex=Math.max(0,t.length-this.visibleCount+s),this.startIndex=Math.min(Math.max(0,this.maxStartIndex),Math.max(0,t.length-this.visibleCount))}getVisibleData(){const t=Math.min(this.startIndex+this.visibleCount,this.allData.length);return this.allData.slice(this.startIndex,t)}scroll(t){this.maxStartIndex=this.allData.length-this.visibleCount+this.rightPadding;const i=this.startIndex+t,s=Math.min(Math.round(.1*this.visibleCount),Math.round(.1*this.allData.length)),h=this.maxStartIndex+s;this.startIndex=Math.max(0,Math.min(h,i))}zoom(t,i){if(t<1&&this.startIndex<=0&&(window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount),zoomFactor:t,anchorIndex:i}})),0===this.startIndex))return;const s=this.startIndex+i,h=Math.max(10,Math.min(this.allData.length,Math.round(this.visibleCount/t))),e=i/this.visibleCount,o=s-Math.round(h*e);this.visibleCount=h,this.maxStartIndex=Math.max(0,this.allData.length-this.visibleCount);const n=Math.round(.05*this.visibleCount),a=Math.max(-n,0),c=this.maxStartIndex+n;this.startIndex=Math.max(a,Math.min(c,o)),this.startIndex<=a&&t<1&&window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount)}}))}updateData(t){this.allData=t,this.startIndex=Math.max(0,this.allData.length-this.visibleCount)}}function e(t,i,s,h,e){return(t-i)*e}function o(t,i,s,h,e){const o=s-i;return 0===o?e+h/2:e+h-(t-i)/o*h}class n{static init(t,i){const s=document.getElementById(t);if(!s)return;const h=new n(s,i);return h.render(),h}constructor(t,i){this.ensureContainerSize(t),this.container=t,this.options={...n.defaultOptions,...i},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.initialPinchDistance=0,this.isPinching=!1;const e=this.options.plots?.find(t=>"main"===t.id);if(!e)throw new Error("StockChart options must include a plot with id 'main'.");this.dataViewport=new h(e.data||[],this.options.initialVisibleCandles,5),this.plotLayoutManager=new s(this.canvas.width,this.canvas.height,this.options.plots),this.resize(),this.isDragging=!1,this.isResizingPlot=!1,this.resizingPlotId=null,this.isDraggingYAxis=!1,this.lastMouseX=0,this.lastMouseY=0,this.lastTouchX=0,this.lastTouchY=0,this.crosshairX=-1,this.crosshairY=-1,this.resizeHandleHeight=10,this.minPrice=0,this.maxPrice=0,this.priceScale=1,this.priceOffset=0,this.plotScales=new Map,this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("broadcastCursor",t=>{const{x:i,y:s}=t.detail;this.crosshairX=i,this.crosshairY=s,this.render()}),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseout",this.handleMouseOut.bind(this)),this.canvas.addEventListener("wheel",this.handleMouseWheel.bind(this)),this.canvas.addEventListener("dblclick",this.resetVerticalScale.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this.handleTouchEnd.bind(this)),this.resizeObserver=new ResizeObserver(t=>{for(let i of t)i.target===this.container&&(this.resize(),this.render())}),this.resizeObserver.observe(this.container),this.applyTheme(this.options.theme)}static defaultOptions={theme:"light",plots:[{id:"main",heightRatio:.7,data:[],type:"line"}],initialVisibleCandles:100};static themes={light:t,dark:i};calculatePriceRange(t,i,s){let h,e;if("volume"===t.type)h=0,e=Math.max(...i.map(t=>t.volume||1));else if("line"===t.type){const i=t.data.slice(s.startIndex,s.startIndex+s.visibleCount).map(t=>t.value??t.close).filter(t=>null!==t&&isFinite(t));if(0===i.length)return{minPrice:0,maxPrice:1};const o=Math.min(...i),n=Math.max(...i),a=.1*(n-o);h=o-a,e=n+a}else{const t=i.map(t=>t.low),s=i.map(t=>t.high),o=Math.min(...t),n=Math.max(...s),a=.1*(n-o);h=o-a,e=n+a}if(this.plotScales instanceof Map&&t&&t.id){const i=this.plotScales.get(t.id)||1;if(1!==i){const t=(e+h)/2,s=(e-h)/2;h=t-s/i,e=t+s/i}}return{minPrice:h,maxPrice:e}}calculateYAxisWidth(){if(!this.ctx||!this.dataViewport)return 80;const t=this.ctx;let i=0;const s=this.canvas.width<600?10:12;t.font=`${s}px Arial`;const h=this.dataViewport.getVisibleData();return 0===h.length?80:(this.options.plots.forEach(s=>{const{minPrice:e,maxPrice:o}=this.calculatePriceRange(s,h,this.dataViewport);let n=[e,o];const a=o-e;for(let t=1;t<4;t++)n.push(e+a*t/4);n.forEach(h=>{let e;e="volume"===s.type?h>=1e6?(h/1e6).toFixed(1)+"M":h>=1e3?(h/1e3).toFixed(1)+"K":Math.round(h).toLocaleString():h>=1e3?h.toFixed(0):h>=100?h.toFixed(1):h>=10?h.toFixed(2):h.toFixed(3);const o=t.measureText(e).width;i=Math.max(i,o)})}),i+(this.canvas.width<600?4:8))}resize(){let{clientWidth:t,clientHeight:i}=this.container;0===t&&(t=window.innerWidth),0===i&&(i=window.innerHeight),this.canvas.width=t,this.canvas.height=i;const s=this.calculateYAxisWidth();this.plotLayoutManager.updateCanvasDimensions(t,i,s)}applyTheme(t){const i="string"==typeof t?n.themes[t]||n.themes.light:{...n.themes.light,...t};this.currentTheme=i,this.canvas.style.backgroundColor=i.background,this.render()}handleVerticalMouseWheel(t){if(t.ctrlKey){const i=t.deltaY<0?1.1:.9;this.priceScale*=i,this.render(),t.preventDefault()}}resetVerticalScale(){this.priceScale=1,this.priceOffset=0,this.render()}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.currentTheme.chartAreaBackground||"#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.dataViewport.getVisibleData();if(0===t.length)return this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font="20px Arial",void this.ctx.fillText("No data to display",this.canvas.width/2-80,this.canvas.height/2);const i=this.canvas.width/this.dataViewport.visibleCount,s=new Map,h=this.options.plots.find(t=>"main"===t.id);if(!h)return;const n=h.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);if(s.set("main",this.calculatePriceRange(h,n,this.dataViewport)),this.options.plots.forEach(h=>{const n=h.overlay||!1,a=n?h.targetId||"main":h.id,c=this.plotLayoutManager.getPlotLayout(a);if(!c)return;if(!n&&!s.has(h.id)){const t=h.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);s.set(h.id,this.calculatePriceRange(h,t,this.dataViewport))}const{minPrice:r,maxPrice:l}=s.get(a);if(c){if(n||(this.ctx.fillStyle=this.currentTheme.chartAreaBackground,this.ctx.fillRect(c.x,c.y,c.width,c.height),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.strokeRect(c.x,c.y,c.width,c.height)),this.options.plots.indexOf(h)!==this.options.plots.length-1&&!n){const t=c.y+c.height-this.resizeHandleHeight/2;this.ctx.fillStyle=this.isResizingPlot&&this.resizingPlotId===h.id?"rgba(150, 150, 150, 0.3)":"rgba(100, 100, 100, 0.1)",this.ctx.fillRect(c.x,t,c.width,this.resizeHandleHeight),this.ctx.fillStyle=this.currentTheme.gridColor;const i=6,s=30,e=c.x+(c.width-s)/2;for(let h=e;h<e+s;h+=i)this.ctx.beginPath(),this.ctx.arc(h,t+this.resizeHandleHeight/2,1,0,2*Math.PI),this.ctx.fill()}n||this.drawYAxisLabels(h,c,r,l),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(c.x,c.y,c.width,c.height),this.ctx.clip();const s=(h.data&&h.data.length>0?h.data:t).slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);switch(h.type){case"candlestick":s.forEach((t,s)=>{const h=c.x+e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,c.width,i),n=o(t.open,r,l,c.height,c.y),a=o(t.high,r,l,c.height,c.y),u=o(t.low,r,l,c.height,c.y),f=o(t.close,r,l,c.height,c.y);!function(t,i,s,h,e,o,n,a,c){const r=i.close>i.open?c.candleUp:c.candleDown,l=c.candleBorderColor||c.textColor;t.strokeStyle=l,t.lineWidth=1,t.beginPath(),t.moveTo(s+a/2,e),t.lineTo(s+a/2,o),t.stroke(),t.fillStyle=r,t.strokeStyle=l,t.lineWidth=1,t.fillRect(s,Math.min(h,n),a,Math.abs(h-n)),t.strokeRect(s,Math.min(h,n),a,Math.abs(h-n))}(this.ctx,t,h,n,a,u,f,.7*i,this.currentTheme)});break;case"line":let t=-1;s.forEach((n,a)=>{const u=n.value??n.close;if(null!=u&&0!==u){if(-1!==t){const n=s[t],f=c.x+e(this.dataViewport.startIndex+t,this.dataViewport.startIndex,this.dataViewport.visibleCount,c.width,i)+i/2,M=o(n.value??n.close,r,l,c.height,c.y),d=c.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,c.width,i)+i/2,m=o(u,r,l,c.height,c.y),p=h.style?.lineColor||this.currentTheme.lineColor,w=h.style?.lineWidth||2;!function(t,i,s,h,e,o,n){t.strokeStyle=o,t.lineWidth=n,t.beginPath(),t.moveTo(i,s),t.lineTo(h,e),t.stroke()}(this.ctx,f,M,d,m,p,w)}t=a}else t=-1});break;case"volume":s.forEach((t,s)=>{const h=c.x+e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,c.width,i),o=(t.volume||0)/l*c.height,n=c.y+c.height-o;this.ctx.fillStyle=this.currentTheme.volumeColor||"rgba(0, 150, 136, 0.6)",this.ctx.fillRect(h,n,.7*i,o)});break;case"histogram":s.forEach((t,s)=>{const n=c.x+e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,c.width,i),a=o(0,r,l,c.height,c.y),u=o(t.value,r,l,c.height,c.y)-a;this.ctx.fillStyle=t.value>=0?h.style?.positiveColor||this.currentTheme.positiveColor:h.style?.negativeColor||this.currentTheme.negativeColor,this.ctx.fillRect(n,a,.7*i,-u)})}}this.ctx.restore()}),this.drawXAxisLabels(),this.drawChartName(),-1!==this.crosshairX&&-1!==this.crosshairY){this.ctx.strokeStyle=this.currentTheme.crosshairColor,this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]);const t=this.options.plots[0],i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairX<=i.x+i.width&&(this.ctx.beginPath(),this.ctx.moveTo(this.crosshairX,0),this.ctx.lineTo(this.crosshairX,this.plotLayoutManager.getPlotTotalHeight()),this.ctx.stroke()),this.options.plots.forEach(t=>{if(t.overlay)return;const i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairY>=i.y&&this.crosshairY<=i.y+i.height&&(this.ctx.beginPath(),this.ctx.moveTo(0,this.crosshairY),this.ctx.lineTo(this.plotLayoutManager.getPlotTotalWidth(),this.crosshairY),this.ctx.stroke())}),this.ctx.setLineDash([]),this.displayInfoOverlay()}}handleMouseDown(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;for(const i of this.options.plots){if(i.overlay)continue;const e=this.plotLayoutManager.getPlotLayout(i.id);if(e){const o={x:e.x+e.width,y:e.y,width:50,height:e.height};if(s>=o.x&&s<=o.x+o.width&&h>=o.y&&h<=o.y+o.height)return this.isDraggingYAxis=!0,this.resizingPlotId=i.id,void(this.lastMouseY=t.clientY)}}for(let i=0;i<this.options.plots.length-1;i++){const s=this.options.plots[i];if(!s.overlay){const i=this.plotLayoutManager.getPlotLayout(s.id),e=i.y+i.height;if(Math.abs(h-e)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=s.id,void(this.lastMouseY=t.clientY)}}this.isDragging=!0,this.lastMouseX=t.clientX}handleMouseMove(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top,o=this.canvas.width/this.dataViewport.visibleCount,n=.7*o,a=this.plotLayoutManager.getPlotLayout("main");if(a){const t=s-a.x,i=Math.round(t/o-.5),h=Math.max(0,Math.min(this.dataViewport.visibleCount-1,i)),c=a.x+e(this.dataViewport.startIndex+h,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,o);this.crosshairX=c+n/2}if(this.crosshairY=h,this.isDraggingYAxis&&this.resizingPlotId){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;let s=this.plotScales.get(this.resizingPlotId)||1;return s*=Math.exp(.01*-i),s=Math.max(.1,Math.min(10,s)),this.plotScales.set(this.resizingPlotId,s),void this.render()}if(this.isResizingPlot){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;const s=this.options.plots.findIndex(t=>t.id===this.resizingPlotId);let h=s+1;for(;h<this.options.plots.length&&this.options.plots[h].overlay;)h++;if(s>=0&&h<this.options.plots.length){const t=this.options.plots[s],e=this.options.plots[h],o=t.heightRatio+e.heightRatio,n=i/(this.plotLayoutManager.getPlotLayout(t.id).height/t.heightRatio),a=.1*o,c=Math.max(a,Math.min(o-a,t.heightRatio+n));t.heightRatio=c,e.heightRatio=o-c,this.resize(),this.render()}}else if(this.isDragging){const i=t.clientX-this.lastMouseX,s=this.canvas.width/this.dataViewport.visibleCount,h=Math.round(i/s);0!==h&&(this.dataViewport.scroll(-h),this.lastMouseX=t.clientX,this.render())}else{let t=!1;for(const i of this.options.plots){if(i.overlay)continue;const s=this.plotLayoutManager.getPlotLayout(i.id);if(s){const i=s.y+s.height;if(Math.abs(this.crosshairY-i)<this.resizeHandleHeight){this.canvas.style.cursor="row-resize",t=!0;break}const h={x:s.x+s.width,y:s.y,width:50,height:s.height};if(this.crosshairX>=h.x&&this.crosshairX<=h.x+h.width&&this.crosshairY>=h.y&&this.crosshairY<=h.y+h.height){this.canvas.style.cursor="ns-resize",t=!0;break}}}t||(this.canvas.style.cursor="default"),this.render()}}handleMouseUp(t){if(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.canvas.style.cursor="default",t&&2===t.detail){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const e={x:i.x+i.width,y:i.y,width:50,height:i.height};if(s>=e.x&&s<=e.x+e.width&&h>=e.y&&h<=e.y+e.height){this.plotScales.delete(t.id),this.render();break}}}}}handleMouseOut(){this.isDragging=!1,this.crosshairX=-1,this.crosshairY=-1,this.render()}handleMouseWheel(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();t.clientX,i.left;const s=t.clientY-i.top;if(t.ctrlKey){const i=t.deltaY<0?1.1:1/1.1,h=this.plotLayoutManager.getPlotLayout("main");if(h){const t=this.maxPrice-this.minPrice,e=t/i,o=this.minPrice+(this.maxPrice-this.minPrice)*((h.y+h.height-s)/h.height);this.minPrice=o-e*((o-this.minPrice)/t),this.maxPrice=o+e*((this.maxPrice-o)/t)}this.render()}else{const i=t.deltaY<0?1.1:1/1.1,s=Math.floor(this.crosshairX/(this.canvas.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i,s),this.render()}}lastTapTime=0;lastTapX=0;lastTapY=0;touchHoldTimer=null;isCrosshairMode=!1;touchStartX=0;touchStartY=0;handleTouchStart(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();if(this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null),2===t.touches.length){this.isPinching=!0,this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.isCrosshairMode=!1;const s=t.touches[0],h=t.touches[1],e=s.clientX-i.left,o=s.clientY-i.top,n=h.clientX-i.left,a=h.clientY-i.top;this.initialPinchDistance=Math.sqrt(Math.pow(n-e,2)+Math.pow(a-o,2)),this.pinchCenterX=(e+n)/2,this.pinchCenterY=(o+a)/2}else if(1===t.touches.length){const s=t.touches[0],h=s.clientX-i.left,o=s.clientY-i.top;this.touchStartX=h,this.touchStartY=o;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const s={x:i.x+i.width,y:i.y,width:50,height:i.height};if(h>=s.x&&h<=s.x+s.width&&o>=s.y&&o<=s.y+s.height){const i=(new Date).getTime(),s=i-this.lastTapTime,e=Math.sqrt(Math.pow(h-this.lastTapX,2)+Math.pow(o-this.lastTapY,2));return s<300&&e<30?(this.plotScales.delete(t.id),this.render(),void(this.lastTapTime=0)):(this.lastTapTime=i,this.lastTapX=h,this.lastTapY=o,this.isDraggingYAxis=!0,this.resizingPlotId=t.id,void(this.lastTouchY=o))}}}for(let t=0;t<this.options.plots.length-1;t++){const i=this.options.plots[t];if(!i.overlay){const t=this.plotLayoutManager.getPlotLayout(i.id),s=t.y+t.height;if(Math.abs(o-s)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=i.id,void(this.lastTouchY=o)}}this.isDragging=!0,this.lastTouchX=h,this.lastTouchY=o,this.crosshairX=-1,this.crosshairY=-1,this.touchHoldTimer=setTimeout(()=>{if(this.isDragging){this.isCrosshairMode=!0;const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=this.canvas.width/this.dataViewport.visibleCount,s=.7*i,n=h-t.x,a=Math.round(n/i-.5),c=Math.max(0,Math.min(this.dataViewport.visibleCount-1,a)),r=t.x+e(this.dataViewport.startIndex+c,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=r+s/2,this.crosshairY=o}this.render()}},1e3)}}handleTouchMove(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();if(2===t.touches.length&&this.isPinching){const s=t.touches[0],h=t.touches[1],e=s.clientX-i.left,o=s.clientY-i.top,n=h.clientX-i.left,a=h.clientY-i.top,c=Math.sqrt(Math.pow(n-e,2)+Math.pow(a-o,2));if(this.initialPinchDistance>0){const t=.5,i=1+(c/this.initialPinchDistance-1)*t,s=(e+n)/2,h=(o+a)/2;let r=null;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i&&h>=i.y&&h<=i.y+i.height){r=t.id;break}}if(r){const t=Math.abs(h-this.pinchCenterY),e=Math.abs(s-this.pinchCenterX),o=.05;if(Math.abs(i-1)>o)if(t>e){let t=this.plotScales.get(r)||1;t*=1+.5*(i-1),t=Math.max(.1,Math.min(10,t)),this.plotScales.set(r,t)}else{const t=.05,h=1+(i>1?t:-t),e=Math.floor(s/(this.canvas.width/this.dataViewport.visibleCount));this.dataViewport.zoom(h,e)}}this.pinchCenterX=s,this.pinchCenterY=h,this.initialPinchDistance=c,this.render()}}else if(1===t.touches.length){const s=t.touches[0],h=s.clientX-i.left,o=s.clientY-i.top,n=this.canvas.width/this.dataViewport.visibleCount,a=.7*n,c=this.plotLayoutManager.getPlotLayout("main");if(c)if(this.isCrosshairMode){const t=h-c.x,i=Math.round(t/n-.5),s=Math.max(0,Math.min(this.dataViewport.visibleCount-1,i)),r=c.x+e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,c.width,n);this.crosshairX=r+a/2,this.crosshairY=o}else this.crosshairX=-1,this.crosshairY=-1;if(this.isDraggingYAxis&&this.resizingPlotId){const t=o-this.lastTouchY;this.lastTouchY=o;let i=this.plotScales.get(this.resizingPlotId)||1;i*=Math.exp(.01*-t),i=Math.max(.1,Math.min(10,i)),this.plotScales.set(this.resizingPlotId,i),this.render()}else if(this.isResizingPlot&&this.resizingPlotId){const t=o-this.lastTouchY;this.lastTouchY=o;const i=this.options.plots.findIndex(t=>t.id===this.resizingPlotId);let s=i+1;for(;s<this.options.plots.length&&this.options.plots[s].overlay;)s++;if(i>=0&&s<this.options.plots.length){const h=this.options.plots[i],e=this.options.plots[s],o=h.heightRatio+e.heightRatio,n=t/(this.plotLayoutManager.getPlotLayout(h.id).height/h.heightRatio),a=.1*o,c=Math.max(a,Math.min(o-a,h.heightRatio+n));h.heightRatio=c,e.heightRatio=o-c,this.resize(),this.render()}}else if(this.isDragging){const t=h-this.lastTouchX,i=this.canvas.width/this.dataViewport.visibleCount,s=Math.round(t/i);if(this.isCrosshairMode){if(this.isCrosshairMode){const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=this.canvas.width/this.dataViewport.visibleCount,s=.7*i,n=h-t.x,a=Math.round(n/i-.5),c=Math.max(0,Math.min(this.dataViewport.visibleCount-1,a)),r=t.x+e(this.dataViewport.startIndex+c,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=r+s/2,this.crosshairY=o,this.render()}}}else 0!==s&&(this.dataViewport.scroll(-s),this.lastTouchX=h,this.crosshairX=-1,this.crosshairY=-1,this.render())}}}handleTouchEnd(t){t.preventDefault(),this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null),this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.isPinching=!1,this.initialPinchDistance=0,this.isCrosshairMode||(this.crosshairX=-1,this.crosshairY=-1),this.isCrosshairMode=!1,this.render()}drawChartName(){const{chartName:t}=this.options;if(!t)return;const{name:i,code:s,metaString:h}=t,{textColor:e}=this.currentTheme,o=this.canvas.width<600?10:14;let n=20;this.ctx.fillStyle=e,this.ctx.textAlign="left",i&&(this.ctx.font=`bold ${o+2}px Arial`,this.ctx.fillText(i,10,n),n+=o+4),s&&(this.ctx.font=`${o}px Arial`,this.ctx.fillText(s,10,n),n+=o+2),h&&(this.ctx.font=`italic ${o-1}px Arial`,this.ctx.fillText(h,10,n))}drawXAxisLabels(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width,h=Math.max(10,Math.min(12,Math.floor(s/50))),o=8*h,n=Math.floor(s/o),a=n>10?10:n,c=Math.max(1,Math.floor(t.length/a));this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font=`${h}px Arial`,this.ctx.textAlign="center";const r=this.canvas.height-h,l=new Date(1e3*t[0].time);new Date(1e3*t[t.length-1].time).getTime(),l.getTime();for(let s=0;s<t.length;s+=c){const h=t[s];if(!h||!h.time)continue;const o=e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,i.width/this.dataViewport.visibleCount),n=new Date(1e3*h.time).toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"});o>=i.x&&o<=i.x+i.width&&this.ctx.fillText(n,o,r)}}drawYAxisLabels(t,i,s,h){this.ctx.fillStyle=this.currentTheme.textColor;const e=this.canvas.width<600?10:12;this.ctx.font=`${e}px Arial`,this.ctx.textAlign="left";const n=e+4,a=Math.max(3,Math.min(8,Math.floor(i.height/n))),c=Math.min(5,a),r=(h-s)/c,l=[];for(let t=0;t<=c;t++){const e=s+t*r,n=o(e,s,h,i.height,i.y);l.push({price:e,y:n})}const u=l.filter(({y:t})=>{const s=1.5*e;return t>=i.y+s&&t<=i.y+i.height-s});let f=u;if(u.length<2&&l.length>=2){const t=l[0],s=l[l.length-1];f=[{...t,y:Math.max(i.y+e,t.y)},{...s,y:Math.min(i.y+i.height-e,s.y)}]}f.forEach(({price:s,y:h})=>{let o;this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.setLineDash([2,2]),this.ctx.moveTo(i.x,h),this.ctx.lineTo(i.x+i.width,h),this.ctx.stroke(),this.ctx.setLineDash([]),o="volume"===t.type?s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(1)+"K":Math.round(s).toLocaleString():s>=1e3?s.toFixed(0):s>=100?s.toFixed(1):s>=10?s.toFixed(2):s.toFixed(3);const n=i.x+i.width+4;this.ctx.fillText(o,n,h+e/3)}),this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.moveTo(i.x+i.width,i.y),this.ctx.lineTo(i.x+i.width,i.y+i.height),this.ctx.stroke()}displayInfoOverlay(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.canvas.width/this.dataViewport.visibleCount,s=Math.floor(this.crosshairX/i),h=this.dataViewport.startIndex+s;this.options.plots.forEach(i=>{const s=this.plotLayoutManager.getPlotLayout(i.id);if(!s||i.overlay)return;const e=i.data&&i.data.length>0?i.data:t;if(h>=0&&h<e.length){const l=e[h];if(this.ctx.fillStyle=this.currentTheme.overlayTextColor,this.ctx.font="12px Arial",this.crosshairY>=s.y&&this.crosshairY<=s.y+s.height){const{minPrice:h,maxPrice:e}=this.calculatePriceRange(i,t,this.dataViewport),l=(o=this.crosshairY,n=s.y,c=h,r=e,0===(a=s.height)?(r+c)/2:c+(1-(o-n)/a)*(r-c));let u;u="volume"===i.type?l>=1e6?(l/1e6).toFixed(2)+"M":l>=1e3?(l/1e3).toFixed(2)+"K":Math.round(l).toString():l>=1e3?l.toFixed(0):l>=100?l.toFixed(1):l>=10?l.toFixed(2):l.toFixed(3),this.ctx.textAlign="left";const f=this.plotLayoutManager.getPlotTotalWidth()+5;this.ctx.fillText(u,f,this.crosshairY)}if("main"===i.id&&void 0!==l.time){const t=new Date(1e3*l.time).toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"});this.ctx.textAlign="center";const i=this.plotLayoutManager.getPlotTotalHeight()+15;this.ctx.fillText(t,this.crosshairX,i)}const u=this.options.plots.filter(t=>t.targetId===i.id||t.id===i.id),f=[];u.forEach(i=>{const s=i.data&&i.data.length>0?i.data:t;if(h>=0&&h<s.length){const t=s[h],e=Object.entries(t).map(([t,s])=>{if("time"===t||"date"===t||"keyLabel"===t)return null;const h="number"==typeof s?s.toFixed(2):s;return`${i.keyLabel?.trim().length>0?i.keyLabel:t.charAt(0).toUpperCase()+t.slice(1)}: ${h}`}).filter(Boolean).join(" | ");e&&f.push(e)}});const M=15,d=10,m=s.x+s.width-d;if(this.ctx.textAlign="right",!u.some(t=>"main"===t.id||"main"===t.targetId)){const t=f.join(" | ");f.length=0,f.push(t)}f.forEach((t,i)=>{const h=s.y+(i+1)*M;this.ctx.fillText(t,m,h)}),this.ctx.textAlign="left"}var o,n,a,c,r})}renderOverlayPanels(){this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.font="10px Arial",this.ctx.fillText("Overlay panels reserved for indicators",10,this.canvas.height-10),this.ctx.restore()}ensureContainerSize(t){t.clientHeight<1&&(t.style.height=.9*window.innerHeight+"px"),t.clientWidth<1&&(t.style.width=.9*window.innerWidth+"px")}}return n});//# sourceMappingURL=stock-chart.umd.min.js.map

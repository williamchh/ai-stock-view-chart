!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).StockChart=i()}(this,function(){"use strict";const t={name:"light",background:"#FFFFFF",chartAreaBackground:"#F8F8F8",gridColor:"#E0E0E0",textColor:"#333333",candleUp:"#4CAF50",candleDown:"#F44336",candleBorderColor:"#333333",lineColor:"#2196F3",crosshairColor:"#9E9E9E",overlayTextColor:"#333333",positiveColor:"rgba(76, 175, 80, 0.8)",negativeColor:"rgba(244, 67, 54, 0.8)"},i={name:"dark",background:"#1A1A1A",chartAreaBackground:"#2C2C2C",gridColor:"#444444",textColor:"#E0E0E0",candleUp:"#66BB6A",candleDown:"#EF5350",candleBorderColor:"#E0E0E0",lineColor:"#64B5F6",crosshairColor:"#BDBDBD",overlayTextColor:"#E0E0E0",positiveColor:"rgba(102, 187, 106, 0.8)",negativeColor:"rgba(239, 83, 80, 0.8)"};class s{plotTotalHeight;plotTotalWidth;yAxisWidth=80;bottomMargin=40;leftMargin=0;topMargin=0;constructor(t,i,s){this.canvasWidth=t,this.canvasHeight=i,this.plotConfigs=s,this.plots={},this.calculateLayout()}calculateLayout(){let t=0;const i=this.plotConfigs.filter(t=>!t.overlay).reduce((t,i)=>t+i.heightRatio,0);this.plotConfigs.forEach(s=>{if(s.overlay){const t=this.plots.main;t&&(this.plots[s.id]={...t})}else{const h=this.canvasWidth-this.leftMargin-this.yAxisWidth,e=this.canvasHeight-this.topMargin-this.bottomMargin,n=s.heightRatio/i*e;this.plots[s.id]={x:this.leftMargin,y:t+this.topMargin,width:h,height:n},t+=n}}),this.plotTotalHeight=t,this.plotTotalWidth=this.canvasWidth-this.yAxisWidth}getPlotLayout(t){return this.plots[t]||null}updateCanvasDimensions(t,i,s=void 0){this.canvasWidth=t,this.canvasHeight=i,void 0!==s&&(this.yAxisWidth=s),this.calculateLayout()}getPlotTotalWidth(){return this.plotTotalWidth}getPlotTotalHeight(){return this.plotTotalHeight}}class h{constructor(t,i,s=0){this.allData=t,this.visibleCount=Math.min(i,t.length+s),this.rightPadding=s,this.maxStartIndex=Math.max(0,t.length-this.visibleCount+s),this.startIndex=Math.min(Math.max(0,this.maxStartIndex),Math.max(0,t.length-this.visibleCount))}MIN_PORT_VISIBLE_COUNT=10;getVisibleData(){const t=Math.min(this.startIndex+this.visibleCount,this.allData.length);return this.allData.slice(this.startIndex,t)}scroll(t){this.maxStartIndex=this.allData.length-this.visibleCount+this.rightPadding;const i=this.startIndex+t,s=Math.min(Math.round(.1*this.visibleCount),Math.round(.1*this.allData.length)),h=this.maxStartIndex+s;this.startIndex=Math.max(0,Math.min(h,i))}zoom(t,i){if(t<1&&this.startIndex<=0&&(window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount),zoomFactor:t,anchorIndex:i}})),0===this.startIndex))return;const s=this.startIndex+i;let h=t;Math.round(this.visibleCount/t)>200&&t<.99&&(h*=.99);const e=Math.max(this.MIN_PORT_VISIBLE_COUNT,Math.min(this.allData.length,Math.round(this.visibleCount/h))),n=i/this.visibleCount,o=s-Math.round(e*n);this.visibleCount=e,this.maxStartIndex=Math.max(0,this.allData.length-this.visibleCount);const a=Math.round(.05*this.visibleCount),c=Math.max(-a,0),r=this.maxStartIndex+a;this.startIndex=Math.max(c,Math.min(r,o)),this.startIndex<=c&&t<1&&window.dispatchEvent(new CustomEvent("requestOlderData",{detail:{currentOldestDataTime:this.allData[0]?.time,requestedCount:Math.round(.5*this.visibleCount)}}))}updateData(t){this.allData=t,this.startIndex=Math.max(0,this.allData.length-this.visibleCount)}}function e(t,i,s,h,e){return(t-i)*e}function n(t,i,s,h,e){const n=s-i;return 0===n?e+h/2:e+h-(t-i)/n*h}class o{static init(t,i){const s=document.getElementById(t);if(!s)return;const h=new o(s,i);return h.render(),h}constructor(t,i){this.ensureContainerSize(t),this.container=t,this.options={...o.defaultOptions,...i},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.initialPinchDistance=0,this.isPinching=!1;const e=this.options.plots?.find(t=>"main"===t.id);if(!e)throw new Error("StockChart options must include a plot with id 'main'.");this.dataViewport=new h(e.data||[],this.options.initialVisibleCandles,5),this.plotLayoutManager=new s(this.canvas.width,this.canvas.height,this.options.plots),this.resize(),this.isDragging=!1,this.isResizingPlot=!1,this.resizingPlotId=null,this.isDraggingYAxis=!1,this.lastMouseX=0,this.lastMouseY=0,this.lastTouchX=0,this.lastTouchY=0,this.crosshairX=-1,this.crosshairY=-1,this.resizeHandleHeight=10,this.minPrice=0,this.maxPrice=0,this.priceScale=1,this.priceOffset=0,this.plotScales=new Map,this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("broadcastCursor",t=>{const{x:i,y:s}=t.detail;this.crosshairX=i,this.crosshairY=s,this.render()}),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseout",this.handleMouseOut.bind(this)),this.canvas.addEventListener("wheel",this.handleMouseWheel.bind(this)),this.canvas.addEventListener("dblclick",this.resetVerticalScale.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this)),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.canvas.addEventListener("touchcancel",this.handleTouchEnd.bind(this)),this.resizeObserver=new ResizeObserver(t=>{for(let i of t)i.target===this.container&&(this.resize(),this.render())}),this.resizeObserver.observe(this.container),this.applyTheme(this.options.theme)}static defaultOptions={theme:"light",plots:[{id:"main",heightRatio:.7,data:[],type:"line"}],initialVisibleCandles:100};static themes={light:t,dark:i};calculatePriceRange(t,i,s){let h,e;if("volume"===t.type)h=0,e=Math.max(...i.map(t=>t.volume||1));else if("line"===t.type){const i=t.data.slice(s.startIndex,s.startIndex+s.visibleCount).map(t=>t.value??t.close).filter(t=>null!==t&&isFinite(t));if(0===i.length)return{minPrice:0,maxPrice:1};const n=Math.min(...i),o=Math.max(...i),a=.1*(o-n);h=n-a,e=o+a}else{const t=i.map(t=>t.low),s=i.map(t=>t.high),n=Math.min(...t),o=Math.max(...s),a=.1*(o-n);h=n-a,e=o+a}if(this.plotScales instanceof Map&&t&&t.id){const i=this.plotScales.get(t.id)||1;if(1!==i){const t=(e+h)/2,s=(e-h)/2;h=t-s/i,e=t+s/i}}return{minPrice:h,maxPrice:e}}calculateYAxisWidth(){if(!this.ctx||!this.dataViewport)return 80;const t=this.ctx;let i=0;const s=this.canvas.width<600?10:12;t.font=`${s}px Arial`;const h=this.dataViewport.getVisibleData();return 0===h.length?80:(this.options.plots.forEach(s=>{const{minPrice:e,maxPrice:n}=this.calculatePriceRange(s,h,this.dataViewport);let o=[e,n];const a=n-e;for(let t=1;t<4;t++)o.push(e+a*t/4);o.forEach(h=>{let e;e="volume"===s.type?h>=1e6?(h/1e6).toFixed(1)+"M":h>=1e3?(h/1e3).toFixed(1)+"K":Math.round(h).toLocaleString():h>=1e3?h.toFixed(0):h>=100?h.toFixed(1):h>=10?h.toFixed(2):h.toFixed(3);const n=t.measureText(e).width;i=Math.max(i,n)})}),i+(this.canvas.width<600?4:8))}resize(){let{clientWidth:t,clientHeight:i}=this.container;0===t&&(t=window.innerWidth),0===i&&(i=window.innerHeight),this.canvas.width=t,this.canvas.height=i;const s=this.calculateYAxisWidth();this.plotLayoutManager.updateCanvasDimensions(t,i,s)}applyTheme(t){const i="string"==typeof t?o.themes[t]||o.themes.light:{...o.themes.light,...t};this.currentTheme=i,this.canvas.style.backgroundColor=i.background,this.render()}handleVerticalMouseWheel(t){if(t.ctrlKey){const i=t.deltaY<0?1.1:.9;this.priceScale*=i,this.render(),t.preventDefault()}}resetVerticalScale(){this.priceScale=1,this.priceOffset=0,this.render()}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.currentTheme.chartAreaBackground||"#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.dataViewport.getVisibleData();if(0===t.length)return this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font="20px Arial",void this.ctx.fillText("No data to display",this.canvas.width/2-80,this.canvas.height/2);const i=new Map,s=this.options.plots.find(t=>"main"===t.id);if(!s)return;const h=s.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);if(i.set("main",this.calculatePriceRange(s,h,this.dataViewport)),this.options.plots.forEach(s=>{const h=s.overlay||!1,o=h?s.targetId||"main":s.id,a=this.plotLayoutManager.getPlotLayout(o);if(!a)return;const c=a.width/this.dataViewport.visibleCount;if(!h&&!i.has(s.id)){const t=s.data.slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);i.set(s.id,this.calculatePriceRange(s,t,this.dataViewport))}const{minPrice:r,maxPrice:l}=i.get(o);if(a){if(h||(this.ctx.fillStyle=this.currentTheme.chartAreaBackground,this.ctx.fillRect(a.x,a.y,a.width,a.height),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.strokeRect(a.x,a.y,a.width,a.height)),this.options.plots.indexOf(s)!==this.options.plots.length-1&&!h){const t=a.y+a.height-this.resizeHandleHeight/2;this.ctx.fillStyle=this.isResizingPlot&&this.resizingPlotId===s.id?"rgba(150, 150, 150, 0.3)":"rgba(100, 100, 100, 0.1)",this.ctx.fillRect(a.x,t,a.width,this.resizeHandleHeight),this.ctx.fillStyle=this.currentTheme.gridColor;const i=6,h=30,e=a.x+(a.width-h)/2;for(let s=e;s<e+h;s+=i)this.ctx.beginPath(),this.ctx.arc(s,t+this.resizeHandleHeight/2,1,0,2*Math.PI),this.ctx.fill()}h||this.drawYAxisLabels(s,a,r,l),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(a.x,a.y,a.width,a.height),this.ctx.clip();const i=(s.data&&s.data.length>0?s.data:t).slice(this.dataViewport.startIndex,this.dataViewport.startIndex+this.dataViewport.visibleCount);switch(s.type){case"candlestick":i.forEach((t,i)=>{const s=.7*c,h=a.x+e(this.dataViewport.startIndex+i,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,c)+(c-s)/2,o=n(t.open,r,l,a.height,a.y),u=n(t.high,r,l,a.height,a.y),f=n(t.low,r,l,a.height,a.y),M=n(t.close,r,l,a.height,a.y);!function(t,i,s,h,e,n,o,a,c){const r=i.close>i.open?c.candleUp:c.candleDown,l=c.candleBorderColor||c.textColor;t.strokeStyle=l,t.lineWidth=1,t.beginPath(),t.moveTo(s+a/2,e),t.lineTo(s+a/2,n),t.stroke(),t.fillStyle=r,t.strokeStyle=l,t.lineWidth=1,t.fillRect(s,Math.min(h,o),a,Math.abs(h-o)),t.strokeRect(s,Math.min(h,o),a,Math.abs(h-o))}(this.ctx,t,h,o,u,f,M,s,this.currentTheme)});break;case"line":let t=-1;i.forEach((h,o)=>{const u=h.value??h.close;if(null!=u&&0!==u){if(-1!==t){const h=i[t],f=a.x+e(this.dataViewport.startIndex+t,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,c)+c/2,M=n(h.value??h.close,r,l,a.height,a.y),d=a.x+e(this.dataViewport.startIndex+o,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,c)+c/2,m=n(u,r,l,a.height,a.y),p=s.style?.lineColor||this.currentTheme.lineColor,w=s.style?.lineWidth||2;!function(t,i,s,h,e,n,o){t.strokeStyle=n,t.lineWidth=o,t.beginPath(),t.moveTo(i,s),t.lineTo(h,e),t.stroke()}(this.ctx,f,M,d,m,p,w)}t=o}else t=-1});break;case"volume":i.forEach((t,i)=>{const s=.7*c,h=a.x+e(this.dataViewport.startIndex+i,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,c)+(c-s)/2,n=(t.volume||0)/l*a.height,o=a.y+a.height-n;this.ctx.fillStyle=this.currentTheme.volumeColor||"rgba(0, 150, 136, 0.6)",this.ctx.fillRect(h,o,s,n)});break;case"histogram":i.forEach((t,i)=>{const h=.7*c,o=a.x+e(this.dataViewport.startIndex+i,this.dataViewport.startIndex,this.dataViewport.visibleCount,a.width,c)+(c-h)/2,u=n(0,r,l,a.height,a.y),f=n(t.value,r,l,a.height,a.y)-u;this.ctx.fillStyle=t.value>=0?s.style?.positiveColor||this.currentTheme.positiveColor:s.style?.negativeColor||this.currentTheme.negativeColor,this.ctx.fillRect(o,u,h,f)})}}this.ctx.restore()}),this.drawXAxisLabels(),this.drawChartName(),-1!==this.crosshairX&&-1!==this.crosshairY){this.ctx.strokeStyle=this.currentTheme.crosshairColor,this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]);const t=this.options.plots[0],i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairX<=i.x+i.width&&(this.ctx.beginPath(),this.ctx.moveTo(this.crosshairX,0),this.ctx.lineTo(this.crosshairX,this.plotLayoutManager.getPlotTotalHeight()),this.ctx.stroke()),this.options.plots.forEach(t=>{if(t.overlay)return;const i=this.plotLayoutManager.getPlotLayout(t.id);i&&this.crosshairY>=i.y&&this.crosshairY<=i.y+i.height&&(this.ctx.beginPath(),this.ctx.moveTo(0,this.crosshairY),this.ctx.lineTo(this.plotLayoutManager.getPlotTotalWidth(),this.crosshairY),this.ctx.stroke())}),this.ctx.setLineDash([]),this.displayInfoOverlay()}}handleMouseDown(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;for(const i of this.options.plots){if(i.overlay)continue;const e=this.plotLayoutManager.getPlotLayout(i.id);if(e){const n={x:e.x+e.width,y:e.y,width:50,height:e.height};if(s>=n.x&&s<=n.x+n.width&&h>=n.y&&h<=n.y+n.height)return this.isDraggingYAxis=!0,this.resizingPlotId=i.id,void(this.lastMouseY=t.clientY)}}for(let i=0;i<this.options.plots.length-1;i++){const s=this.options.plots[i];if(!s.overlay){const i=this.plotLayoutManager.getPlotLayout(s.id),e=i.y+i.height;if(Math.abs(h-e)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=s.id,void(this.lastMouseY=t.clientY)}}this.isDragging=!0,this.lastMouseX=t.clientX}handleMouseMove(t){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top,n=this.plotLayoutManager.getPlotLayout("main");if(n){const t=n.width/this.dataViewport.visibleCount,i=s-n.x,h=Math.round(i/t-.5),o=Math.max(0,Math.min(this.dataViewport.visibleCount-1,h)),a=n.x+e(this.dataViewport.startIndex+o,this.dataViewport.startIndex,this.dataViewport.visibleCount,n.width,t);this.crosshairX=a+t/2}if(this.crosshairY=h,this.isDraggingYAxis&&this.resizingPlotId){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;let s=this.plotScales.get(this.resizingPlotId)||1;return s*=Math.exp(.01*-i),s=Math.max(.1,Math.min(10,s)),this.plotScales.set(this.resizingPlotId,s),void this.render()}if(this.isResizingPlot){const i=t.clientY-this.lastMouseY;this.lastMouseY=t.clientY;const s=this.options.plots.findIndex(t=>t.id===this.resizingPlotId);let h=s+1;for(;h<this.options.plots.length&&this.options.plots[h].overlay;)h++;if(s>=0&&h<this.options.plots.length){const t=this.options.plots[s],e=this.options.plots[h],n=t.heightRatio+e.heightRatio,o=i/(this.plotLayoutManager.getPlotLayout(t.id).height/t.heightRatio),a=.1*n,c=Math.max(a,Math.min(n-a,t.heightRatio+o));t.heightRatio=c,e.heightRatio=n-c,this.resize(),this.render()}}else if(this.isDragging){const i=t.clientX-this.lastMouseX,s=this.plotLayoutManager.getPlotLayout("main"),h=s?s.width/this.dataViewport.visibleCount:this.canvas.width/this.dataViewport.visibleCount,e=Math.round(i/h);0!==e&&(this.dataViewport.scroll(-e),this.lastMouseX=t.clientX,this.render())}else{let t=!1;for(const i of this.options.plots){if(i.overlay)continue;const s=this.plotLayoutManager.getPlotLayout(i.id);if(s){const i=s.y+s.height;if(Math.abs(this.crosshairY-i)<this.resizeHandleHeight){this.canvas.style.cursor="row-resize",t=!0;break}const h={x:s.x+s.width,y:s.y,width:50,height:s.height};if(this.crosshairX>=h.x&&this.crosshairX<=h.x+h.width&&this.crosshairY>=h.y&&this.crosshairY<=h.y+h.height){this.canvas.style.cursor="ns-resize",t=!0;break}}}t||(this.canvas.style.cursor="default"),this.render()}}handleMouseUp(t){if(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.canvas.style.cursor="default",t&&2===t.detail){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,h=t.clientY-i.top;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const e={x:i.x+i.width,y:i.y,width:50,height:i.height};if(s>=e.x&&s<=e.x+e.width&&h>=e.y&&h<=e.y+e.height){this.plotScales.delete(t.id),this.render();break}}}}}handleMouseOut(){this.isDragging=!1,this.crosshairX=-1,this.crosshairY=-1,this.render()}handleMouseWheel(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();t.clientX,i.left;const s=t.clientY-i.top;if(t.ctrlKey){const i=t.deltaY<0?1.1:1/1.1,h=this.plotLayoutManager.getPlotLayout("main");if(h){const t=this.maxPrice-this.minPrice,e=t/i,n=this.minPrice+(this.maxPrice-this.minPrice)*((h.y+h.height-s)/h.height);this.minPrice=n-e*((n-this.minPrice)/t),this.maxPrice=n+e*((this.maxPrice-n)/t)}this.render()}else{const i=t.deltaY<0?1.1:.901,s=Math.floor(this.crosshairX/(this.canvas.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i,s),this.render()}}lastTapTime=0;lastTapX=0;lastTapY=0;touchHoldTimer=null;isCrosshairMode=!1;touchStartX=0;touchStartY=0;handleTouchStart(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();if(this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null),t.touches.length!==this.lastTouchCount&&(this.isPinching=!1,this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.isCrosshairMode=!1,this.initialPinchDistance=0),this.lastTouchCount=t.touches.length,2===t.touches.length){const s=t.touches[0],h=t.touches[1],e=s.clientX-i.left,n=s.clientY-i.top,o=h.clientX-i.left,a=h.clientY-i.top,c=Math.sqrt(Math.pow(o-e,2)+Math.pow(a-n,2));c>30&&(this.isPinching=!0,this.initialPinchDistance=c,this.pinchCenterX=(e+o)/2,this.pinchCenterY=(n+a)/2,this.lastPinchDistance=c),this.initialPinchDistance=Math.sqrt(Math.pow(o-e,2)+Math.pow(a-n,2)),this.pinchCenterX=(e+o)/2,this.pinchCenterY=(n+a)/2}else if(1===t.touches.length){const s=t.touches[0],h=s.clientX-i.left,n=s.clientY-i.top;this.initialTouchX=h,this.initialTouchY=n,this.lastTouchX=h,this.lastTouchY=n;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i){const s={x:i.x+i.width,y:i.y,width:50,height:i.height};if(h>=s.x&&h<=s.x+s.width&&n>=s.y&&n<=s.y+s.height){const i=(new Date).getTime(),s=i-this.lastTapTime,e=Math.sqrt(Math.pow(h-this.lastTapX,2)+Math.pow(n-this.lastTapY,2));return s<300&&e<30?(this.plotScales.delete(t.id),this.render(),void(this.lastTapTime=0)):(this.lastTapTime=i,this.lastTapX=h,this.lastTapY=n,this.isDraggingYAxis=!0,this.resizingPlotId=t.id,void(this.lastTouchY=n))}}}for(let t=0;t<this.options.plots.length-1;t++){const i=this.options.plots[t];if(!i.overlay){const t=this.plotLayoutManager.getPlotLayout(i.id),s=t.y+t.height;if(Math.abs(n-s)<this.resizeHandleHeight)return this.isResizingPlot=!0,this.resizingPlotId=i.id,void(this.lastTouchY=n)}}this.isDragging=!0,this.lastTouchX=h,this.lastTouchY=n,this.crosshairX=-1,this.crosshairY=-1,this.touchHoldTimer=setTimeout(()=>{if(this.isDragging){this.isCrosshairMode=!0;const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=t.width/this.dataViewport.visibleCount,s=h-t.x,o=Math.round(s/i-.5),a=Math.max(0,Math.min(this.dataViewport.visibleCount-1,o)),c=t.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=c+i/2,this.crosshairY=n}this.render()}},1e3)}}handleTouchMove(t){t.preventDefault();const i=this.canvas.getBoundingClientRect();if(2===t.touches.length&&this.isPinching){const s=t.touches[0],h=t.touches[1],e=s.clientX-i.left,n=s.clientY-i.top,o=h.clientX-i.left,a=h.clientY-i.top,c=Math.sqrt(Math.pow(o-e,2)+Math.pow(a-n,2));if(this.initialPinchDistance>10&&c>10){const t=c/this.initialPinchDistance,i=(e+o)/2,s=(n+a)/2,h=.3,r=this.pinchCenterX?this.pinchCenterX*(1-h)+i*h:i,l=this.pinchCenterY?this.pinchCenterY*(1-h)+s*h:s;let u=null;for(const t of this.options.plots){if(t.overlay)continue;const i=this.plotLayoutManager.getPlotLayout(t.id);if(i&&l>=i.y&&l<=i.y+i.height){u=t.id;break}}if(u){const i=Math.abs(l-this.pinchCenterY),s=Math.abs(r-this.pinchCenterX),h=.002,e=Math.abs(t-1);if(e>h){const h=1+(t-1)*Math.min(.3,.5*e);if(i>1.2*s){let t=this.plotScales.get(u)||1;t*=Math.exp(.3*(h-1)),t=Math.max(.1,Math.min(10,t)),this.plotScales.set(u,t)}else{const t=.02,i=Math.exp((h-1)*t),s=this.plotLayoutManager.getPlotLayout(u),e=Math.floor((r-s.x)/(s.width/this.dataViewport.visibleCount));this.dataViewport.zoom(i>1?1.03:.97,e)}}}this.pinchCenterX=r,this.pinchCenterY=l,this.initialPinchDistance=c,this.render()}}else if(1===t.touches.length){const s=t.touches[0],h=s.clientX-i.left,n=s.clientY-i.top,o=this.plotLayoutManager.getPlotLayout("main");if(o){const t=o.width/this.dataViewport.visibleCount;if(this.isCrosshairMode){const i=h-o.x,s=Math.round(i/t-.5),a=Math.max(0,Math.min(this.dataViewport.visibleCount-1,s)),c=o.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,o.width,t);this.crosshairX=c+t/2,this.crosshairY=n}else if(this.isDragging){const t=Math.abs(h-this.initialTouchX),i=Math.abs(n-this.initialTouchY);Math.sqrt(t*t+i*i)>10&&this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null,this.isCrosshairMode=!1,this.crosshairX=-1,this.crosshairY=-1)}}if(this.isDraggingYAxis&&this.resizingPlotId){const t=n-this.lastTouchY;this.lastTouchY=n;let i=this.plotScales.get(this.resizingPlotId)||1;i*=Math.exp(.01*-t),i=Math.max(.1,Math.min(10,i)),this.plotScales.set(this.resizingPlotId,i),this.render()}else if(this.isResizingPlot&&this.resizingPlotId){const t=n-this.lastTouchY;this.lastTouchY=n;const i=this.options.plots.findIndex(t=>t.id===this.resizingPlotId);let s=i+1;for(;s<this.options.plots.length&&this.options.plots[s].overlay;)s++;if(i>=0&&s<this.options.plots.length){const h=this.options.plots[i],e=this.options.plots[s],n=h.heightRatio+e.heightRatio,o=t/(this.plotLayoutManager.getPlotLayout(h.id).height/h.heightRatio),a=.1*n,c=Math.max(a,Math.min(n-a,h.heightRatio+o));h.heightRatio=c,e.heightRatio=n-c,this.resize(),this.render()}}else if(this.isDragging){const t=h-this.lastTouchX,i=this.plotLayoutManager.getPlotLayout("main"),s=i?i.width/this.dataViewport.visibleCount:this.canvas.width/this.dataViewport.visibleCount,o=Math.round(t/s);if(this.isCrosshairMode){const t=this.plotLayoutManager.getPlotLayout("main");if(t){const i=t.width/this.dataViewport.visibleCount,s=h-t.x,o=Math.round(s/i-.5),a=Math.max(0,Math.min(this.dataViewport.visibleCount-1,o)),c=t.x+e(this.dataViewport.startIndex+a,this.dataViewport.startIndex,this.dataViewport.visibleCount,t.width,i);this.crosshairX=c+i/2,this.crosshairY=n,this.render()}}else 0!==o&&(this.dataViewport.scroll(-o),this.lastTouchX=h,this.render())}}}handleTouchEnd(t){t.preventDefault(),this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null);const i=this.lastTouchCount;if(this.lastTouchCount=t.touches.length,2===i&&1===t.touches.length){this.isPinching=!1,this.initialPinchDistance=0,this.lastPinchDistance=0;const i=t.touches[0],s=this.canvas.getBoundingClientRect();this.lastTouchX=i.clientX-s.left,this.lastTouchY=i.clientY-s.top,this.isDragging=!0}else 0===t.touches.length&&(this.isDragging=!1,this.isResizingPlot=!1,this.isDraggingYAxis=!1,this.resizingPlotId=null,this.isPinching=!1,this.initialPinchDistance=0,this.lastPinchDistance=0,this.isCrosshairMode||(this.crosshairX=-1,this.crosshairY=-1),this.isCrosshairMode=!1);this.render()}drawChartName(){const{chartName:t}=this.options;if(!t)return;const{name:i,code:s,metaString:h}=t,{textColor:e}=this.currentTheme,n=this.canvas.width<600?10:14;let o=20;this.ctx.fillStyle=e,this.ctx.textAlign="left",i&&(this.ctx.font=`bold ${n+2}px Arial`,this.ctx.fillText(i,10,o),o+=n+4),s&&(this.ctx.font=`${n}px Arial`,this.ctx.fillText(s,10,o),o+=n+2),h&&(this.ctx.font=`italic ${n-1}px Arial`,this.ctx.fillText(h,10,o))}drawXAxisLabels(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width,h=Math.max(10,Math.min(12,Math.floor(s/50))),n=8*h,o=Math.floor(s/n),a=o>10?10:o,c=Math.max(1,Math.floor(t.length/a));this.ctx.fillStyle=this.currentTheme.textColor,this.ctx.font=`${h}px Arial`,this.ctx.textAlign="center";const r=this.canvas.height-h,l=new Date(1e3*t[0].time);new Date(1e3*t[t.length-1].time).getTime(),l.getTime();const u=i.width/this.dataViewport.visibleCount;for(let s=0;s<t.length;s+=c){const h=t[s];if(!h||!h.time)continue;const n=e(this.dataViewport.startIndex+s,this.dataViewport.startIndex,this.dataViewport.visibleCount,i.width,u),o=new Date(1e3*h.time).toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"}),a=i.x+n+u/2;a>=i.x&&a<=i.x+i.width&&this.ctx.fillText(o,a,r)}}drawYAxisLabels(t,i,s,h){this.ctx.fillStyle=this.currentTheme.textColor;const e=this.canvas.width<600?10:12;this.ctx.font=`${e}px Arial`,this.ctx.textAlign="left",this.ctx.textBaseline="middle";const o=e+4,a=Math.max(3,Math.min(8,Math.floor(i.height/o))),c=Math.min(5,a),r=(h-s)/c,l=[];for(let t=0;t<=c;t++){const e=s+t*r,o=n(e,s,h,i.height,i.y);l.push({price:e,y:o})}const u=l.filter(({y:t})=>{const s=1.5*e;return t>=i.y+s&&t<=i.y+i.height-s});let f=u;if(u.length<2&&l.length>=2){const t=l[0],s=l[l.length-1];f=[{...t,y:Math.max(i.y+e,t.y)},{...s,y:Math.min(i.y+i.height-e,s.y)}]}f.forEach(({price:s,y:h})=>{let e;this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.setLineDash([2,2]),this.ctx.moveTo(i.x,h),this.ctx.lineTo(i.x+i.width,h),this.ctx.stroke(),this.ctx.setLineDash([]),e="volume"===t.type?s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(1)+"K":Math.round(s).toLocaleString():s>=1e3?s.toFixed(0):s>=100?s.toFixed(1):s>=10?s.toFixed(2):s.toFixed(3);const n=i.x+i.width+4;this.ctx.fillText(e,n,Math.round(h))}),this.ctx.textBaseline="alphabetic",this.ctx.beginPath(),this.ctx.strokeStyle=this.currentTheme.gridColor,this.ctx.lineWidth=1,this.ctx.moveTo(i.x+i.width,i.y),this.ctx.lineTo(i.x+i.width,i.y+i.height),this.ctx.stroke()}displayInfoOverlay(){const t=this.dataViewport.getVisibleData();if(0===t.length)return;const i=this.plotLayoutManager.getPlotLayout("main");if(!i)return;const s=i.width/this.dataViewport.visibleCount,h=this.crosshairX-i.x,e=Math.max(0,Math.floor(h/s)),n=this.dataViewport.startIndex+e;this.options.plots.forEach(i=>{const s=this.plotLayoutManager.getPlotLayout(i.id);if(!s||i.overlay)return;const h=i.data&&i.data.length>0?i.data:t;if(n>=0&&n<h.length){const l=h[n];if(this.ctx.fillStyle=this.currentTheme.overlayTextColor,this.ctx.font="12px Arial",this.crosshairY>=s.y&&this.crosshairY<=s.y+s.height){const{minPrice:h,maxPrice:n}=this.calculatePriceRange(i,t,this.dataViewport),l=(e=this.crosshairY,o=s.y,c=h,r=n,0===(a=s.height)?(r+c)/2:c+(1-(e-o)/a)*(r-c));let u;u="volume"===i.type?l>=1e6?(l/1e6).toFixed(2)+"M":l>=1e3?(l/1e3).toFixed(2)+"K":Math.round(l).toString():l>=1e3?l.toFixed(0):l>=100?l.toFixed(1):l>=10?l.toFixed(2):l.toFixed(3),this.ctx.textAlign="left",this.ctx.textBaseline="middle";const f=this.plotLayoutManager.getPlotTotalWidth()+5;this.ctx.fillText(u,f,Math.round(this.crosshairY))}if("main"===i.id&&void 0!==l.time){const t=new Date(1e3*l.time).toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"});this.ctx.textAlign="center",this.ctx.textBaseline="middle";const i=this.plotLayoutManager.getPlotTotalHeight()+15;this.ctx.fillText(t,this.crosshairX,i)}const u=this.options.plots.filter(t=>t.targetId===i.id||t.id===i.id),f=[];u.forEach(i=>{const s=i.data&&i.data.length>0?i.data:t;if(n>=0&&n<s.length){const t=s[n],h=Object.entries(t).map(([t,s])=>{if("time"===t||"date"===t||"keyLabel"===t)return null;const h="number"==typeof s?s.toFixed(2):s;return`${i.keyLabel?.trim().length>0?i.keyLabel:t.charAt(0).toUpperCase()+t.slice(1)}: ${h}`}).filter(Boolean).join(" | ");h&&f.push(h)}});const M=15,d=10,m=s.x+s.width-d;if(this.ctx.textAlign="right",!u.some(t=>"main"===t.id||"main"===t.targetId)){const t=f.join(" | ");f.length=0,f.push(t)}f.forEach((t,i)=>{const h=s.y+(i+1)*M;this.ctx.fillText(t,m,h)}),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}var e,o,a,c,r})}renderOverlayPanels(){this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.font="10px Arial",this.ctx.fillText("Overlay panels reserved for indicators",10,this.canvas.height-10),this.ctx.restore()}ensureContainerSize(t){t.clientHeight<1&&(t.style.height=.9*window.innerHeight+"px"),t.clientWidth<1&&(t.style.width=.9*window.innerWidth+"px")}}return o});//# sourceMappingURL=stock-chart.umd.min.js.map

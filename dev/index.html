<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>AI Stock View Chart Demo (Standalone)</title>
  <style>
    body {
      background: #f4f4f4;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    #chart-container {
      width: 100%;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <h1>AI Stock View Chart Test</h1>
  <div style="margin-bottom: 10px; display: flex; gap: 20px; align-items: center;">
    <div>
      <label for="theme-select">Theme:</label>
      <select id="theme-select">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    <div>
      <label for="date-picker">Center on Date:</label>
      <input type="date" id="date-picker" style="padding: 4px;">
      <button id="center-date-btn" style="margin-left: 8px; padding: 4px 8px;">Center</button>
    </div>
  </div>
  <div id="custom-theme-controls" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px;">
    <h3 style="margin-top: 0;">Custom Theme Colors</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
      <div>
        <label for="background">Background:</label>
        <input type="color" id="background" value="#2C3E50">
      </div>
      <div>
        <label for="chartAreaBackground">Chart Area:</label>
        <input type="color" id="chartAreaBackground" value="#34495E">
      </div>
      <div>
        <label for="textColor">Text:</label>
        <input type="color" id="textColor" value="#ECF0F1">
      </div>
      <div>
        <label for="gridColor">Grid:</label>
        <input type="color" id="gridColor" value="#7F8C8D">
      </div>
      <div>
        <label for="lineColor">Line:</label>
        <input type="color" id="lineColor" value="#3498DB">
      </div>
      <div>
        <label for="positiveColor">Positive:</label>
        <input type="color" id="positiveColor" value="#2ECC71">
      </div>
      <div>
        <label for="negativeColor">Negative:</label>
        <input type="color" id="negativeColor" value="#E74C3C">
      </div>
      <div>
        <label for="volumeColor">Volume:</label>
        <input type="color" id="volumeColor" value="#9B59B6">
      </div>
      <div>
        <label for="crosshairColor">Crosshair:</label>
        <input type="color" id="crosshairColor" value="#ECF0F1">
      </div>
      <div>
        <label for="overlayTextColor">Overlay Text:</label>
        <input type="color" id="overlayTextColor" value="#ECF0F1">
      </div>
      <div>
        <label for="candleUp">Candle Up:</label>
        <input type="color" id="candleUp" value="#2ECC71">
      </div>
      <div>
        <label for="candleDown">Candle Down:</label>
        <input type="color" id="candleDown" value="#E74C3C">
      </div>
      <div>
        <label for="candleBorderColor">Candle Border:</label>
        <input type="color" id="candleBorderColor" value="#333333">
      </div>
    </div>
  </div>
  <!-- Add this button div before the chart-container -->
  <div style="margin-bottom: 10px;">
    <button id="regenerate-data" style="padding: 8px 16px; cursor: pointer;">Regenerate Data</button>
  </div>
  <div id="chart-container"></div> 

  <script type="module">
    import StockChart from '../src/stock-chart.js';
    // import { extractSignals } from '../src/utils/helpers.js';
    import { calculateSMA, calculateMACD, calculateRSI, generateCandlestickData } from '../src/indicators/demo.js';
    import { mapStockBasesToStockData } from '../src/models/mappers/asv-mapper.js';
    let testOrDemo = true;
    // Function to load and process test data
    async function loadTestData() {
      try {
        testOrDemo = !testOrDemo;
        const response = await fetch(testOrDemo ? '../inte/test.json' : '../inte/demo.json');
        const testDataRaw = await response.json();
        
        // Convert date strings to Date objects
        testDataRaw.values.stockbaseClients = testDataRaw.values.stockbaseClients.map(stock => ({
          ...stock,
          date: new Date(stock.date) // Use current date as fallback
        }));

        return testDataRaw;
      } catch (error) {
        console.error('Error loading test data:', error);
        return null;
      }
    }

    // Initialize chart with test data
    let candlestickData = [];
    let chartInstance;

    loadTestData().then(testData => {
      if (testData) {
        // Map the data using our mapper
        candlestickData = mapStockBasesToStockData(testData.values);

        const fiboSequencesArray = []
        if (testData.values && testData.values.retraceSequenceDic) {
          // Extract retrace sequences
          fiboSequencesArray.push(...Object.values(testData.values.retraceSequenceDic).flat().map(r => r.fiboSequence));
        }

        // Extract signals for signal plot
        const signalArr = candlestickData.map(c => ({
          time: c.time,
          value: c.signals,
          keyLabel: c.signals?.[0]?.type
        }));

        const fiboZoneLines = candlestickData.map(c => c.fiboZoneLines);
        const orders = candlestickData.map(c => c.order);
        const referenceLines = candlestickData.map(c => ({
          time: c.time,
          value: c.referenceLines,
          keyLabel: c.referenceLines?.[0]?.type
        }));
        const safeMargins = candlestickData.map(c => ({
          time: c.time,
          value: c.safeMargins,
          keyLabel: c.safeMargins?.[0]?.type
        }));
        
        // Calculate indicators
        const sma20Data = calculateSMA(candlestickData, 20);
        const sma50Data = calculateSMA(candlestickData, 50);
        const macdData = calculateMACD(candlestickData, 21, 34, 8);
        const rsiData = calculateRSI(candlestickData);

        // Transform MACD data into separate line plots
        const macdLine = macdData.map(d => ({ time: d.time, value: d.macd, keyLabel: 'Macd' }));
        const signalLine = macdData.map(d => ({ time: d.time, value: d.signal, keyLabel: 'Signal' }));
        const histogramLine = macdData.map(d => ({ time: d.time, value: d.histogram, keyLabel: 'Histogram' }));

        const volumeData = candlestickData.map(d => ({ time: d.time, volume: d.volume }));

    // Custom theme example
    const customTheme = {
      background: '#2C3E50',
      chartAreaBackground: '#34495E',
      textColor: '#ECF0F1',
      gridColor: '#7F8C8D',
      lineColor: '#3498DB',
      positiveColor: '#2ECC71',
      negativeColor: '#E74C3C',
      volumeColor: '#9B59B6',
      crosshairColor: 'rgba(236, 240, 241, 0.5)',
      overlayTextColor: '#ECF0F1',
      candleUp: '#2ECC71',
      candleDown: '#E74C3C',
      candleBorderColor: '#8395A7'
    };

    // Function to update custom theme from color inputs
    function updateCustomTheme() {
      const theme = {};
      // Get all color inputs
      document.querySelectorAll('#custom-theme-controls input[type="color"]').forEach(input => {
        let value = input.value;
        // Convert to rgba for crosshair color
        if (input.id === 'crosshairColor') {
          const r = parseInt(value.substr(1,2), 16);
          const g = parseInt(value.substr(3,2), 16);
          const b = parseInt(value.substr(5,2), 16);
          value = `rgba(${r}, ${g}, ${b}, 0.5)`;
        }
        theme[input.id] = value;
      });
      
      // Apply the theme
      if (chartInstance) {
        chartInstance.applyTheme(theme);
      }
    }

    // Setup theme change listener
    document.getElementById('theme-select').addEventListener('change', (e) => {
      const customControls = document.getElementById('custom-theme-controls');
      if (e.target.value === 'custom') {
        customControls.style.display = 'block';
        updateCustomTheme();
      } else {
        customControls.style.display = 'none';
        chartInstance.applyTheme(e.target.value);
      }
    });

    // Add change listeners to all color inputs
    document.querySelectorAll('#custom-theme-controls input[type="color"]').forEach(input => {
      input.addEventListener('input', updateCustomTheme);
    });

    // Add date picker functionality
    document.getElementById('center-date-btn').addEventListener('click', () => {

      const dateInput = document.getElementById('date-picker');
      if (dateInput.value) {
        // Convert the datetime-local value to Unix timestamp (in seconds)
        // const timestamp = Math.floor(new Date(dateInput.value).getTime() / 1000);
        const timestamp = new Date(dateInput.value).getTime();
        
        // Center the chart on the selected date with a red vertical line
        chartInstance.centerOnDate(timestamp, {
          lineColor: '#ff0000',
          lineWidth: 1
        });
      }
    });

    // Add regenerate data functionality
    document.getElementById('regenerate-data').addEventListener('click', async () => {
      // Load new test data
      const newTestData = await loadTestData();
      
      if (newTestData && chartInstance) {
        // Map the new data
        const newCandlestickData = mapStockBasesToStockData(newTestData.values);

        // Calculate new indicators
        const newSma20Data = calculateSMA(newCandlestickData, 20);
        const newSma50Data = calculateSMA(newCandlestickData, 50);
        const newMacdData = calculateMACD(newCandlestickData, 21, 34, 8);
        const newRsiData = calculateRSI(newCandlestickData);

        // Transform new MACD data
        const newMacdLine = newMacdData.map(d => ({ time: d.time, value: d.macd, keyLabel: 'Macd' }));
        const newSignalLine = newMacdData.map(d => ({ time: d.time, value: d.signal, keyLabel: 'Signal' }));
        const newHistogramLine = newMacdData.map(d => ({ time: d.time, value: d.histogram, keyLabel: 'Histogram' }));

        // Extract new signals
        const newSignalArr = newCandlestickData.map(c => ({
          time: c.time,
          value: c.signals,
          keyLabel: c.signals?.[0]?.type
        }));
        
        const orders = newCandlestickData.map(c => c.order);
        const fiboZoneLinesNew = newCandlestickData.map(c => c.fiboZoneLines);
        const referenceLinesNew = newCandlestickData.map(c => ({
          time: c.time,
          value: c.referenceLines,
          keyLabel: c.referenceLines?.[0]?.type
        }));
        const safeMarginsNew = newCandlestickData.map(c => ({
          time: c.time,
          value: c.safeMargins,
          keyLabel: c.safeMargins?.[0]?.type
        }));
        // Update all plots at once with the new array-based API
        chartInstance.updateStockData([
          { 
            id: 'main', 
            type: 'candlestick',
            heightRatio: 0.6, 
            data: newCandlestickData
          },
          { 
            id: 'sma20', 
            type: 'line', 
            data: newSma20Data,
            overlay: true,
            targetId: 'main',
            keyLabel: 'SMA 20',
            style: {
              lineColor: 'rgba(255, 140, 0, 0.8)',
              lineWidth: 1.5
            }
          },
          { 
            id: 'sma50', 
            type: 'line', 
            data: newSma50Data,
            overlay: true,
            targetId: 'main',
            keyLabel: 'SMA 50',
            style: {
              lineColor: 'rgba(70, 130, 180, 0.8)',
              lineWidth: 5
            }
          },
          {
            id: 'signal',
            type: 'signal',
            overlay: true,
            targetId: 'main',
            keyLabel: 'Signals',
            data: newSignalArr
          },
          {
            id: 'referenceLines',
            type: 'signal',
            overlay: true,
            targetId: 'main',
            keyLabel: 'Reference Lines',
            data: referenceLinesNew
          },
          {
            id: 'fiboLines',
            type: 'arrowLine',
            data: fiboZoneLinesNew,
            targetId: 'main',
            overlay: true,
            keyLabel: 'Fibonacci Lines'
          },
          {
            id: 'orders',
            type: 'order',
            overlay: true,
            targetId: 'main',
            keyLabel: 'Orders',
            data: orders
          },
          {
            id: 'macd',
            type: 'line',
            heightRatio: 0.15,
            data: newMacdLine,
            keyLabel: 'MACD',
            style: {
              lineColor: 'rgba(0, 150, 136, 0.8)',
              lineWidth: 3
            }
          },
          {
            id: 'signalMacd',
            type: 'line',
            data: newSignalLine,
            overlay: true,
            targetId: 'macd',
            keyLabel: 'Signal',
            style: {
              lineColor: 'rgba(233, 30, 99, 0.8)',
              lineWidth: 1.5
            }
          },
          {
            id: 'histogram',
            type: 'histogram',
            data: newHistogramLine,
            overlay: true,
            targetId: 'macd',
            keyLabel: 'Histogram',
            style: {
              positiveColor: 'rgba(0, 150, 136, 0.5)',
              negativeColor: 'rgba(233, 30, 99, 0.5)'
            }
          },
          // Commented out RSI as it was commented in the original code
          {
            id: 'rsi',
            type: 'line',
            heightRatio: 0.15,
            data: newRsiData,
            keyLabel: 'RSI',
            style: {
              lineColor: 'rgba(0, 150, 136, 1)',
              lineWidth: 1.5
            }
          }
        ]);

        // Update chart name
        chartInstance.updateChartName({
          name: newTestData.code,
          code: newTestData.code.toLowerCase(),
          metaString: 'NASDAQ, 1D'
        });
      }
    });

    // Initialize the chart with the loaded data
    chartInstance = StockChart.init('chart-container', {
          theme: 'dark',
          chartName: {
            name: testData.code,
            code: testData.code.toLowerCase(),
            metaString: 'NASDAQ, 1D'
          },
          initialVisibleCandles: 100,
          showDrawingToolbar: true,
          plots: [
            { 
              id: 'main', 
              type: 'candlestick',
              heightRatio: 0.6, 
              data: candlestickData,
              targetId: 'main',
            },
            // { 
            //   id: 'sma20', 
            //   type: 'line', 
            //   data: sma20Data,
            //   overlay: true,
            //   targetId: 'main',
            //   keyLabel: 'SMA 20',
            //   style: {
            //     lineColor: 'rgba(255, 140, 0, 0.8)',  // Orange
            //     lineWidth: 1.5
            //   }
            // },
            // { 
            //   id: 'sma50', 
            //   type: 'line', 
            //   data: sma50Data,
            //   overlay: true,
            //   targetId: 'main',
            //   keyLabel: 'SMA 50',
            //   style: {
            //     lineColor: 'rgba(70, 130, 180, 0.8)',  // Steel Blue
            //     lineWidth: 5
            //   }
            // },
            {
              id: 'signal',
              type: 'signal',
              overlay: true,
              targetId: 'main',
              keyLabel: 'Signals',
              data: signalArr
            },
            {
              id: 'referenceLines',
              type: 'signal',
              overlay: true,
              targetId: 'main',
              keyLabel: 'Reference Lines',
              data: referenceLines
            },
            {
              id: 'fiboLines',
              type: 'arrowLine',
              data: fiboZoneLines,
              targetId: 'main',
              overlay: true,
              keyLabel: 'Fibonacci Lines',
            },
            {
              id: 'orders',
              type: 'order',
              overlay: true,
              targetId: 'main',
              keyLabel: 'Orders',
              data: orders
            },
            // {
            //   id: 'macd',
            //   type: 'line',
            //   heightRatio: 0.15,
            //   data: macdLine,
            //   keyLabel: 'MACD',
            //   style: {
            //     lineColor: 'rgba(0, 150, 136, 0.8)', // Teal
            //     lineWidth: 3
            //   }
            // },
            // {
            //   id: 'signalMacd',
            //   type: 'line',
            //   data: signalLine,
            //   overlay: true,
            //   targetId: 'macd',
            //   keyLabel: 'Signal',
            //   style: {
            //     lineColor: 'rgba(233, 30, 99, 0.8)', // Pink
            //     lineWidth: 1.5
            //   }
            // },
            // {
            //   id: 'histogram',
            //   type: 'histogram',
            //   data: histogramLine,
            //   overlay: true,
            //   targetId: 'macd',
            //   keyLabel: 'Histogram',
            //   style: {
            //     positiveColor: 'rgba(0, 150, 136, 0.5)',
            //     negativeColor: 'rgba(233, 30, 99, 0.5)'
            //   }
            // },
            // {
            //   id: 'rsi',
            //   type: 'line',
            //   heightRatio: 0.15,
            //   data: rsiData,
            //   keyLabel: 'RSI',
            //   style: {
            //     lineColor: 'rgba(0, 150, 136, 1)', // Teal
            //     lineWidth: 1.5
            //   }
            // }
          ]
        });
      }
    });

  </script>
</body>

</html>